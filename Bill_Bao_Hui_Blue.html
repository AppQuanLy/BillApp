<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph·∫ßn M·ªÅm T√≠nh H·ª•i</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @page { size: A3 landscape; margin: 1.5cm; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .info-panel { max-width: 900px; margin: 0 auto 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; }
        .info-panel h1 { width: 100%; margin: 0 0 15px 0; }
        .bill-page { background-color: white; max-width: 1200px; min-width: 1200px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; font-family: Arial, sans-serif; font-size: 16pt; }
        .bill-controls { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 10px; z-index: 10; }
        .bill-controls button, .info-panel button { padding: 5px 10px; font-size: 12px; cursor: pointer; color: white; border: none; border-radius: 4px; transition: background-color 0.2s; }
        
        .bill-header { position: relative; min-height: 200px; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
        .header-left { position: absolute; left: 0; top: 20px; font-weight: bold; font-size: 14pt; line-height: 1.5; }
        .header-left p { margin: 0; }
        .header-title-date { position: absolute; left: 50%; top: 50px; transform: translateX(-50%); text-align: center; width: 60%; }
        .qr-code { width: 200px; height: 200px; position: absolute; right: 0; top: 0; }
        .info-panel button { padding: 10px 20px; font-size: 14px; font-weight: bold; }
        .download-btn { background-color: #0275d8; }
        .copy-btn { background-color: #5bc0de; }
        .share-btn { background-color: #5cb85c; }
        .download-btn:hover { background-color: #025aa5; }
        .copy-btn:hover { background-color: #31b0d5; }
        .share-btn:hover { background-color: #449d44; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #000; }
        th, td { border: 1px solid #666; padding: 4px 6px; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: bold; text-transform: uppercase; }
        .text-center { text-align: center; } .text-right { text-align: right; } .no-border, .no-border td { border: none; }
        .font-bold { font-weight: bold; } .font-large { font-size: 14pt; } .font-xlarge { font-size: 16pt; }
        .text-red { color: #d90000; } .text-green { color: #00b050; }
        .summary-table th { background-color: #d9e1f2; }
        .summary-table .highlight { background-color: #357ee7; color: #ffffff; } .details-table th { background-color: #d9e1f2; }
        .details-table { margin-bottom: 10px; font-size: 14pt;font-weight: bold;} .footer-banner { padding: 5px; text-align: left; font-size: 14pt; color: white; margin-bottom: 5px;}
        .footer-container { display: flex; align-items: flex-start; gap: 10px;}
        .footer-left { width: 40%; font-size: 18pt; font-weight: bold; text-align: center; }
        .footer-right { width: 60%; }
        .totals-table td { padding: 5px 7px; font-size: 16pt; }

        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .info-panel, .bill-controls { display: none !important; }
            .bill-page { page-break-after: always; margin: 0; padding: 0; box-shadow: none; border: none; width: 100%; max-width: none; min-width: 0; }
            body { background-color: #fff; padding: 0; margin: 0; }
        }
    </style>
</head>
<body>

    <div id="info-panel" class="info-panel">
        <h1 id="status-message">ƒêang t·∫£i v√† t·∫°o bill...</h1>
        <button id="download-zip-btn" style="display: none; background-color: #337ab7;">üíæ T·∫£i t·∫•t c·∫£ Bill (ZIP)</button>
    </div>
    
    <div id="bills-container"></div>

    <template id="bill-template">
         <div class="bill-page">
            <div class="bill-controls">
                <button class="download-btn">T·∫£i Bill</button>
                <button class="copy-btn">Copy Bill</button>
                <button class="share-btn">G·ª≠i Bill</button>
            </div>
            <div class="bill-header">
                <div class="header-left">
                    <p>Ch·ªß h·ª•i: <span data-field="chu_hui"></span></p>
                    <p>SƒêT: <span data-field="sdt"></span></p>
                    <p data-field="bank_info"></p>
                </div>
                <div class="header-title-date">
                    <h2 style="margin: 5px 0 0 0; font-size: 25pt;">BILL B√ÅO H·ª§I</h2>
                    <p style="margin: 0;">Ng√†y: <span data-field="ngay_tao_bill"></span></p>
                </div>
                <img data-field="qr_bill_url" class="qr-code" alt="QR">
            </div>
            <table class="summary-table text-center">
                <thead><tr><th class="highlight" data-field="summary_title_hui_vien"></th><th class="highlight" data-field="summary_title_hui_chet"></th><th class="highlight" data-field="summary_title_hui_song"></th><th class="highlight">√Çm/D∆∞∆°ng *</th><th class="highlight">L·ª£i Nhu·∫≠n</th></tr></thead>
                <tbody><tr><td class="font-bold" data-field="hoi_vien"></td><td data-field="tong_hui_chet"></td><td data-field="tong_hui_song"></td><td class="font-bold" data-field="am_duong"></td><td class="font-bold" data-field="loi_nhuan"></td></tr></tbody>
            </table>
            <table class="details-table text-center">
                <thead><tr><th style="width: 4%;">STT</th><th>D√¢y H·ª•i</th><th>K·ª≥</th><th>Khui</th><th>S·ªêNG</th><th>CH·∫æT</th><th>Ti·ªÅn H·ªët</th><th>Ti·ªÅn ƒê√≥ng</th><th>ThƒÉm</th><th>Th·∫£o</th><th>ƒê√∫p</th></tr></thead>
                <tbody data-field="details_tbody"></tbody>
            </table>
            <div class="footer-container">
                <div class="footer-left"><div class="footer-banner" data-field="footer_banner"></div><span data-field="footer_hoi_vien"></span></div>
                <div class="footer-right">
                    <table class="totals-table no-border">
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn ƒê√≥ng:</td><td class="text-right font-large font-bold" data-field="bill_tong_dong"></td><td style="width: 25px;" class="text-center">(1)</td><td class="text-blue font-bold" data-field="tong_tham"></td></tr>
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn H·ªët:</td><td class="text-right font-large font-bold" data-field="bill_tong_hot"></td><td class="text-center">(2)</td><td class="text-blue font-bold" data-field="tong_thao"></td></tr>
                        <tr><td class="font-bold" data-field="final_text_label"></td><td class="text-right font-xlarge font-bold text-red" data-field="final_amount"></td><td class="text-center font-bold"></td><td class="text-center font-bold" data-field="final_formula_text"></td></tr>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <script>
    let billData = {};
    let readyBlob = null; // Bi·∫øn ƒë·ªÉ l∆∞u file ·∫£nh ƒë√£ t·∫°o s·∫µn

    window.onload = function() {
        try {
            const encodedData = window.location.hash.substring(1);
            if (!encodedData) { throw new Error('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.'); }
            const jsonData = decodeURIComponent(encodedData);
            billData = JSON.parse(jsonData);
            
            // 1. T·∫°o n·ªôi dung bill
            generateBill(billData);
            
            // 2. K√≠ch ho·∫°t t·∫°o ·∫£nh ng·∫ßm ngay l·∫≠p t·ª©c
            initAutoCapture(); 

        } catch (error) {
            document.body.innerHTML = `<h2 style="color: red; text-align: center;">L·ªói!</h2><p style="text-align: center;">${error.message}</p>`;
            console.error("L·ªói:", error);
        }
    };

    function formatCurrency(num) {
        if (typeof num !== 'number' || num === null) return '';
        return num.toLocaleString('vi-VN');
    }

    function addPeriod(dateString, value, unit) {
        if (!dateString || typeof dateString !== 'string' || dateString.split('/').length !== 3) return "";
        const daysToAdd = Math.floor(parseFloat(value) || 0); 
        if (daysToAdd === 0 && !unit.toLowerCase().includes('th√°ng')) return dateString;

        const [day, month, year] = dateString.split('/');
        const date = new Date(+year, +month - 1, +day);
        if (isNaN(date.getTime())) return "";

        if ((unit || '').toLowerCase().includes('th√°ng')) {
            const originalDay = date.getDate();
            date.setDate(1);
            date.setMonth(date.getMonth() + daysToAdd);
            const lastDayOfNewMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            date.setDate(Math.min(originalDay, lastDayOfNewMonth));
        } else {
            date.setDate(date.getDate() + daysToAdd);
        }
        
        const newDay = String(date.getDate()).padStart(2, '0');
        const newMonth = String(date.getMonth() + 1).padStart(2, '0');
        const newYear = date.getFullYear();
        return `${newDay}/${newMonth}/${newYear}`;
    }

    function generateBill(data) {
        for (const key in data) {
            if (key !== 'danh_sach_chan') {
                const element = document.querySelector(`[data-field="${key}"]`);
                if (element) element.textContent = data[key];
            }
        }
        
        const tbody = document.getElementById('details-tbody');
        tbody.innerHTML = '';
        let tongTham = 0, tongTienHot = 0, tongTienDong = 0;

        if (data.danh_sach_chan && Array.isArray(data.danh_sach_chan)) {
            data.danh_sach_chan.forEach((chan, index) => {
                chan.ky_num = parseInt(chan.ky) || (index + 1);
            });
            data.danh_sach_chan.sort((a, b) => a.ky_num - b.ky_num);

            const ngayMo = data.ngay_mo;
            const kyHanValueFloat = parseFloat(data.ky_han_value) || 1; 
            const manKyDuKienEl = document.querySelector('[data-field="man_ky_du_kien"]');
            if (manKyDuKienEl) {
                const soKyInt = parseInt(data.so_ky) || 0;
                const periodsToAdd = (soKyInt - 1) * kyHanValueFloat;
                manKyDuKienEl.textContent = addPeriod(ngayMo, periodsToAdd, data.ky_han_unit);
            }

            data.danh_sach_chan.forEach((chan, index) => {
                const stt = index + 1;
                const kyHienThi = chan.ky || "";
                const row = document.createElement('tr');
                let ngayHienThi = chan.ngay;
                const statusText = chan.status; 
                let statusClass = 'dead';

                if (statusText === 'V' || statusText === 'S') {
                    statusClass = 'alive';
                    const kyForCalc = parseInt(kyHienThi); 
                    if (!isNaN(kyForCalc) && kyForCalc > 0) {
                        const periodsToAdd = (kyForCalc - 1) * kyHanValueFloat;
                        ngayHienThi = addPeriod(ngayMo, periodsToAdd, data.ky_han_unit);
                    } else {
                        ngayHienThi = ""; 
                    }
                }
                
                const ngayClass = (statusText !== 'V' && statusText !== 'S') ? 'text-red' : '';
                
                row.innerHTML = `
                    <td>${stt}</td>
                    <td style="text-align: left;">${chan.ten_hui_vien}</td>
                    <td class="status-cell ${statusClass}">${statusText}</td>
                    <td class="${ngayClass} font-bold">${ngayHienThi || ''}</td>
                    <td>${kyHienThi}</td> 
                    <td>${formatCurrency(chan.tham)}</td>
                    <td>${formatCurrency(chan.tien_dong)}</td>
                    <td class="text-red font-bold">${formatCurrency(chan.tien_hot)}</td>
                `;
                tbody.appendChild(row);
                tongTham += chan.tham || 0;
                tongTienHot += chan.tien_hot || 0;
                tongTienDong += chan.tien_dong || 0;
            });
        }
        
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
            <td colspan="5" style="text-align: center; font-size: 14pt;">T·ªîNG:</td>
            <td class="text-blue">${formatCurrency(tongTham)}</td>
            <td>${formatCurrency(tongTienDong)}</td> 
            <td class="text-red">${formatCurrency(tongTienHot)}</td>
        `;
        tbody.appendChild(totalRow);
        
        // G√°n s·ª± ki·ªán cho c√°c n√∫t T·∫£i v√† Copy (kh√¥ng c·∫ßn ƒë·ª£i ·∫£nh ng·∫ßm)
        const billElement = document.getElementById('bill-to-capture');
        document.querySelector('.download-btn').addEventListener('click', () => downloadBillAsImage(billElement));
        document.querySelector('.copy-btn').addEventListener('click', () => copyBillAsImage(billElement));
        // N√∫t G·ª≠i Bill s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω ri√™ng
        document.querySelector('.share-btn').addEventListener('click', shareReadyBlob);
    }

    // --- H√ÄM T·∫†O ·∫¢NH NG·∫¶M (QUAN TR·ªåNG) ---
    async function initAutoCapture() {
        const billElement = document.getElementById('bill-to-capture');
        const shareBtn = document.querySelector('.share-btn');
        
        // ƒê·ªïi tr·∫°ng th√°i n√∫t
        shareBtn.textContent = "‚è≥ ƒêang t·∫°o ·∫£nh...";
        shareBtn.disabled = true;
        shareBtn.style.opacity = "0.6";

        const controls = billElement.querySelector('.bill-controls');
        controls.style.display = 'none'; // ·∫®n n√∫t ƒë·ªÉ ch·ª•p

        try {
            // Ch·ªù 500ms ƒë·ªÉ tr√¨nh duy·ªát render xong h·∫øt font ch·ªØ, layout
            await new Promise(r => setTimeout(r, 500));

            // D√πng scale 1.5 ƒë·ªÉ c√¢n b·∫±ng gi·ªØa n√©t v√† nh·∫π RAM
            const canvas = await html2canvas(billElement, { 
                scale: 1.5, 
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            });
            
            // L∆∞u ·∫£nh v√†o bi·∫øn to√†n c·ª•c
            readyBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            
            // ƒê·ªïi l·∫°i n√∫t th√†nh S·∫µn s√†ng
            shareBtn.textContent = "G·ª≠i Bill";
            shareBtn.disabled = false;
            shareBtn.style.opacity = "1";
            
        } catch (error) {
            console.error("L·ªói t·∫°o ·∫£nh ng·∫ßm:", error);
            shareBtn.textContent = "L·ªói t·∫°o ·∫£nh";
            // N·∫øu scale 1.5 l·ªói (tr√†n RAM), th·ª≠ l·∫°i v·ªõi scale 1.0
            try {
                const canvasLow = await html2canvas(billElement, { scale: 1, useCORS: true, backgroundColor: '#ffffff' });
                readyBlob = await new Promise(resolve => canvasLow.toBlob(resolve, 'image/png'));
                shareBtn.textContent = "G·ª≠i Bill (SD)";
                shareBtn.disabled = false;
                shareBtn.style.opacity = "1";
            } catch (err2) {
                 shareBtn.textContent = "Kh√¥ng th·ªÉ t·∫°o ·∫£nh";
            }
        } finally {
            controls.style.display = 'flex'; // Hi·ªán l·∫°i n√∫t
        }
    }

    // --- H√ÄM G·ª¨I ·∫¢NH ƒê√É C√ì S·∫¥N ---
    async function shareReadyBlob() {
        if (!readyBlob) {
            alert("ƒêang x·ª≠ l√Ω h√¨nh ·∫£nh, vui l√≤ng ƒë·ª£i gi√¢y l√°t...");
            return;
        }

        const sdt = billData.sdt || '';
        const hoivien = billData.hoi_vien || 'Bill'; // S·ª≠a l·∫°i key cho ƒë√∫ng v·ªõi d·ªØ li·ªáu
        const filename = (sdt ? sdt : `Bill_${hoivien}`) + '.png';
        const file = new File([readyBlob], filename, { type: 'image/png' });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file]
                });
            } catch (err) {
                console.log("Ng∆∞·ªùi d√πng h·ªßy chia s·∫ª");
            }
        } else {
            alert('M√°y n√†y kh√¥ng h·ªó tr·ª£ g·ª≠i file tr·ª±c ti·∫øp. Vui l√≤ng d√πng n√∫t "T·∫£i Bill" ho·∫∑c "Copy Bill".');
        }
    }

    // --- C√ÅC H√ÄM C≈® (GI·ªÆ NGUY√äN HO·∫∂C R√öT G·ªåN ƒê·ªÇ T√ÅI S·ª¨ D·ª§NG) ---
    function captureBill(element, callback) {
        // H√†m n√†y gi·ªù ch·ªâ d√πng cho n√∫t Download/Copy (t·∫°o ·∫£nh m·ªõi ƒë·ªÉ ƒë·∫£m b·∫£o fresh)
        const controls = element.querySelector('.bill-controls');
        if (controls) controls.style.display = 'none';
        html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => {
            callback(canvas);
            controls.style.display = 'flex';
        }).catch(err => {
            alert('L·ªói khi t·∫°o ·∫£nh.');
            if (controls) controls.style.display = 'flex';
        });
    }

    function downloadBillAsImage(element) {
        // N·∫øu ƒë√£ c√≥ readyBlob, d√πng lu√¥n cho nhanh
        if (readyBlob) {
            const sdt = billData.sdt;
            const hoivien = billData.hoi_vien || 'Bill';
            const filename = (sdt ? sdt : `ThongTinDay_${billData.day_ten || 'bill'}`) + '.png';
            const link = document.createElement('a');
            link.download = filename;
            link.href = URL.createObjectURL(readyBlob);
            link.click();
            return;
        }
        // N·∫øu ch∆∞a c√≥ (l·ªói g√¨ ƒë√≥), th√¨ ch·∫°y c√°ch c≈©
        const filename = `ThongTinDay_${billData.day_ten || 'bill'}.png`;
        captureBill(element, canvas => {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }

    function copyBillAsImage(element) {
        // Copy th√¨ n√™n ch·ª•p m·ªõi ho·∫∑c d√πng blob
        if (readyBlob) {
             navigator.clipboard.write([new ClipboardItem({ 'image/png': readyBlob })])
                .then(() => alert('ƒê√£ sao ch√©p ·∫£nh v√†o b·ªô nh·ªõ t·∫°m!'))
                .catch(err => alert('L·ªói khi copy.'));
             return;
        }
        captureBill(element, canvas => {
            canvas.toBlob(blob => {
                navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                .then(() => alert('ƒê√£ sao ch√©p ·∫£nh v√†o b·ªô nh·ªõ t·∫°m!'))
                .catch(err => alert('L·ªói khi copy.'));
            });
        });
    }
</script>
</body>
</html>
