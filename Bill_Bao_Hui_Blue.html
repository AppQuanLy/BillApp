<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph·∫ßn M·ªÅm T√≠nh H·ª•i</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @page { size: A3 landscape; margin: 1.5cm; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .info-panel { max-width: 900px; margin: 0 auto 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; }
        .info-panel h1 { width: 100%; margin: 0 0 15px 0; }
        .bill-page { background-color: white; max-width: 1200px; min-width: 1200px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; font-family: Arial, sans-serif; font-size: 16pt; }
        .bill-controls { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 10px; z-index: 10; }
        .bill-controls button, .info-panel button { padding: 5px 10px; font-size: 12px; cursor: pointer; color: white; border: none; border-radius: 4px; transition: background-color 0.2s; }
        
        .bill-header { position: relative; min-height: 200px; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
        .header-left { position: absolute; left: 0; top: 20px; font-weight: bold; font-size: 14pt; line-height: 1.5; }
        .header-left p { margin: 0; }
        .header-title-date { position: absolute; left: 50%; top: 50px; transform: translateX(-50%); text-align: center; width: 60%; }
        .qr-code { width: 200px; height: 200px; position: absolute; right: 0; top: 0; }
        .info-panel button { padding: 10px 20px; font-size: 14px; font-weight: bold; }
        .download-btn { background-color: #0275d8; }
        .copy-btn { background-color: #5bc0de; }
        .share-btn { background-color: #5cb85c; }
        .download-btn:hover { background-color: #025aa5; }
        .copy-btn:hover { background-color: #31b0d5; }
        .share-btn:hover { background-color: #449d44; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #000; }
        th, td { border: 1px solid #666; padding: 4px 6px; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: bold; text-transform: uppercase; }
        .text-center { text-align: center; } .text-right { text-align: right; } .no-border, .no-border td { border: none; }
        .font-bold { font-weight: bold; } .font-large { font-size: 14pt; } .font-xlarge { font-size: 16pt; }
        .text-red { color: #d90000; } .text-green { color: #00b050; }
        .summary-table th { background-color: #d9e1f2; }
        .summary-table .highlight { background-color: #357ee7; color: #ffffff; } .details-table th { background-color: #d9e1f2; }
        .details-table { margin-bottom: 10px; font-size: 14pt;font-weight: bold;} .footer-banner { padding: 5px; text-align: left; font-size: 14pt; color: white; margin-bottom: 5px;}
        .footer-container { display: flex; align-items: flex-start; gap: 10px;}
        .footer-left { width: 40%; font-size: 18pt; font-weight: bold; text-align: center; }
        .footer-right { width: 60%; }
        .totals-table td { padding: 5px 7px; font-size: 16pt; }

        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .info-panel, .bill-controls { display: none !important; }
            .bill-page { page-break-after: always; margin: 0; padding: 0; box-shadow: none; border: none; width: 100%; max-width: none; min-width: 0; }
            body { background-color: #fff; padding: 0; margin: 0; }
        }
    </style>
</head>
<body>

    <div id="info-panel" class="info-panel">
        <h1 id="status-message">ƒêang t·∫£i v√† t·∫°o bill...</h1>
        <button id="download-zip-btn" style="display: none; background-color: #337ab7;">üíæ T·∫£i t·∫•t c·∫£ Bill (ZIP)</button>
    </div>
    
    <div id="bills-container"></div>

    <template id="bill-template">
         <div class="bill-page">
            <div class="bill-controls">
                <button class="download-btn">T·∫£i Bill</button>
                <button class="copy-btn">Copy Bill</button>
                <button class="share-btn">G·ª≠i Bill</button>
            </div>
            <div class="bill-header">
                <div class="header-left">
                    <p>Ch·ªß h·ª•i: <span data-field="chu_hui"></span></p>
                    <p>SƒêT: <span data-field="sdt"></span></p>
                    <p data-field="bank_info"></p>
                </div>
                <div class="header-title-date">
                    <h2 style="margin: 5px 0 0 0; font-size: 25pt;">BILL B√ÅO H·ª§I</h2>
                    <p style="margin: 0;">Ng√†y: <span data-field="ngay_tao_bill"></span></p>
                </div>
                <img data-field="qr_bill_url" class="qr-code" alt="QR">
            </div>
            <table class="summary-table text-center">
                <thead><tr><th class="highlight" data-field="summary_title_hui_vien"></th><th class="highlight" data-field="summary_title_hui_chet"></th><th class="highlight" data-field="summary_title_hui_song"></th><th class="highlight">√Çm/D∆∞∆°ng *</th><th class="highlight">L·ª£i Nhu·∫≠n</th></tr></thead>
                <tbody><tr><td class="font-bold" data-field="hoi_vien"></td><td data-field="tong_hui_chet"></td><td data-field="tong_hui_song"></td><td class="font-bold" data-field="am_duong"></td><td class="font-bold" data-field="loi_nhuan"></td></tr></tbody>
            </table>
            <table class="details-table text-center">
                <thead><tr><th style="width: 4%;">STT</th><th>D√¢y H·ª•i</th><th>K·ª≥</th><th>Khui</th><th>S·ªêNG</th><th>CH·∫æT</th><th>Ti·ªÅn H·ªët</th><th>Ti·ªÅn ƒê√≥ng</th><th>ThƒÉm</th><th>Th·∫£o</th><th>ƒê√∫p</th></tr></thead>
                <tbody data-field="details_tbody"></tbody>
            </table>
            <div class="footer-container">
                <div class="footer-left"><div class="footer-banner" data-field="footer_banner"></div><span data-field="footer_hoi_vien"></span></div>
                <div class="footer-right">
                    <table class="totals-table no-border">
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn ƒê√≥ng:</td><td class="text-right font-large font-bold" data-field="bill_tong_dong"></td><td style="width: 25px;" class="text-center">(1)</td><td class="text-blue font-bold" data-field="tong_tham"></td></tr>
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn H·ªët:</td><td class="text-right font-large font-bold" data-field="bill_tong_hot"></td><td class="text-center">(2)</td><td class="text-blue font-bold" data-field="tong_thao"></td></tr>
                        <tr><td class="font-bold" data-field="final_text_label"></td><td class="text-right font-xlarge font-bold text-red" data-field="final_amount"></td><td class="text-center font-bold"></td><td class="text-center font-bold" data-field="final_formula_text"></td></tr>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng Tin D√¢y H·ª•i</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            font-size: 14pt;
            color: #000;
        }
        .container {
            width: 28cm;
            padding: 1cm;
            margin: auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            position: relative;
            padding-bottom: 80px; 
        }
        .header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .title-section {
            text-align: center;
            margin-bottom: 20px;
        }
        .title-section h1 {
            font-family: 'Times New Roman', Times, serif;
            font-size: 26pt;
            color: #0070c0;
            margin: 0;
        }
        .title-section p {
            margin: 5px 0 0;
            font-size: 12pt;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr;
            gap: 10px 5px;
            margin-bottom: 20px;
        }
        .info-item {
            font-size: 12pt;
        }
        .info-item .label {
            font-weight: bold;
            display: inline-block;
            width: 90px;
        }
        .info-item .value {
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #888;
            padding: 6px 8px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #d9e2f3;
            font-weight: bold;
        }
        .status-cell.dead {
            background-color: #ff0000;
            color: white;
            font-weight: bold;
        }
        .status-cell.alive {
            background-color: #00b050;
            color: white;
            font-weight: bold;
        }
        .total-row td {
            font-weight: bold;
            background-color: #f2f2f2;
        }
        .text-blue { color: #0070c0; }
        .text-red { color: #ff0000; }
        .font-bold { font-weight: bold; }
        
        .bill-controls {
            position: absolute;
            bottom: 1cm;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 10;
        }
        .bill-controls button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .bill-controls button:hover {
            transform: translateY(-2px);
        }
        .download-btn { background-color: #0275d8; } .download-btn:hover { background-color: #025aa5; }
        .copy-btn { background-color: #5bc0de; } .copy-btn:hover { background-color: #31b0d5; }
        .share-btn { background-color: #5cb85c; } .share-btn:hover { background-color: #449d44; }

        @media print {
            .bill-controls { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container" id="bill-to-capture">
        <div class="header">
            <div class="left">
                Ch·ªß H·ª•i: <span data-field="chu_hui_ten" class="font-bold"></span><br>
                SƒêT: <span data-field="chu_hui_sdt" class="font-bold"></span>
            </div>
        </div>
        <div class="title-section">
            <h1>TH√îNG TIN D√ÇY H·ª§I</h1>
            <p>Ng√†y: <span data-field="ngay_in_bill"></span></p>
        </div>
        <div class="info-grid">
            <div class="info-item"><span class="label">D√¢y:</span><span data-field="day_ten" class="value"></span></div>
            <div class="info-item"><span class="label">K·ª≥ H·∫°n:</span><span data-field="ky_han_text" class="value text-blue"></span></div>
            <div class="info-item"><span class="label">Thu Th·∫£o</span></div>
            <div class="info-item"><span class="label">S·ªë K·ª≥:</span><span data-field="so_ky" class="value"></span></div>
            <div class="info-item"><span class="label">M√£n K·ª≥:</span><span data-field="man_ky_du_kien" class="value text-blue"></span></div>
            <div class="info-item"><span data-field="thu_khi_hot" class="value text-red"></span></div>
            <div class="info-item"><span class="label">Ng√†y M·ªü:</span><span data-field="ngay_mo" class="value text-blue"></span></div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>T√äN H·ª§I VI√äN</th>
                    <th>S / C</th>
                    <th>NG√ÄY</th>
                    <th>K·ª≤</th>
                    <th>THƒÇM</th>
                    <th>TI·ªÄN ƒê√ìNG</th>
                    <th>TI·ªÄN H·ªêT</th>
                </tr>
            </thead>
            <tbody id="details-tbody">
            </tbody>
        </table>
        
        <div class="bill-controls">
            <button class="download-btn">T·∫£i Bill</button>
            <button class="copy-btn">Copy Bill</button>
            <button class="share-btn">G·ª≠i Bill</button>
        </div>
    </div>

<script>
    let billData = {};

    window.onload = function() {
        try {
            const encodedData = window.location.hash.substring(1);
            if (!encodedData) { throw new Error('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.'); }
            const jsonData = decodeURIComponent(encodedData);
            billData = JSON.parse(jsonData);
            generateBill(billData);
        } catch (error) {
            document.body.innerHTML = `<h2 style="color: red; text-align: center;">L·ªói!</h2><p style="text-align: center;">${error.message}</p>`;
            console.error("L·ªói:", error);
        }
    };

    function formatCurrency(num) {
        if (typeof num !== 'number' || num === null) return '';
        return num.toLocaleString('vi-VN');
    }

    function addPeriod(dateString, value, unit) {
        if (!dateString || typeof dateString !== 'string' || dateString.split('/').length !== 3) return "";
        
        const daysToAdd = Math.floor(parseFloat(value) || 0); 
        
        if (daysToAdd === 0 && !unit.toLowerCase().includes('th√°ng')) {
             return dateString;
        }

        const [day, month, year] = dateString.split('/');
        const date = new Date(+year, +month - 1, +day);
        if (isNaN(date.getTime())) return "";

        if ((unit || '').toLowerCase().includes('th√°ng')) {
            const originalDay = date.getDate();
            date.setDate(1);
            date.setMonth(date.getMonth() + daysToAdd);
            const lastDayOfNewMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            date.setDate(Math.min(originalDay, lastDayOfNewMonth));
        } else {
            date.setDate(date.getDate() + daysToAdd);
        }
        
        const newDay = String(date.getDate()).padStart(2, '0');
        const newMonth = String(date.getMonth() + 1).padStart(2, '0');
        const newYear = date.getFullYear();
        return `${newDay}/${newMonth}/${newYear}`;
    }

    function generateBill(data) {
        for (const key in data) {
            // Lo·∫°i b·ªè ki·ªÉm tra 'danh_sach_chan' ƒë·ªÉ tr√°nh l·ªói v·ªõi c√°c tr∆∞·ªùng kh√°c
            if (key !== 'danh_sach_chan') {
                const element = document.querySelector(`[data-field="${key}"]`);
                // CH·ªà G√ÅN N·∫æU T√åM TH·∫§Y ELEMENT (Tr√°nh l·ªói null)
                if (element) {
                    element.textContent = data[key];
                }
            }
        }
        
        const tbody = document.getElementById('details-tbody');
        if (tbody) {
            tbody.innerHTML = '';
            let tongTham = 0, tongTienHot = 0, tongTienDong = 0;

            if (data.danh_sach_chan && Array.isArray(data.danh_sach_chan)) {
                // S·∫Øp x·∫øp theo STT (K·ª≤)
                data.danh_sach_chan.forEach((chan, index) => {
                    chan.ky_num = parseInt(chan.ky) || (index + 1);
                });
                data.danh_sach_chan.sort((a, b) => a.ky_num - b.ky_num);

                const ngayMo = data.ngay_mo;
                const kyHanValueFloat = parseFloat(data.ky_han_value) || 1; 

                // T√≠nh ng√†y m√£n k·ª≥
                const manKyDuKienEl = document.querySelector('[data-field="man_ky_du_kien"]');
                if (manKyDuKienEl) {
                    const soKyInt = parseInt(data.so_ky) || 0;
                    const periodsToAdd = (soKyInt - 1) * kyHanValueFloat;
                    manKyDuKienEl.textContent = addPeriod(ngayMo, periodsToAdd, data.ky_han_unit);
                }

                data.danh_sach_chan.forEach((chan, index) => {
                    const stt = index + 1;
                    const kyHienThi = chan.ky || ""; 
                    
                    const row = document.createElement('tr');
                    let ngayHienThi = chan.ngay; 

                    const statusText = chan.status; 
                    let statusClass = 'dead';

                    if (statusText === 'V' || statusText === 'S') {
                        statusClass = 'alive';
                        
                        // Logic t√≠nh ng√†y: D√πng STT ƒë·ªÉ t√≠nh to√°n
                        const periodsToAdd = (stt - 1) * kyHanValueFloat;
                        ngayHienThi = addPeriod(ngayMo, periodsToAdd, data.ky_han_unit);
                    }
                    
                    const ngayClass = (statusText !== 'V' && statusText !== 'S') ? 'text-red' : '';
                    
                    row.innerHTML = `
                        <td>${stt}</td>
                        <td style="text-align: left;">${chan.ten_hui_vien}</td>
                        <td class="status-cell ${statusClass}">${statusText}</td>
                        <td class="${ngayClass} font-bold">${ngayHienThi || ''}</td>
                        <td>${kyHienThi}</td> 
                        <td>${formatCurrency(chan.tham)}</td>
                        <td>${formatCurrency(chan.tien_dong)}</td>
                        <td class="text-red font-bold">${formatCurrency(chan.tien_hot)}</td>
                    `;
                    tbody.appendChild(row);
                    tongTham += chan.tham || 0;
                    tongTienHot += chan.tien_hot || 0;
                    tongTienDong += chan.tien_dong || 0;
                });
            }
            
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="5" style="text-align: center; font-size: 14pt;">T·ªîNG:</td>
                <td class="text-blue">${formatCurrency(tongTham)}</td>
                <td>${formatCurrency(tongTienDong)}</td> 
                <td class="text-red">${formatCurrency(tongTienHot)}</td>
            `;
            tbody.appendChild(totalRow);
        }
        
        const billElement = document.getElementById('bill-to-capture');
        const btnDownload = document.querySelector('.download-btn');
        if (btnDownload) btnDownload.addEventListener('click', () => downloadBillAsImage(billElement));
        
        const btnCopy = document.querySelector('.copy-btn');
        if (btnCopy) btnCopy.addEventListener('click', () => copyBillAsImage(billElement));
        
        const btnShare = document.querySelector('.share-btn');
        if (btnShare) btnShare.addEventListener('click', () => shareBillAsImage(billElement));
    }

    async function captureBill(element, callback) {
        const controls = element.querySelector('.bill-controls');
        if (controls) controls.style.display = 'none';
        try {
            const canvas = await html2canvas(element, { scale: 2, useCORS: true });
            await callback(canvas);
        } catch (error) {
            console.error('L·ªói khi t·∫°o ·∫£nh:', error);
            alert('ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o ·∫£nh.');
        } finally {
            if (controls) controls.style.display = 'flex';
        }
    }

    function downloadBillAsImage(element) {
        const filename = `ThongTinDay_${billData.day_ten || 'bill'}.png`;
        captureBill(element, canvas => {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }

    function copyBillAsImage(element) {
        captureBill(element, canvas => {
            canvas.toBlob(blob => {
                navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                .then(() => alert('ƒê√£ sao ch√©p ·∫£nh v√†o b·ªô nh·ªõ t·∫°m!'))
                .catch(err => alert('L·ªói khi copy.'));
            });
        });
    }

    async function shareBillAsImage(element) {
        const filename = `ThongTinDay_${billData.day_ten || 'bill'}.png`;
        const textshare = `Th√¥ng tin d√¢y h·ª•i ${billData.day_ten}.`;
        if (!navigator.share) {
            alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ch·ª©c nƒÉng n√†y. Vui l√≤ng d√πng n√∫t "Copy Bill".');
            return;
        }
        captureBill(element, async canvas => {
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            const file = new File([blob], filename, { type: 'image/png' });
            try {
                await navigator.share({ title: `Th√¥ng Tin D√¢y H·ª•i`, text: textshare, files: [file] });
            } catch (error) { console.log('Ng∆∞·ªùi d√πng ƒë√£ h·ªßy chia s·∫ª.'); }
        });
    }
</script>
</body>
</html>
</body>
</html>
