<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph·∫ßn M·ªÅm T√≠nh H·ª•i</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @page { size: A3 landscape; margin: 1.5cm; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .info-panel { max-width: 900px; margin: 0 auto 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; }
        .info-panel h1 { width: 100%; margin: 0 0 15px 0; }
        .bill-page { background-color: white; max-width: 1200px; min-width: 1200px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; font-family: Arial, sans-serif; font-size: 16pt; }
        .bill-controls { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 10px; z-index: 10; }
        .bill-controls button, .info-panel button { padding: 5px 10px; font-size: 12px; cursor: pointer; color: white; border: none; border-radius: 4px; transition: background-color 0.2s; }
        
        /* --- CSS CHO HEADER --- */
        .bill-header {
            position: relative;
            min-height: 200px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 15px;
        }
        .header-left {
            position: absolute;
            left: 0;
            top: 15px;
            font-weight: bold;
            font-size: 14pt;
            line-height: 1.5;
            max-width: 30%; 
        }
        .header-left p { margin: 0; }
        
        .header-title-date {
            position: absolute;
            left: 50%;
            top: 50px;
            transform: translateX(-50%);
            text-align: center;
            width: 60%;
        }
        .qr-code {
            width: 200px;
            height: 200px;
            position: absolute;
            right: 0;
            top: 0;
        }
        .info-panel button { padding: 10px 20px; font-size: 14px; font-weight: bold; }
        .download-btn { background-color: #0275d8; }
        .copy-btn { background-color: #5bc0de; }
        .share-btn { background-color: #5cb85c; }
        
        .download-btn:hover { background-color: #025aa5; }
        .copy-btn:hover { background-color: #31b0d5; }
        .share-btn:hover { background-color: #449d44; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #000; }
        th, td { border: 1px solid #666; padding: 4px 6px; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: bold; text-transform: uppercase; }
        .text-center { text-align: center; } .text-right { text-align: right; } .no-border, .no-border td { border: none; }
        .font-bold { font-weight: bold; } .font-large { font-size: 14pt; } .font-xlarge { font-size: 16pt; }
        .text-red { color: #d90000; } .text-green { color: #00b050; }
        .summary-table th { background-color: #d9e1f2; }
        .summary-table .highlight { background-color: #357ee7; color: #ffffff; } .details-table th { background-color: #d9e1f2; }
        .details-table { margin-bottom: 10px; font-size: 14pt;font-weight: bold;} .footer-banner { padding: 5px; text-align: left; font-size: 14pt; color: white; margin-bottom: 5px;}
        .footer-container { display: flex; align-items: flex-start; gap: 10px;}
        .footer-left { width: 60%; font-size: 18pt; font-weight: bold; text-align: center; }
        .footer-right { width: 60%; }
        .totals-table td { padding: 5px 7px; font-size: 16pt; }

        /* --- CSS M·ªöI CHO C√ÅC D√íNG GHI CH√ö --- */
        .footer-notes {
            font-size: 14pt;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            color: blue;
        }

        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .info-panel, .bill-controls { display: none !important; }
            .bill-page { page-break-after: always; margin: 0; padding: 0; box-shadow: none; border: none; width: 100%; max-width: none; min-width: 0; }
            body { background-color: #fff; padding: 0; margin: 0; }
        }
    </style>
</head>
<body>

    <div id="info-panel" class="info-panel">
        <h1 id="status-message">ƒêang t·∫£i v√† t·∫°o bill...</h1>
        <button id="download-zip-btn" style="display: none; background-color: #337ab7;">üíæ T·∫£i t·∫•t c·∫£ Bill (ZIP)</button>
    </div>
    
    <div id="bills-container"></div>

    <template id="bill-template">
         <div class="bill-page">
            <div class="bill-controls">
                <button class="download-btn">T·∫£i Bill</button>
                <button class="copy-btn">Copy Bill</button>
                <button class="share-btn">G·ª≠i Bill</button>
            </div>
            
            <div class="bill-header">
                <div class="header-left">
                    <p>Ch·ªß h·ª•i: <span data-field="chu_hui"></span></p>
                    <p>SƒêT: <span data-field="sdt"></span></p>
                    <p>ƒê·ªãa ch·ªâ: <span data-field="dia_chi"></span></p>
                    <p data-field="bank_info"></p>
                </div>
                <div class="header-title-date">
                    <h2 style="margin: 5px 0 0 0; font-size: 30pt;">BILL B√ÅO H·ª§I</h2>
                    <p style="margin: 0;">Ng√†y: <span data-field="ngay_tao_bill"></span></p>
                </div>
                <img data-field="qr_bill_url" class="qr-code" alt="QR">
            </div>

            <table class="summary-table text-center">
                <thead><tr><th class="highlight" data-field="summary_title_hui_vien"></th><th class="highlight" data-field="summary_title_hui_chet"></th><th class="highlight" data-field="summary_title_hui_song"></th><th class="highlight">√Çm/D∆∞∆°ng *</th><th class="highlight">L·ª£i Nhu·∫≠n</th></tr></thead>
                <tbody><tr><td class="font-bold" data-field="hoi_vien"></td><td data-field="tong_hui_chet"></td><td data-field="tong_hui_song"></td><td class="font-bold" data-field="am_duong"></td><td class="font-bold" data-field="loi_nhuan"></td></tr></tbody>
            </table>
            
            <table class="details-table text-center">
                <thead><tr><th style="width: 4%;">STT</th><th>D√¢y H·ª•i</th><th>K·ª≥</th><th>Khui</th><th>S·ªêNG</th><th>CH·∫æT</th><th>Ti·ªÅn H·ªët</th><th>Ti·ªÅn ƒê√≥ng</th><th>ThƒÉm</th><th>Th·∫£o</th><th>ƒê√∫p</th></tr></thead>
                <tbody data-field="details_tbody"></tbody>
            </table>

            <div class="footer-container">
                <div class="footer-left">
                    <div class="footer-banner" data-field="footer_banner"></div>
                    <span data-field="footer_hoi_vien"></span>
                    <div class="footer-notes">
                        <p data-field="ghi_chu_1"></p>
                        <p data-field="ghi_chu_2"></p>
                    </div>
                </div>
                <div class="footer-right">
                    <table class="totals-table no-border">
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn ƒê√≥ng:</td><td class="text-right font-large font-bold" data-field="bill_tong_dong"></td><td style="width: 25px;" class="text-center">(1)</td><td class="text-blue font-bold" data-field="tong_tham"></td></tr>
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn H·ªët:</td><td class="text-right font-large font-bold" data-field="bill_tong_hot"></td><td class="text-center">(2)</td><td class="text-blue font-bold" data-field="tong_thao"></td></tr>
                        <tr><td class="font-bold" data-field="final_text_label"></td><td class="text-right font-xlarge font-bold text-red" data-field="final_amount"></td><td class="text-center font-bold"></td><td class="text-center font-bold" data-field="final_formula_text"></td></tr>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <script>
        window.onload = function() {
            const infoPanel = document.getElementById('info-panel');
            const statusMessage = document.getElementById('status-message');
            const downloadZipBtn = document.getElementById('download-zip-btn');
            infoPanel.style.display = 'block';

            try {
                const encodedData = window.location.hash.substring(1);
                if (!encodedData) {
                    statusMessage.textContent = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu bill trong ƒë∆∞·ªùng link.';
                    return;
                }
                const jsonData = decodeURIComponent(encodedData);
                generateBills(jsonData);

                statusMessage.style.display = 'none';
                downloadZipBtn.style.display = 'inline-block';
                downloadZipBtn.addEventListener('click', downloadAllAsZip);
            } catch (error) {
                statusMessage.textContent = 'L·ªói! D·ªØ li·ªáu bill trong link kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ b·ªã h·ªèng.';
                console.error("L·ªói gi·∫£i m√£ ho·∫∑c x·ª≠ l√Ω d·ªØ li·ªáu:", error);
            }
        };

        function formatCurrency(num) { if (typeof num !== 'number' || num === null) return '0'; return num.toLocaleString('vi-VN'); }

        function generateBills(jsonInput) {
            const billsContainer = document.getElementById('bills-container');
            billsContainer.innerHTML = '';
            const data = JSON.parse(jsonInput);
            const billTemplate = document.getElementById('bill-template');
            
            data.forEach(kh => {
                const billNode = document.importNode(billTemplate.content, true);
                const q = (selector) => billNode.querySelector(selector);
                
                // --- TH√äM D·ªÆ LI·ªÜU M·ªöI V√ÄO C√ÅC TR∆Ø·ªúNG ---
                q('[data-field="chu_hui"]').textContent = kh.chu_hui || ''; 
                q('[data-field="sdt"]').textContent = kh.sdt || ''; 
                q('[data-field="bank_info"]').textContent = kh.bank_info || ''; 
                q('[data-field="ngay_tao_bill"]').textContent = kh.ngay_tao_bill || ''; 
                q('[data-field="qr_bill_url"]').src = kh.qr_bill_url || '';
                
                q('[data-field="dia_chi"]').textContent = kh.dia_chi || ''; // <-- D·ªÆ LI·ªÜU ƒê·ªäA CH·ªà
                q('[data-field="ghi_chu_1"]').textContent = kh.ghi_chu_1 || ''; // <-- D·ªÆ LI·ªÜU GHI CH√ö 1
                q('[data-field="ghi_chu_2"]').textContent = kh.ghi_chu_2 || ''; // <-- D·ªÆ LI·ªÜU GHI CH√ö 2
                
                // --- PH·∫¶N C√íN L·∫†I GI·ªÆ NGUY√äN ---
                q('[data-field="summary_title_hui_vien"]').textContent = `H·ª•i Vi√™n | ${kh.tong_so_day || 0} D√¢y, ${kh.tong_so_chan || 0} C`; 
                q('[data-field="summary_title_hui_chet"]').textContent = `H·ª•i Ch·∫øt | ${kh.tong_so_chan_chet || 0} C`; 
                q('[data-field="summary_title_hui_song"]').textContent = `H·ª•i S·ªëng | ${kh.tong_so_chan_song || 0} C`;
                q('[data-field="hoi_vien"]').textContent = kh.hoi_vien || ''; 
                q('[data-field="tong_hui_chet"]').textContent = formatCurrency(kh.tong_hui_chet); 
                q('[data-field="tong_hui_song"]').textContent = formatCurrency(kh.tong_hui_song); 
                const amDuongCell = q('[data-field="am_duong"]'); 
                const amDuongValue = kh.am_duong || 0; 
                amDuongCell.textContent = formatCurrency(amDuongValue); 
                if (amDuongValue > 0) { amDuongCell.classList.add('text-green'); } else if (amDuongValue < 0) { amDuongCell.classList.add('text-red'); } 
                const loiNhuanCell = q('[data-field="loi_nhuan"]'); 
                const loiNhuanValue = kh.loi_nhuan || 0; 
                loiNhuanCell.textContent = formatCurrency(loiNhuanValue); 
                if (loiNhuanValue > 0) { loiNhuanCell.classList.add('text-green'); } else if (loiNhuanValue < 0) { loiNhuanCell.classList.add('text-red'); }
                
                const detailsBody = q('[data-field="details_tbody"]');
                const allDetails = [].concat(kh.chan_hui_details || []).concat(kh.hui_1_1_details || []).concat(kh.ghi_no_details || []).concat(kh.tien_gop_details || []);
                
                if (allDetails.length > 0) {
                    let sttCounter = 1;
                    allDetails.forEach(d => {
                        const row = document.createElement('tr');
                        if ((d.khui || '').toLowerCase().includes('n·ª£')) {
                            row.style.backgroundColor = '#fff0f0';
                            row.innerHTML = `<td colspan="8" style="text-align: left; font-weight: bold;">${d.khui}</td><td class="font-bold">${formatCurrency(d.tien_dong)}</td><td colspan="3"></td>`;
                        } else {
                            
                            row.innerHTML = `<td>${sttCounter}</td><td>${d.day_hui || ''}</td><td>${d.ky || ''}</td><td class="font-bold text-red">${d.khui || ''}</td><td>${d.song || 0}</td><td>${d.chet || 0}</td><td>${formatCurrency(d.tien_hot)}</td><td>${formatCurrency(d.tien_dong)}</td><td class="font-bold text-red">${formatCurrency(d.tham)}</td><td>${formatCurrency(d.thao)}</td><td>${d.dup || 0}</td>`;
                            sttCounter++;
                        }
                        detailsBody.appendChild(row);
                    });
                }
                
                q('[data-field="footer_hoi_vien"]').textContent = kh.hoi_vien || ''; 
                q('[data-field="bill_tong_dong"]').textContent = formatCurrency(kh.bill_tong_dong); 
                q('[data-field="bill_tong_hot"]').textContent = formatCurrency(kh.bill_tong_hot); 
                q('[data-field="tong_tham"]').textContent = `T·ªïng ThƒÉm: ${formatCurrency(kh.tong_tham)}`; 
                q('[data-field="tong_thao"]').textContent = `T·ªïng Th·∫£o: ${formatCurrency(kh.tong_thao)}`;
                const banner = q('[data-field="footer_banner"]'); 
                const tongDong = kh.bill_tong_dong || 0; 
                const tongHot = kh.bill_tong_hot || 0;
                if (tongDong > tongHot) { 
                    banner.textContent = 'Ch·ªß H·ª•i ph·∫£i thu ti·ªÅn H·ª•i Vi√™n'; 
                    banner.style.backgroundColor = '#d90000'; 
                    q('[data-field="final_text_label"]').textContent = 'Ph·∫£i ƒê√≥ng:'; 
                    q('[data-field="final_amount"]').textContent = formatCurrency(tongDong - tongHot); 
                    q('[data-field="final_formula_text"]').textContent = '=(1)-(2)'; 
                } else { 
                    banner.textContent = 'H·ª•i Vi√™n ƒë∆∞·ª£c nh·∫≠n ti·ªÅn'; 
                    banner.style.backgroundColor = '#00b050'; 
                    q('[data-field="final_text_label"]').textContent = 'ƒê∆∞·ª£c Nh·∫≠n:'; 
                    q('[data-field="final_amount"]').textContent = formatCurrency(tongHot - tongDong); 
                    q('[data-field="final_formula_text"]').textContent = '=(2)-(1)'; 
                }
                
                const billElement = billNode.querySelector('.bill-page');
                billElement.dataset.sdt = kh.sdt_kh || '';
                billElement.dataset.hoivien = kh.hoi_vien || 'bill';
                
                billNode.querySelector('.download-btn').addEventListener('click', () => downloadBillAsImage(billElement));
                billNode.querySelector('.copy-btn').addEventListener('click', () => copyBillAsImage(billElement));
                billNode.querySelector('.share-btn').addEventListener('click', () => shareBillAsImage(billElement));
                billsContainer.appendChild(billNode);
            });
        }
        
        function copyBillAsImage(element) { const c = element.querySelector('.bill-controls'); c.style.display = 'none'; html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => { canvas.toBlob(blob => { navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).then(() => alert('ƒê√£ copy ·∫£nh bill v√†o b·ªô nh·ªõ t·∫°m!')).catch(err => { console.error(err); alert('L·ªói khi copy: ' + err); }); }); c.style.display = 'flex'; }).catch(err => { console.error('L·ªói html2canvas:', err); c.style.display = 'flex'; }); }
        function downloadBillAsImage(element) { const sdt = element.dataset.sdt; const hoivien = element.dataset.hoivien; const filename = (sdt ? sdt : `Bill_${hoivien.replace(/\s+/g, '_')}`) + '.png'; const c = element.querySelector('.bill-controls'); c.style.display = 'none'; html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => { const link = document.createElement('a'); link.download = filename; link.href = canvas.toDataURL("image/png"); link.click(); c.style.display = 'flex'; }).catch(err => { console.error('L·ªói khi t·∫°o ·∫£nh:', err); alert('ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o ·∫£nh.'); c.style.display = 'flex'; }); }
        async function shareBillAsImage(element) { const sdt = element.dataset.sdt; const hoivien = element.dataset.hoivien; const filename = (sdt ? sdt : `Bill_${hoivien}`) + '.png'; const c = element.querySelector('.bill-controls'); c.style.display = 'none'; try { const canvas = await html2canvas(element, { scale: 1.5, useCORS: true }); const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png')); const file = new File([blob], filename, { type: 'image/png' }); if (navigator.canShare && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], }); } else { alert('Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ chia s·∫ª file.'); } } catch (error) { console.error(error); } finally { c.style.display = 'flex'; } }
        async function downloadAllAsZip() {
            const bills = document.querySelectorAll('.bill-page');
            if (bills.length === 0) { alert('Kh√¥ng c√≥ bill n√†o ƒë·ªÉ t·∫£i.'); return; }
            const button = document.getElementById('download-zip-btn');
            const originalText = button.innerHTML;
            button.innerHTML = 'üîÑ ƒêang x·ª≠ l√Ω...';
            button.disabled = true;
            const zip = new JSZip();
            for (const bill of bills) {
                const controls = bill.querySelector('.bill-controls');
                if (controls) controls.style.display = 'none';
                try {
                    const canvas = await html2canvas(bill, { scale: 1.5, useCORS: true });
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    const sdt = bill.dataset.sdt;
                    const hoivien = bill.dataset.hoivien;
                    const fileName = (sdt ? sdt : `${hoivien.replace(/\s+/g, '_')}`) + '.png';
                    zip.file(fileName, blob);
                } catch (error) {
                    console.error(`L·ªói khi x·ª≠ l√Ω bill:`, error);
                } finally {
                    if (controls) controls.style.display = 'flex';
                }
            }
            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    const today = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
                    link.download = `Tat_ca_bill_${today}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            button.innerHTML = originalText;
            button.disabled = false;
        }
    </script>
</body>
</html>
