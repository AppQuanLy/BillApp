<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill B√°o H·ª•i - T·∫øt Ph√∫ Qu√Ω Ch√¢n Th·ª±c</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Roboto:wght@400;500;700;900&family=Playfair+Display:wght@900&display=swap" rel="stylesheet">

    <style>
        @page { size: A3 landscape; margin: 1.5cm; }
        body { font-family: 'Roboto', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        
        /* --- PANEL ƒêI·ªÄU KHI·ªÇN (GI·ªÆ NGUY√äN) --- */
        .info-panel { max-width: 900px; margin: 0 auto 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .info-panel h1 { margin: 0 0 10px; color: #b71c1c; font-family: 'Playfair Display', serif; }
        
        /* --- DASHBOARD (GI·ªÆ NGUY√äN) --- */
        .dashboard-panel { max-width: 1200px; margin: 0 auto 20px auto; padding: 15px; background: #fff; border: 2px solid #ddd; border-radius: 8px; color: #333; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dashboard-title { font-size: 18pt; font-weight: bold; margin-bottom: 15px; text-align: center; text-transform: uppercase; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .dashboard-grid { display: flex; gap: 30px; justify-content: space-between; }
        .dashboard-col { flex: 1; text-align: center; padding: 15px; border-radius: 8px; background-color: #f9f9f9; border: 1px solid #eee; }
        .total-box { font-size: 24pt; font-weight: bold; margin: 10px 0; }
        .text-red { color: #d90000; } .text-green { color: #00b050; }
        .label-text { font-size: 13pt; font-weight: bold; color: #555; }
        
        /* --- BILL PAGE (N·ªÄN GI·∫§Y G·∫§M) --- */
        .bill-page { 
            background-color: #fffbea; /* M√†u kem v√†ng s√°ng */
            /* T·∫°o v√¢n gi·∫•y g·∫•m m·ªù */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4af37' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            
            max-width: 1200px; min-width: 1200px; 
            margin: 20px auto; padding: 35px; 
            
            /* Vi·ªÅn khung tranh v√†ng son */
            border: 6px solid #8e0000;
            box-shadow: 
                inset 0 0 0 4px #ffc107, /* Vi·ªÅn v√†ng trong */
                0 10px 25px rgba(0,0,0,0.3); /* B√≥ng ƒë·ªï s√¢u */
            border-radius: 4px;
            position: relative; 
            font-family: Arial, sans-serif; font-size: 16pt; 
            overflow: hidden; 
        }

        /* --- SVG VECTOR DECORATION (REALISTIC) --- */
        .decor-svg { position: absolute; z-index: 0; pointer-events: none; }

        /* 1. D√¢y Ph√°o 3D (Treo 2 b√™n) */
        .firecracker { top: -15px; width: 90px; height: auto; z-index: 2; filter: drop-shadow(3px 3px 4px rgba(0,0,0,0.4)); }
        .fc-left { left: -5px; }
        .fc-right { right: -5px; transform: scaleX(-1); }

        /* 2. C√†nh Mai C·ªï Th·ª• 3D (G√≥c tr√™n) */
        .apricot { top: -40px; width: 380px; height: auto; }
        .ap-left { left: -40px; filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2)); }
        .ap-right { right: -40px; transform: scaleX(-1); filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2)); }

        /* 3. L·ªìng ƒê√®n Ph√°t S√°ng (Treo g√≥c) */
        .lantern { top: -10px; width: 100px; height: auto; z-index: 1; transform-origin: top center; animation: swing 3.5s infinite ease-in-out alternate; }
        .lt-left { left: 220px; }
        .lt-right { right: 220px; }
        @keyframes swing { from { transform: rotate(-3deg); } to { transform: rotate(3deg); } }

        /* 4. Th·ªèi V√†ng & Ti·ªÅn Xu 3D (G√≥c d∆∞·ªõi) */
        .gold-ingot { bottom: -20px; width: 180px; height: auto; z-index: 2; filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.3)); }
        .gold-left { left: -20px; }
        .gold-right { right: -20px; transform: scaleX(-1); }

        /* N√∫t ƒëi·ªÅu khi·ªÉn */
        .bill-controls { position: absolute; bottom: 25px; left: 180px; display: flex; gap: 12px; z-index: 100; }
        .bill-controls button, .info-panel button { padding: 10px 18px; font-size: 13px; cursor: pointer; color: white; border: none; border-radius: 30px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.2s; border: 2px solid white; }
        .download-btn { background: linear-gradient(to bottom, #d32f2f, #b71c1c); } .download-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(183, 28, 28, 0.4); }
        .copy-btn { background: linear-gradient(to bottom, #fbc02d, #f57f17); color: #333 !important; } .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(249, 168, 37, 0.4); }
        .share-btn { background: linear-gradient(to bottom, #0288d1, #01579b); } .share-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(2, 136, 209, 0.4); }

        /* HEADER */
        .bill-header { position: relative; min-height: 230px; border-bottom: 3px double #d32f2f; margin-bottom: 20px; z-index: 1; }
        .header-left { position: absolute; left: 0; top: 15px; font-weight: bold; font-size: 14pt; line-height: 1.6; max-width: 30%; color: #8e0000; text-shadow: 1px 1px 0px #fff; }
        
        .header-title-date { position: absolute; left: 50%; top: 40px; transform: translateX(-50%); text-align: center; width: 60%; }
        /* Hi·ªáu ·ª©ng ch·ªØ V√†ng ƒê√∫c N·ªïi 3D ch√¢n th·ª±c */
        .header-title-date h2 { 
            margin: 0; font-family: 'Playfair Display', serif; font-size: 45pt; 
            color: #ffd700; /* M√†u v√†ng kim */
            text-transform: uppercase; letter-spacing: 3px; font-weight: 900;
            text-shadow: 
                0px 1px 0px #c49a00, 
                0px 2px 0px #a88400, 
                0px 3px 0px #8c6e00, 
                0px 4px 0px #705800, 
                0px 5px 10px rgba(0,0,0,0.4); /* B√≥ng ƒë·ªï 3D */
        }
        .header-title-date p { font-weight: bold; color: #555; margin-top: 10px; font-size: 14pt; }
        
        .qr-code { width: 170px; height: 170px; position: absolute; right: 0; top: 10px; background-color: white; padding: 6px; border: 3px solid #8e0000; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .qr-code img { width: 100%; height: 100%; display: block; }

        /* B·∫¢NG D·ªÆ LI·ªÜU */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; color: #000; position: relative; z-index: 1; border: 2px solid #8e0000; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #b71c1c; padding: 8px 10px; vertical-align: middle; }
        
        /* Header b·∫£ng Gradient 3D */
        th { font-weight: bold; text-transform: uppercase; color: #fff; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }
        .summary-table th { 
            background: linear-gradient(to bottom, #ffc107 0%, #ff8f00 100%); /* V√†ng cam 3D */
            border-bottom: 2px solid #c79100; color: #4e342e; text-shadow: none;
        }
        .details-table th {
            background: linear-gradient(to bottom, #d32f2f 0%, #8e0000 100%); /* ƒê·ªè ƒë√¥ 3D */
            border-bottom: 2px solid #640000;
        }
        .highlight { background-color: #fff8e1; font-weight: bold; } 
        .details-table { margin-bottom: 15px; font-size: 14pt; }
        .details-table tr:nth-child(even) { background-color: #fefefe; }

        /* Footer */
        .footer-banner { padding: 10px 15px; text-align: left; font-size: 14pt; color: white; margin-bottom: 10px; border-radius: 4px; font-weight: bold; box-shadow: 2px 2px 4px rgba(0,0,0,0.2); background: linear-gradient(to right, #d32f2f, #b71c1c); border: 1px solid #8e0000;}
        .footer-container { display: flex; align-items: flex-start; gap: 15px; position: relative; z-index: 1;}
        .footer-left { width: 40%; font-size: 18pt; font-weight: bold; text-align: center; color: #8e0000; }
        .footer-right { width: 60%; }
        .totals-table td { padding: 8px 10px; font-size: 16pt; }
        
        /* Ch·ªØ k√Ω th∆∞ ph√°p & L·ªùi ch√∫c */
        .signature-font { font-family: 'Dancing Script', cursive; font-size: 30pt !important; color: #d32f2f; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .footer-notes { margin-top: 15px; }
        .tet-wishes { font-family: 'Playfair Display', serif; font-size: 22pt; color: #d32f2f; font-weight: bold; text-shadow: 1px 1px 0 #ffc107; }

        .text-center { text-align: center; } .text-right { text-align: right; } .no-border, .no-border td { border: none; }
        .font-bold { font-weight: bold; } .font-large { font-size: 14pt; } .font-xlarge { font-size: 16pt; }

        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .info-panel, .bill-controls, .dashboard-panel { display: none !important; }
            .bill-page { page-break-after: always; margin: 0; padding: 0; box-shadow: none; border: none; width: 100%; max-width: none; min-width: 0; background-image: none; background-color: #fff;}
            body { background-color: #fff; padding: 0; margin: 0; }
        }
    </style>
</head>
<body>

    <div id="info-panel" class="info-panel">
        <h1 id="status-message">üå∏ ƒêang t·∫£i d·ªØ li·ªáu Bill T·∫øt Ph√∫ Qu√Ω...</h1>
        <button id="download-zip-btn" style="display: none; background: linear-gradient(to bottom, #d32f2f, #b71c1c); color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">üíæ T·∫£i t·∫•t c·∫£ Bill (ZIP)</button>
    </div>

    <div id="dashboard-panel" class="dashboard-panel">
        <div class="dashboard-title">B·∫¢NG T·ªîNG H·ª¢P NHANH</div>
        <div class="dashboard-grid">
            <div class="dashboard-col" style="border-bottom: 4px solid #00b050;">
                <div class="label-text">T·ªîNG PH·∫¢I GIAO (Bill H·ªët):</div>
                <div id="total-payable" class="total-box text-green">0</div> 
                <button id="copy-payable-btn" style="background-color: #00b050; color: white; border: none; padding: 8px 15px; font-weight: bold; border-radius: 4px; margin-top: 10px; cursor: pointer;">üìã Copy danh s√°ch giao</button>
            </div>
            <div class="dashboard-col" style="border-bottom: 4px solid #d90000;">
                <div class="label-text">T·ªîNG PH·∫¢I THU (Bill ƒê√≥ng):</div>
                <div id="total-receivable" class="total-box text-red">0</div>
                <button id="copy-summary-btn" style="background-color: #d90000; color: white; border: none; padding: 8px 15px; font-weight: bold; border-radius: 4px; margin-top: 10px; cursor: pointer;">üìã Copy danh s√°ch thu</button>
            </div>
        </div>
    </div>
    
    <div id="bills-container"></div>

    <template id="bill-template">
         <div class="bill-page">
            
            <svg class="decor-svg" width="0" height="0">
                <defs>
                    <radialGradient id="petalGrad" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                        <stop offset="0%" style="stop-color:#fff59d;stop-opacity:1" /><stop offset="80%" style="stop-color:#fbc02d;stop-opacity:1" /><stop offset="100%" style="stop-color:#f57f17;stop-opacity:1" />
                    </radialGradient>
                    <radialGradient id="centerGrad" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#e65100;stop-opacity:1" /><stop offset="100%" style="stop-color:#ff9800;stop-opacity:1" />
                    </radialGradient>
                    <linearGradient id="firecrackerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#b71c1c" /><stop offset="30%" style="stop-color:#e53935" /><stop offset="50%" style="stop-color:#ffcdd2" /><stop offset="70%" style="stop-color:#e53935" /><stop offset="100%" style="stop-color:#b71c1c" />
                    </linearGradient>
                    <linearGradient id="ropeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#5d4037" /><stop offset="50%" style="stop-color:#a1887f" /><stop offset="100%" style="stop-color:#5d4037" />
                    </linearGradient>
                    <radialGradient id="lanternGlow" cx="50%" cy="50%" r="50%">
                        <stop offset="40%" style="stop-color:#ffeb3b; stop-opacity:1" /><stop offset="90%" style="stop-color:#d50000; stop-opacity:1" /><stop offset="100%" style="stop-color:#8e0000; stop-opacity:1" />
                    </radialGradient>
                     <linearGradient id="goldFrame" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#fff59d" /><stop offset="50%" style="stop-color:#fbc02d" /><stop offset="100%" style="stop-color:#f57f17" />
                    </linearGradient>
                    <linearGradient id="goldIngotGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#fff9c4" /><stop offset="20%" style="stop-color:#ffd54f" /><stop offset="50%" style="stop-color:#ffc107" /><stop offset="100%" style="stop-color:#ff6f00" />
                    </linearGradient>
                    <linearGradient id="goldSideGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                         <stop offset="0%" style="stop-color:#ff6f00" /><stop offset="50%" style="stop-color:#ffca28" /><stop offset="100%" style="stop-color:#ff6f00" />
                    </linearGradient>

                    <g id="realisticFlower">
                        <path d="M0 -20 C5 -30 15 -30 20 -20 C25 -10 25 0 20 10 C15 20 5 20 0 10 C-5 20 -15 20 -20 10 C-25 0 -25 -10 -20 -20 C-15 -30 -5 -30 0 -20 Z" fill="url(#petalGrad)" stroke="#e65100" stroke-width="0.5"/>
                        <path d="M0 -20 C5 -30 15 -30 20 -20" fill="url(#petalGrad)" opacity="0.8"/>
                        <circle r="5" fill="url(#centerGrad)" />
                        <g fill="#3e2723"> <circle cx="-2" cy="-2" r="0.8"/><circle cx="2" cy="-2" r="0.8"/><circle cx="0" cy="3" r="0.8"/><circle cx="-3" cy="1" r="0.8"/><circle cx="3" cy="1" r="0.8"/>
                        </g>
                    </g>
                </defs>
            </svg>

            <svg class="decor-svg apricot ap-left" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
                <path d="M-20 20 Q30 100 100 80 Q180 60 250 120 Q300 160 350 140" stroke="#4e342e" stroke-width="12" fill="none" stroke-linecap="round"/>
                <path d="M-20 20 Q30 100 100 80 Q180 60 250 120 Q300 160 350 140" stroke="#795548" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.7" stroke-dasharray="20,10"/>
                <path d="M100 80 Q130 150 180 180" stroke="#4e342e" stroke-width="8" fill="none" stroke-linecap="round"/>
                <path d="M250 120 Q280 50 320 30" stroke="#4e342e" stroke-width="6" fill="none" stroke-linecap="round"/>
                
                <use href="#realisticFlower" x="100" y="80" transform="scale(1.2) rotate(20)"/>
                <use href="#realisticFlower" x="250" y="120" transform="scale(1.5) rotate(-10)"/>
                <use href="#realisticFlower" x="180" y="180" transform="scale(1.1) rotate(45)"/>
                <use href="#realisticFlower" x="320" y="30" transform="scale(1) rotate(-30)"/>
                <use href="#realisticFlower" x="50" y="120" transform="scale(0.8) rotate(10)"/>
                
                <g fill="url(#petalGrad)" stroke="#e65100">
                    <ellipse cx="150" cy="130" rx="6" ry="8" transform="rotate(30)"/><ellipse cx="200" cy="100" rx="5" ry="7" transform="rotate(-20)"/>
                    <ellipse cx="290" cy="80" rx="6" ry="8" transform="rotate(10)"/>
                </g>
            </svg>
            <svg class="decor-svg apricot ap-right" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg"><use href=".ap-left path:nth-child(1)"/><use href=".ap-left path:nth-child(2)"/><use href=".ap-left path:nth-child(3)"/><use href=".ap-left path:nth-child(4)"/><use href=".ap-left use:nth-child(5)"/><use href=".ap-left use:nth-child(6)"/><use href=".ap-left use:nth-child(7)"/><use href=".ap-left use:nth-child(8)"/><use href=".ap-left use:nth-child(9)"/><use href=".ap-left g"/></svg>

            <svg class="decor-svg firecracker fc-left" viewBox="0 0 80 320" xmlns="http://www.w3.org/2000/svg">
                <path d="M40 0 Q35 10 40 20 Q45 30 40 40 Q35 50 40 60 Q45 70 40 80 Q35 90 40 100 Q45 110 40 120 Q35 130 40 140 Q45 150 40 160 Q35 170 40 180 Q45 190 40 200 Q35 210 40 220 Q45 230 40 240" stroke="url(#ropeGrad)" stroke-width="6" fill="none"/>
                <g>
                    <rect x="15" y="25" width="50" height="30" rx="4" fill="url(#firecrackerGrad)" transform="rotate(-8 40 40)"/>
                    <rect x="15" y="65" width="50" height="30" rx="4" fill="url(#firecrackerGrad)" transform="rotate(8 40 80)"/>
                    <rect x="15" y="105" width="50" height="30" rx="4" fill="url(#firecrackerGrad)" transform="rotate(-8 40 120)"/>
                    <rect x="15" y="145" width="50" height="30" rx="4" fill="url(#firecrackerGrad)" transform="rotate(8 40 160)"/>
                    <rect x="15" y="185" width="50" height="30" rx="4" fill="url(#firecrackerGrad)" transform="rotate(-8 40 200)"/>
                    
                    <rect x="25" y="35" width="30" height="5" fill="#ffd700" transform="rotate(-8 40 40)" opacity="0.8"/>
                    <rect x="25" y="75" width="30" height="5" fill="#ffd700" transform="rotate(8 40 80)" opacity="0.8"/>
                    <rect x="25" y="115" width="30" height="5" fill="#ffd700" transform="rotate(-8 40 120)" opacity="0.8"/>
                </g>
                <circle cx="40" cy="250" r="12" fill="url(#ropeGrad)"/>
                <circle cx="40" cy="285" r="18" fill="#d32f2f" stroke="#ffd700" stroke-width="2"/>
                <path d="M35 280 h10 M40 275 v15 M30 295 h20" stroke="#ffd700" stroke-width="3" stroke-linecap="round"/>
            </svg>
            <svg class="decor-svg firecracker fc-right" viewBox="0 0 80 320" xmlns="http://www.w3.org/2000/svg"><use href=".fc-left path"/><use href=".fc-left g"/><use href=".fc-left circle:nth-child(3)"/><use href=".fc-left circle:nth-child(4)"/><use href=".fc-left path:nth-child(5)"/></svg>

            <svg class="decor-svg lantern lt-left" viewBox="0 0 100 220" xmlns="http://www.w3.org/2000/svg">
                <line x1="50" y1="0" x2="50" y2="60" stroke="#8e0000" stroke-width="3"/>
                <g transform="translate(50, 90)">
                    <ellipse cx="0" cy="0" rx="40" ry="35" fill="url(#lanternGlow)"/>
                    <path d="M-25 -30 Q-45 0 -25 30 M25 -30 Q45 0 25 30 M0 -35 V35" fill="none" stroke="url(#goldFrame)" stroke-width="2"/>
                    <rect x="-20" y="-38" width="40" height="10" fill="url(#goldFrame)" rx="3"/>
                    <rect x="-20" y="30" width="40" height="10" fill="url(#goldFrame)" rx="3"/>
                    <g transform="translate(0, 40)">
                         <path d="M0 0 Q-5 20 -10 50 M0 0 Q5 20 10 50 M0 0 V60" stroke="#d32f2f" stroke-width="4" fill="none"/>
                         <path d="M0 0 Q-8 20 -15 45 M0 0 Q8 20 15 45" stroke="#b71c1c" stroke-width="3" fill="none"/>
                    </g>
                </g>
            </svg>
            <svg class="decor-svg lantern lt-right" viewBox="0 0 100 220" xmlns="http://www.w3.org/2000/svg"><use href=".lt-left line"/><use href=".lt-left g"/></svg>

            <svg class="decor-svg gold-ingot gold-left" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
                <g transform="translate(100, 60)">
                    <path d="M-70 -20 L-50 30 L50 30 L70 -20 Z" fill="url(#goldSideGrad)"/>
                    <path d="M-70 -20 Q0 -50 70 -20 Q50 10 -70 -20" fill="url(#goldIngotGrad)"/>
                    <path d="M-50 30 Q0 50 50 30" fill="none" stroke="#e65100" stroke-width="1" opacity="0.5"/>
                    <ellipse cx="0" cy="-25" rx="30" ry="5" fill="#fff" opacity="0.6"/>
                </g>
                <g transform="translate(30, 80) rotate(-20)">
                    <circle r="18" fill="url(#goldIngotGrad)" stroke="#f57f17" stroke-width="2"/>
                    <rect x="-8" y="-8" width="16" height="16" fill="none" stroke="#f57f17" stroke-width="2"/>
                </g>
                 <g transform="translate(170, 70) rotate(30)">
                    <circle r="15" fill="url(#goldIngotGrad)" stroke="#f57f17" stroke-width="2"/>
                    <rect x="-6" y="-6" width="12" height="12" fill="none" stroke="#f57f17" stroke-width="2"/>
                </g>
            </svg>
            <svg class="decor-svg gold-ingot gold-right" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg"><use href=".gold-left g:nth-child(1)"/><use href=".gold-left g:nth-child(2)"/><use href=".gold-left g:nth-child(3)"/></svg>

            <div class="bill-controls">
                <button class="download-btn">T·∫£i Bill</button>
                <button class="copy-btn">Copy Bill</button>
                <button class="share-btn">G·ª≠i Bill</button>
            </div>
            
            <div class="bill-header">
                <div class="header-left">
                    <p>Ch·ªß h·ª•i: <span data-field="chu_hui"></span></p>
                    <p>SƒêT: <span data-field="sdt"></span></p>
                    <p>ƒê·ªãa ch·ªâ: <span data-field="dia_chi"></span></p>
                    <p data-field="bank_info"></p>
                </div>
                <div class="header-title-date">
                    <h2>BILL B√ÅO H·ª§I</h2>
                    <p>Ng√†y: <span data-field="ngay_tao_bill"></span></p>
                </div>
                <div class="qr-code" data-field="qr_container"></div>
            </div>

            <table class="summary-table text-center">
                <thead><tr><th class="highlight" data-field="summary_title_hui_vien"></th><th class="highlight" data-field="summary_title_hui_chet"></th><th class="highlight" data-field="summary_title_hui_song"></th><th class="highlight">√Çm/D∆∞∆°ng *</th><th class="highlight">L·ª£i Nhu·∫≠n</th></tr></thead>
                <tbody><tr><td class="font-bold" data-field="hoi_vien"></td><td data-field="tong_hui_chet"></td><td data-field="tong_hui_song"></td><td class="font-bold" data-field="am_duong"></td><td class="font-bold" data-field="loi_nhuan"></td></tr></tbody>
            </table>
            
            <table class="details-table text-center">
                <thead><tr><th style="width: 4%;">STT</th><th>D√¢y H·ª•i</th><th>K·ª≥</th><th>Khui</th><th>S·ªêNG</th><th>CH·∫æT</th><th>Ti·ªÅn H·ªët</th><th>Ti·ªÅn ƒê√≥ng</th><th>ThƒÉm</th><th>Th·∫£o</th><th>ƒê√∫p</th></tr></thead>
                <tbody data-field="details_tbody"></tbody>
            </table>

            <div class="footer-container">
                <div class="footer-left">
                    <div class="footer-banner" data-field="footer_banner"></div>
                    <span data-field="footer_hoi_vien" class="signature-font"></span>
                    <div class="footer-notes">
                        <div class="tet-wishes">V·∫°n S·ª± Nh∆∞ √ù - T·∫•n T√†i T·∫•n L·ªôc</div>
                        <p data-field="ghi_chu_1" style="font-family: Arial; font-size: 13pt; color: #333; margin-top: 10px; font-style: italic;"></p>
                        <p data-field="ghi_chu_2" style="font-family: Arial; font-size: 13pt; color: #333; font-weight: bold;"></p>
                    </div>
                </div>
                <div class="footer-right">
                    <table class="totals-table no-border">
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn ƒê√≥ng:</td><td class="text-right font-large font-bold" data-field="bill_tong_dong"></td><td style="width: 25px;" class="text-center">(1)</td><td class="text-blue font-bold" data-field="tong_tham"></td></tr>
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn H·ªët:</td><td class="text-right font-large font-bold" data-field="bill_tong_hot"></td><td class="text-center">(2)</td><td class="text-blue font-bold" data-field="tong_thao"></td></tr>
                        <tr><td class="font-bold" data-field="final_text_label"></td><td class="text-right font-xlarge font-bold text-red" data-field="final_amount"></td><td class="text-center font-bold"></td><td class="text-center font-bold" data-field="final_formula_text"></td></tr>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <script>
        // --- LOGIC GI·ªÆ NGUY√äN 100% T·ª™ B·∫¢N G·ªêC C·ª¶A B·∫†N ---
        const VietQR = {
            cleanText: function(str) {
                if (!str) return "";
                return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D').replace(/[^a-zA-Z0-9 ]/g, '').trim();
            },
            crc16: function(data) {
                let crc = 0xFFFF;
                for (let i = 0; i < data.length; i++) {
                    crc ^= data.charCodeAt(i) << 8;
                    for (let j = 0; j < 8; j++) {
                        if ((crc & 0x8000) != 0) crc = (crc << 1) ^ 0x1021;
                        else crc = crc << 1;
                    }
                    crc = crc & 0xFFFF;
                }
                let hex = crc.toString(16).toUpperCase();
                return "0000".substring(0, 4 - hex.length) + hex;
            },
            generatePayload: function(bankBin, bankNumber, amount, content) {
                const field = (id, value) => {
                    const valStr = String(value);
                    const len = valStr.length;
                    return id + (len < 10 ? "0" + len : len) + valStr;
                };
                const cleanBin = String(bankBin).replace(/\D/g, ''); 
                const cleanAccount = String(bankNumber).replace(/[^a-zA-Z0-9]/g, ''); 
                if (cleanBin.length < 4 || cleanAccount.length < 1) return null;
                const merchantInfo = field("00", "A000000727") + field("01", field("00", cleanBin) + field("01", cleanAccount)) + field("02", "QRIBFTTA");
                let qrStr = field("00", "01") + field("01", "12") + field("38", merchantInfo) + field("53", "704"); 
                if (amount) {
                    const cleanAmount = String(amount).replace(/\D/g, '');
                    if (parseInt(cleanAmount) > 0) qrStr += field("54", cleanAmount);
                }
                qrStr += field("58", "VN"); 
                if (content) {
                    const safeContent = this.cleanText(content);
                    if (safeContent.length > 0) qrStr += field("62", field("08", safeContent));
                }
                qrStr += "6304"; 
                qrStr += this.crc16(qrStr);
                return qrStr;
            },
            parseRawData: function(rawString) {
                if (!rawString) return null;
                while (rawString.startsWith('|')) { rawString = rawString.substring(1); }
                const parts = rawString.split('|');
                if (parts.length >= 2) {
                    return this.generatePayload(parts[0].trim(), parts[1].trim(), parts[2] || "0", parts[3] || "");
                }
                return null;
            }
        };

        let globalSummaryTextReceivable = ""; let globalSummaryTextPayable = ""; 

        window.onload = function() {
            const infoPanel = document.getElementById('info-panel');
            const statusMessage = document.getElementById('status-message');
            const downloadZipBtn = document.getElementById('download-zip-btn');
            infoPanel.style.display = 'block';

            if (typeof QRCode === 'undefined') { statusMessage.textContent = 'L·ªói: Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán QRCode.js'; return; }

            try {
                const encodedData = window.location.hash.substring(1);
                if (!encodedData) { statusMessage.textContent = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.'; return; }
                const jsonData = decodeURIComponent(encodedData);
                generateBills(jsonData);

                statusMessage.style.display = 'none';
                downloadZipBtn.style.display = 'inline-block';
                downloadZipBtn.addEventListener('click', downloadAllAsZip);
            } catch (error) { statusMessage.textContent = 'L·ªói d·ªØ li·ªáu bill.'; console.error(error); }
        };

        function formatCurrency(num) { if (typeof num !== 'number' || num === null) return '0'; return num.toLocaleString('vi-VN'); }

        function generateBills(jsonInput) {
            const billsContainer = document.getElementById('bills-container');
            billsContainer.innerHTML = '';
            const data = JSON.parse(jsonInput);
            const billTemplate = document.getElementById('bill-template');
            
            let grandTotalReceivable = 0; let grandTotalPayable = 0; 
            let summaryTextReceivable = "DANH S√ÅCH PH·∫¢I THU (BILL ƒê√ìNG):\n";
            let summaryTextPayable = "DANH S√ÅCH PH·∫¢I GIAO (BILL H·ªêT):\n";
            
            data.forEach((kh, index) => {
                const billNode = document.importNode(billTemplate.content, true);
                const q = (selector) => billNode.querySelector(selector);
                
                q('[data-field="chu_hui"]').textContent = kh.chu_hui || ''; 
                q('[data-field="sdt"]').textContent = kh.sdt || ''; 
                q('[data-field="bank_info"]').textContent = kh.bank_info || ''; 
                q('[data-field="ngay_tao_bill"]').textContent = kh.ngay_tao_bill || ''; 
                q('[data-field="dia_chi"]').textContent = kh.dia_chi || ''; 
                q('[data-field="ghi_chu_1"]').textContent = kh.ghi_chu_1 || ''; 
                q('[data-field="ghi_chu_2"]').textContent = kh.ghi_chu_2 || ''; 

                q('[data-field="summary_title_hui_vien"]').textContent = `H·ª•i Vi√™n | ${kh.tong_so_day || 0} D√¢y, ${kh.tong_so_chan || 0} C`; 
                q('[data-field="summary_title_hui_chet"]').textContent = `H·ª•i Ch·∫øt | ${kh.tong_so_chan_chet || 0} C`; 
                q('[data-field="summary_title_hui_song"]').textContent = `H·ª•i S·ªëng | ${kh.tong_so_chan_song || 0} C`;
                q('[data-field="hoi_vien"]').textContent = kh.hoi_vien || ''; 
                q('[data-field="tong_hui_chet"]').textContent = formatCurrency(kh.tong_hui_chet); 
                q('[data-field="tong_hui_song"]').textContent = formatCurrency(kh.tong_hui_song); 
                
                const amDuongCell = q('[data-field="am_duong"]'); 
                const amDuongValue = kh.am_duong || 0; 
                amDuongCell.textContent = formatCurrency(amDuongValue); 
                if (amDuongValue > 0) { amDuongCell.classList.add('text-green'); } else if (amDuongValue < 0) { amDuongCell.classList.add('text-red'); } 
                
                const loiNhuanCell = q('[data-field="loi_nhuan"]'); 
                const loiNhuanValue = kh.loi_nhuan || 0; 
                loiNhuanCell.textContent = formatCurrency(loiNhuanValue); 
                if (loiNhuanValue > 0) { loiNhuanCell.classList.add('text-green'); } else if (loiNhuanValue < 0) { loiNhuanCell.classList.add('text-red'); }
                
                const detailsBody = q('[data-field="details_tbody"]');
                const allDetails = [].concat(kh.chan_hui_details || []).concat(kh.hui_1_1_details || []).concat(kh.ghi_no_details || []).concat(kh.tien_gop_details || []);
                
                if (allDetails.length > 0) {
                    let sttCounter = 1;
                    allDetails.forEach(d => {
                        const row = document.createElement('tr');
                        if ((d.khui || '').toLowerCase().includes('n·ª£')) {
                            row.style.backgroundColor = '#fff0f0';
                            row.innerHTML = `<td colspan="8" style="text-align: left; font-weight: bold;">${d.khui}</td><td class="font-bold">${formatCurrency(d.tien_dong)}</td><td colspan="3"></td>`;
                        } else {
                            row.innerHTML = `<td>${sttCounter}</td><td>${d.day_hui || ''}</td><td>${d.ky || ''}</td><td class="font-bold text-red">${d.khui || ''}</td><td>${d.song || 0}</td><td>${d.chet || 0}</td><td>${formatCurrency(d.tien_hot)}</td><td>${formatCurrency(d.tien_dong)}</td><td class="font-bold text-red">${formatCurrency(d.tham)}</td><td>${formatCurrency(d.thao)}</td><td>${d.dup || 0}</td>`;
                            sttCounter++;
                        }
                        detailsBody.appendChild(row);
                    });
                }
                
                q('[data-field="footer_hoi_vien"]').textContent = kh.hoi_vien || ''; 
                q('[data-field="bill_tong_dong"]').textContent = formatCurrency(kh.bill_tong_dong); 
                q('[data-field="bill_tong_hot"]').textContent = formatCurrency(kh.bill_tong_hot); 
                q('[data-field="tong_tham"]').textContent = `T·ªïng ThƒÉm: ${formatCurrency(kh.tong_tham)}`; 
                q('[data-field="tong_thao"]').textContent = `T·ªïng Th·∫£o: ${formatCurrency(kh.tong_thao)}`;
                
                const banner = q('[data-field="footer_banner"]'); 
                const tongDong = kh.bill_tong_dong || 0; 
                const tongHot = kh.bill_tong_hot || 0;
                const qrContainer = q('[data-field="qr_container"]');
                qrContainer.innerHTML = "";

                if (tongDong > tongHot) { 
                    banner.textContent = 'Ch·ªß H·ª•i ph·∫£i thu ti·ªÅn H·ª•i Vi√™n'; 
                    banner.style.backgroundColor = '#d90000'; 
                    q('[data-field="final_text_label"]').textContent = 'Ph·∫£i ƒê√≥ng:'; 
                    const amount = tongDong - tongHot;
                    q('[data-field="final_amount"]').textContent = formatCurrency(amount); 
                    q('[data-field="final_formula_text"]').textContent = '=(1)-(2)'; 
                    
                    const qrRawData = kh.qr_bill_url; 
                    if (qrRawData) {
                        const qrPayload = VietQR.parseRawData(qrRawData);
                        if (qrPayload) {
                            new QRCode(qrContainer, { text: qrPayload, width: 170, height: 170, correctLevel: QRCode.CorrectLevel.L });
                        } else { qrContainer.innerHTML = "<div style='color:red;font-size:12px;text-align:center;padding-top:60px;font-weight:bold'>L·ªói: Thi·∫øu BIN<br>ho·∫∑c STK</div>"; }
                    }
                    grandTotalReceivable += amount;
                    summaryTextReceivable += `${index+1}. ${kh.hoi_vien}: ${formatCurrency(amount)}\n`;
                } else { 
                    banner.textContent = 'H·ª•i Vi√™n ƒë∆∞·ª£c nh·∫≠n ti·ªÅn'; 
                    banner.style.backgroundColor = '#00b050'; 
                    q('[data-field="final_text_label"]').textContent = 'ƒê∆∞·ª£c Nh·∫≠n:'; 
                    const amountPayable = tongHot - tongDong;
                    q('[data-field="final_amount"]').textContent = formatCurrency(amountPayable); 
                    q('[data-field="final_formula_text"]').textContent = '=(2)-(1)'; 
                    qrContainer.style.display = 'none';
                    grandTotalPayable += amountPayable;
                    summaryTextPayable += `${index+1}. ${kh.hoi_vien}: ${formatCurrency(amountPayable)}\n`;
                }
                
                const billElement = billNode.querySelector('.bill-page');
                billElement.dataset.sdt = kh.sdt_kh || ''; 
                billElement.dataset.hoivien = kh.hoi_vien || 'bill';
                
                billNode.querySelector('.download-btn').addEventListener('click', () => downloadBillAsImage(billElement));
                billNode.querySelector('.copy-btn').addEventListener('click', () => copyBillAsImage(billElement));
                billNode.querySelector('.share-btn').addEventListener('click', () => shareBillAsImage(billElement));
                billsContainer.appendChild(billNode);
            });

            if (grandTotalReceivable > 0 || grandTotalPayable > 0) {
                document.getElementById('dashboard-panel').style.display = 'block';
                document.getElementById('total-receivable').textContent = formatCurrency(grandTotalReceivable);
                summaryTextReceivable += `--------------------\nT·ªîNG C·ªòNG THU: ${formatCurrency(grandTotalReceivable)}`;
                globalSummaryTextReceivable = summaryTextReceivable;
                document.getElementById('copy-summary-btn').onclick = function() { navigator.clipboard.writeText(globalSummaryTextReceivable).then(() => alert('ƒê√£ copy danh s√°ch ph·∫£i THU!')); };

                document.getElementById('total-payable').textContent = formatCurrency(grandTotalPayable);
                summaryTextPayable += `--------------------\nT·ªîNG C·ªòNG GIAO: ${formatCurrency(grandTotalPayable)}`;
                globalSummaryTextPayable = summaryTextPayable;
                const btnCopyPayable = document.getElementById('copy-payable-btn');
                if (btnCopyPayable) {
                    btnCopyPayable.onclick = function() { navigator.clipboard.writeText(globalSummaryTextPayable).then(() => alert('ƒê√£ copy danh s√°ch ph·∫£i GIAO!')); }
                }
            }
        }
        
        function copyBillAsImage(element) { const c = element.querySelector('.bill-controls'); c.style.display = 'none'; html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => { canvas.toBlob(blob => { try { window.focus(); navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).then(() => alert('ƒê√£ copy ·∫£nh bill v√†o b·ªô nh·ªõ t·∫°m!')).catch(err => { console.error(err); alert('L·ªói khi copy: ' + err); }); } catch (e) { alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£"); } }); c.style.display = 'flex'; }).catch(err => { console.error('L·ªói html2canvas:', err); c.style.display = 'flex'; }); }
        function downloadBillAsImage(element) { const sdt = element.dataset.sdt; const hoivien = element.dataset.hoivien; const filename = (sdt ? sdt : `Bill_${hoivien.replace(/\s+/g, '_')}`) + '.png'; const c = element.querySelector('.bill-controls'); c.style.display = 'none'; html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => { const link = document.createElement('a'); link.download = filename; link.href = canvas.toDataURL("image/png"); link.click(); c.style.display = 'flex'; }).catch(err => { console.error(err); alert('L·ªói t·∫°o ·∫£nh.'); c.style.display = 'flex'; }); }
        async function shareBillAsImage(element) { const sdt = element.dataset.sdt; const hoivien = element.dataset.hoivien; const filename = (sdt ? sdt : `Bill_${hoivien}`) + '.png'; const shareBtn = element.querySelector('.share-btn'); const originalText = shareBtn.textContent; shareBtn.textContent = "‚è≥ ƒêang x·ª≠ l√Ω..."; shareBtn.disabled = true; const c = element.querySelector('.bill-controls'); c.style.display = 'none'; try { const tryShare = async (scale) => { const canvas = await html2canvas(element, { scale: scale, useCORS: true, logging: false }); const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png')); const file = new File([blob], filename, { type: 'image/png' }); if (navigator.canShare && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file] }); } else { throw new Error('No Share API'); } }; try { await tryShare(1.5); } catch (e) { console.log("Th·ª≠ l·∫°i ch·∫•t l∆∞·ª£ng th·∫•p"); await tryShare(1.0); } } catch (error) { if(!error.message.includes('No Share API')) alert('L·ªói g·ª≠i bill. H√£y th·ª≠ T·∫£i Bill.'); else alert('Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ chia s·∫ª file.'); } finally { c.style.display = 'flex'; shareBtn.textContent = originalText; shareBtn.disabled = false; } }
        async function downloadAllAsZip() { const bills = document.querySelectorAll('.bill-page'); const total = bills.length; if (total === 0) { alert('Kh√¥ng c√≥ bill n√†o ƒë·ªÉ t·∫£i.'); return; } const button = document.getElementById('download-zip-btn'); const originalText = button.innerHTML; button.disabled = true; const zip = new JSZip(); let successCount = 0; for (let i = 0; i < total; i++) { const bill = bills[i]; button.innerHTML = `‚è≥ ƒêang x·ª≠ l√Ω ${i + 1}/${total}...`; const controls = bill.querySelector('.bill-controls'); if (controls) controls.style.display = 'none'; try { const capturePromise = html2canvas(bill, { scale: 1.5, useCORS: true, logging: false }); const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 8000)); const canvas = await Promise.race([capturePromise, timeoutPromise]); const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png')); const sdt = bill.dataset.sdt; const hoivien = bill.dataset.hoivien; const fileName = (sdt ? sdt : `${hoivien.replace(/\s+/g, '_')}`) + '.png'; zip.file(fileName, blob); successCount++; } catch (error) { console.error(`L·ªói bill ${i}:`, error); } finally { if (controls) controls.style.display = 'flex'; } await new Promise(r => setTimeout(r, 100)); } if (successCount > 0) { button.innerHTML = 'üì¶ ƒêang n√©n...'; const content = await zip.generateAsync({ type: "blob" }); const link = document.createElement('a'); link.href = URL.createObjectURL(content); const today = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-'); link.download = `Tat_ca_bill_${today}.zip`; document.body.appendChild(link); link.click(); document.body.removeChild(link); } button.innerHTML = originalText; button.disabled = false; }
    </script>
</body>
</html>
