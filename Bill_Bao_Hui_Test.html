<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill B√°o H·ª•i - Ch√∫c M·ª´ng Xu√¢n ·∫§t T·ªµ 2025</title>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @page { size: A3 landscape; margin: 1.6cm; }
        body { 
            font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; 
            background-color: #fffaf0; 
            margin: 0; 
            padding: 20px; 
            background-image: 
                radial-gradient(circle at 15% 15%, rgba(255,215,0,0.07) 0%, transparent 30%);
        }

        /* === Khung vi·ªÅn T·∫øt gi·ªëng bill th·ª© 2 === */
        .bill-page {
            position: relative;
            background-color: white;
            max-width: 1250px;
            min-width: 1250px;
            margin: 35px auto;
            padding: 50px 45px;
            border: 16px solid transparent;
            border-image: url('https://img.freepik.com/premium-vector/chinese-new-year-border-red-gold-pattern-with-flowers_788759-148.jpg') 40 round;
            border-image-slice: 40;
            border-radius: 12px;
            box-shadow: 
                0 10px 35px rgba(180, 30, 0, 0.2),
                inset 0 0 25px rgba(255, 215, 0, 0.1);
            overflow: hidden;
        }

        /* 4 g√≥c hoa mai & hoa ƒë√†o - gi·ªëng phong c√°ch bill th·ª© 2 */
        .corner {
            position: absolute;
            width: 240px;
            height: 240px;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 0;
            pointer-events: none;
            opacity: 0.9;
        }

        .top-left     { top: -70px; left: -55px; background-image: url('https://img.freepik.com/free-psd/yellow-apricot-flower-branch-isolated_1150-26977.jpg'); transform: rotate(-12deg); }
        .top-right    { top: -65px; right: -50px; background-image: url('https://img.freepik.com/free-psd/peach-blossom-branch-isolated_1150-26980.jpg'); transform: rotate(10deg); }
        .bottom-left  { bottom: -75px; left: -55px; background-image: url('https://img.freepik.com/free-psd/yellow-apricot-flower-branch-isolated_1150-26977.jpg'); transform: rotate(14deg); }
        .bottom-right { bottom: -70px; right: -50px; background-image: url('https://img.freepik.com/free-psd/peach-blossom-branch-isolated_1150-26980.jpg'); transform: rotate(-11deg); }

        /* Header v·ªõi d√≤ng ch√∫c m·ª´ng T·∫øt */
        .bill-header {
            position: relative;
            min-height: 240px;
            margin-bottom: 30px;
            padding: 20px;
            border-bottom: 5px double #a00000;
            background: linear-gradient(to bottom, rgba(255,245,238,0.75), rgba(255,235,205,0.5));
            border-radius: 10px 10px 0 0;
        }

        .header-title-date h2 {
            margin: 15px 0 8px;
            font-size: 44pt;
            color: #a00000;
            text-shadow: 3px 3px 0 #ffd700, 5px 5px 8px rgba(160,0,0,0.3);
            font-weight: 900;
            letter-spacing: 4px;
            text-align: center;
        }

        .header-title-date::before {
            content: "CH√öC M·ª™NG NƒÇM M·ªöI - PH√ÅT T√ÄI PH√ÅT L·ªòC";
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20pt;
            color: #d4a017;
            text-shadow: 0 0 10px #c41e3a;
            font-weight: bold;
            letter-spacing: 2.5px;
            white-space: nowrap;
        }

        /* C√°c style c√≤n l·∫°i gi·ªØ nguy√™n */
        .info-panel { 
            max-width: 900px; margin: 0 auto 25px auto; padding: 20px; 
            background: white; border-radius: 10px; box-shadow: 0 3px 12px rgba(0,0,0,0.1); 
            text-align: center; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; 
        }
        .info-panel h1 { width: 100%; margin: 0 0 15px 0; color: #a00000; }

        .dashboard-panel {
            max-width: 1200px; margin: 0 auto 25px auto; padding: 20px;
            background: white; border: 2px solid #ddd; border-radius: 10px;
            color: #333; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .text-red   { color: #c41e3a !important; }
        .text-green { color: #006400 !important; }

        table { width: 100%; border-collapse: collapse; margin-top: 12px; color: #000; }
        th, td { border: 1px solid #555; padding: 6px 8px; vertical-align: middle; }
        th { background-color: #fff0e8; font-weight: bold; text-transform: uppercase; }
        .highlight { background-color: #fff2cc !important; }

        .footer-banner {
            padding: 12px 0;
            text-align: center;
            font-size: 22pt;
            color: white;
            background: linear-gradient(90deg, #a00000, #c41e3a, #a00000);
            border-radius: 10px;
            margin-bottom: 15px;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.7);
            font-weight: bold;
        }

        .download-btn { background-color: #c41e3a; }
        .copy-btn     { background-color: #d2691e; }
        .share-btn    { background-color: #006400; }

        .qr-code { width: 200px; height: 200px; position: absolute; right: 0; top: 0; background: white; padding: 8px; border: 2px solid #ffd700; border-radius: 8px; }

        @media print {
            body { background: white !important; padding: 0; margin: 0; }
            .bill-page {
                border-image: none;
                border: 4px double #c41e3a;
                box-shadow: none;
                margin: 0;
                padding: 35px;
            }
            .corner, .header-title-date::before { display: none !important; }
            .info-panel, .bill-controls, .dashboard-panel { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="info-panel" class="info-panel">
        <h1 id="status-message">ƒêang t·∫£i v√† t·∫°o bill... Ch√∫c m·ª´ng nƒÉm m·ªõi! üéâüßß</h1>
        <button id="download-zip-btn" style="display: none; background-color: #c41e3a;">üíæ T·∫£i t·∫•t c·∫£ Bill T·∫øt (ZIP)</button>
    </div>

    <div id="dashboard-panel" class="dashboard-panel">
        <div class="dashboard-title">B·∫¢NG T·ªîNG H·ª¢P NHANH - XU√ÇN ·∫§T T·ª¥</div>
        <div class="dashboard-grid">
            <div class="dashboard-col" style="border-bottom: 4px solid #006400;">
                <div class="label-text">T·ªîNG PH·∫¢I GIAO (Bill H·ªët):</div>
                <div id="total-payable" class="total-box text-green">0</div>
                <button id="copy-payable-btn" style="background-color: #006400; color: white; border: none; padding: 8px 15px; font-weight: bold; border-radius: 4px; margin-top: 10px; cursor: pointer;">üìã Copy danh s√°ch giao</button>
            </div>
            <div class="dashboard-col" style="border-bottom: 4px solid #c41e3a;">
                <div class="label-text">T·ªîNG PH·∫¢I THU (Bill ƒê√≥ng):</div>
                <div id="total-receivable" class="total-box text-red">0</div>
                <button id="copy-summary-btn" style="background-color: #c41e3a; color: white; border: none; padding: 8px 15px; font-weight: bold; border-radius: 4px; margin-top: 10px; cursor: pointer;">üìã Copy danh s√°ch thu</button>
            </div>
        </div>
    </div>
   
    <div id="bills-container"></div>

    <template id="bill-template">
        <div class="bill-page">
            <!-- 4 g√≥c hoa trang tr√≠ -->
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>

            <div class="bill-controls">
                <button class="download-btn">T·∫£i Bill</button>
                <button class="copy-btn">Copy Bill</button>
                <button class="share-btn">G·ª≠i Bill</button>
            </div>
           
            <div class="bill-header">
                <div class="header-left">
                    <p>Ch·ªß h·ª•i: <span data-field="chu_hui"></span></p>
                    <p>SƒêT: <span data-field="sdt"></span></p>
                    <p>ƒê·ªãa ch·ªâ: <span data-field="dia_chi"></span></p>
                    <p data-field="bank_info"></p>
                </div>
                <div class="header-title-date">
                    <h2>BILL B√ÅO H·ª§I</h2>
                    <p>Ng√†y: <span data-field="ngay_tao_bill"></span></p>
                </div>
                <div class="qr-code" data-field="qr_container"></div>
            </div>

            <table class="summary-table text-center">
                <thead><tr><th class="highlight" data-field="summary_title_hui_vien"></th><th class="highlight" data-field="summary_title_hui_chet"></th><th class="highlight" data-field="summary_title_hui_song"></th><th class="highlight">√Çm/D∆∞∆°ng *</th><th class="highlight">L·ª£i Nhu·∫≠n</th></tr></thead>
                <tbody><tr><td class="font-bold" data-field="hoi_vien"></td><td data-field="tong_hui_chet"></td><td data-field="tong_hui_song"></td><td class="font-bold" data-field="am_duong"></td><td class="font-bold" data-field="loi_nhuan"></td></tr></tbody>
            </table>
           
            <table class="details-table text-center">
                <thead><tr><th style="width: 4%;">STT</th><th>D√¢y H·ª•i</th><th>K·ª≥</th><th>Khui</th><th>S·ªêNG</th><th>CH·∫æT</th><th>Ti·ªÅn H·ªët</th><th>Ti·ªÅn ƒê√≥ng</th><th>ThƒÉm</th><th>Th·∫£o</th><th>ƒê√∫p</th></tr></thead>
                <tbody data-field="details_tbody"></tbody>
            </table>

            <div class="footer-container">
                <div class="footer-left">
                    <div class="footer-banner" data-field="footer_banner"></div>
                    <span data-field="footer_hoi_vien"></span>
                    <div class="footer-notes">
                        <p data-field="ghi_chu_1"></p>
                        <p data-field="ghi_chu_2"></p>
                    </div>
                </div>
                <div class="footer-right">
                    <table class="totals-table no-border">
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn ƒê√≥ng:</td><td class="text-right font-large font-bold" data-field="bill_tong_dong"></td><td style="width: 25px;" class="text-center">(1)</td><td class="text-blue font-bold" data-field="tong_tham"></td></tr>
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn H·ªët:</td><td class="text-right font-large font-bold" data-field="bill_tong_hot"></td><td class="text-center">(2)</td><td class="text-blue font-bold" data-field="tong_thao"></td></tr>
                        <tr><td class="font-bold" data-field="final_text_label"></td><td class="text-right font-xlarge font-bold text-red" data-field="final_amount"></td><td class="text-center font-bold"></td><td class="text-center font-bold" data-field="final_formula_text"></td></tr>
                    </table>
                </div>
            </div>
        </div>
    </template>

    <!-- Ph·∫ßn script gi·ªØ nguy√™n 100% nh∆∞ code g·ªëc c·ªßa b·∫°n -->
    <script>
        // --- 1. B·ªò X·ª¨ L√ù VIETQR CHU·∫®N (B·∫¢N TRUNG T√çNH) ---
        const VietQR = {
            cleanText: function(str) {
                if (!str) return "";
                return str.normalize('NFD')
                          .replace(/[\u0300-\u036f]/g, '')
                          .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D')
                          .replace(/[^a-zA-Z0-9 ]/g, '')
                          .trim();
            },
            crc16: function(data) {
                let crc = 0xFFFF;
                for (let i = 0; i < data.length; i++) {
                    crc ^= data.charCodeAt(i) << 8;
                    for (let j = 0; j < 8; j++) {
                        if ((crc & 0x8000) != 0) crc = (crc << 1) ^ 0x1021;
                        else crc = crc << 1;
                    }
                    crc = crc & 0xFFFF;
                }
                let hex = crc.toString(16).toUpperCase();
                return "0000".substring(0, 4 - hex.length) + hex;
            },
            generatePayload: function(bankBin, bankNumber, amount, content) {
                const field = (id, value) => {
                    const valStr = String(value);
                    const len = valStr.length;
                    return id + (len < 10 ? "0" + len : len) + valStr;
                };
                const cleanBin = String(bankBin).replace(/\D/g, '');
                const cleanAccount = String(bankNumber).replace(/[^a-zA-Z0-9]/g, '');
               
                if (cleanBin.length < 4 || cleanAccount.length < 1) return null;
                const merchantInfo = field("00", "A000000727") +
                                     field("01", field("00", cleanBin) + field("01", cleanAccount)) +
                                     field("02", "QRIBFTTA");
                let qrStr = field("00", "01") + field("01", "12") + field("38", merchantInfo) + field("53", "704");
               
                if (amount) {
                    const cleanAmount = String(amount).replace(/\D/g, '');
                    if (parseInt(cleanAmount) > 0) qrStr += field("54", cleanAmount);
                }
               
                qrStr += field("58", "VN");
                if (content) {
                    const safeContent = this.cleanText(content);
                    if (safeContent.length > 0) qrStr += field("62", field("08", safeContent));
                }
                qrStr += "6304";
                qrStr += this.crc16(qrStr);
                return qrStr;
            },
            parseRawData: function(rawString) {
                if (!rawString) return null;
                while (rawString.startsWith('|')) { rawString = rawString.substring(1); }
                const parts = rawString.split('|');
                if (parts.length >= 2) {
                    return this.generatePayload(parts[0].trim(), parts[1].trim(), parts[2] || "0", parts[3] || "");
                }
                return null;
            }
        };

        let globalSummaryTextReceivable = "";
        let globalSummaryTextPayable = "";

        window.onload = function() {
            const infoPanel = document.getElementById('info-panel');
            const statusMessage = document.getElementById('status-message');
            const downloadZipBtn = document.getElementById('download-zip-btn');
            infoPanel.style.display = 'block';
            if (typeof QRCode === 'undefined') { statusMessage.textContent = 'L·ªói: Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán QRCode.js'; return; }
            try {
                const encodedData = window.location.hash.substring(1);
                if (!encodedData) { statusMessage.textContent = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.'; return; }
                const jsonData = decodeURIComponent(encodedData);
                generateBills(jsonData);
                statusMessage.style.display = 'none';
                downloadZipBtn.style.display = 'inline-block';
                downloadZipBtn.addEventListener('click', downloadAllAsZip);
            } catch (error) { statusMessage.textContent = 'L·ªói d·ªØ li·ªáu bill.'; console.error(error); }
        };

        function formatCurrency(num) { 
            if (typeof num !== 'number' || num === null) return '0'; 
            return num.toLocaleString('vi-VN'); 
        }

        function generateBills(jsonInput) {
            const billsContainer = document.getElementById('bills-container');
            billsContainer.innerHTML = '';
            const data = JSON.parse(jsonInput);
            const billTemplate = document.getElementById('bill-template');
           
            let grandTotalReceivable = 0;
            let grandTotalPayable = 0;
            let summaryTextReceivable = "DANH S√ÅCH PH·∫¢I THU (BILL ƒê√ìNG):\n";
            let summaryTextPayable = "DANH S√ÅCH PH·∫¢I GIAO (BILL H·ªêT):\n";
           
            data.forEach((kh, index) => {
                const billNode = document.importNode(billTemplate.content, true);
                const q = (selector) => billNode.querySelector(selector);
               
                q('[data-field="chu_hui"]').textContent = kh.chu_hui || '';
                q('[data-field="sdt"]').textContent = kh.sdt || '';
                q('[data-field="bank_info"]').textContent = kh.bank_info || '';
                q('[data-field="ngay_tao_bill"]').textContent = kh.ngay_tao_bill || '';
                q('[data-field="dia_chi"]').textContent = kh.dia_chi || '';
                q('[data-field="ghi_chu_1"]').textContent = kh.ghi_chu_1 || '';
                q('[data-field="ghi_chu_2"]').textContent = kh.ghi_chu_2 || '';
                q('[data-field="summary_title_hui_vien"]').textContent = `H·ª•i Vi√™n | ${kh.tong_so_day || 0} D√¢y, ${kh.tong_so_chan || 0} C`;
                q('[data-field="summary_title_hui_chet"]').textContent = `H·ª•i Ch·∫øt | ${kh.tong_so_chan_chet || 0} C`;
                q('[data-field="summary_title_hui_song"]').textContent = `H·ª•i S·ªëng | ${kh.tong_so_chan_song || 0} C`;
                q('[data-field="hoi_vien"]').textContent = kh.hoi_vien || '';
                q('[data-field="tong_hui_chet"]').textContent = formatCurrency(kh.tong_hui_chet);
                q('[data-field="tong_hui_song"]').textContent = formatCurrency(kh.tong_hui_song);
               
                const amDuongCell = q('[data-field="am_duong"]');
                const amDuongValue = kh.am_duong || 0;
                amDuongCell.textContent = formatCurrency(amDuongValue);
                if (amDuongValue > 0) amDuongCell.classList.add('text-green');
                else if (amDuongValue < 0) amDuongCell.classList.add('text-red');
               
                const loiNhuanCell = q('[data-field="loi_nhuan"]');
                const loiNhuanValue = kh.loi_nhuan || 0;
                loiNhuanCell.textContent = formatCurrency(loiNhuanValue);
                if (loiNhuanValue > 0) loiNhuanCell.classList.add('text-green');
                else if (loiNhuanValue < 0) loiNhuanCell.classList.add('text-red');
               
                const detailsBody = q('[data-field="details_tbody"]');
                const allDetails = [].concat(kh.chan_hui_details || []).concat(kh.hui_1_1_details || []).concat(kh.ghi_no_details || []).concat(kh.tien_gop_details || []);
               
                if (allDetails.length > 0) {
                    let sttCounter = 1;
                    allDetails.forEach(d => {
                        const row = document.createElement('tr');
                        if ((d.khui || '').toLowerCase().includes('n·ª£')) {
                            row.style.backgroundColor = '#fff0f0';
                            row.innerHTML = `<td colspan="8" style="text-align: left; font-weight: bold;">${d.khui}</td><td class="font-bold">${formatCurrency(d.tien_dong)}</td><td colspan="3"></td>`;
                        } else {
                            row.innerHTML = `<td>${sttCounter}</td><td>${d.day_hui || ''}</td><td>${d.ky || ''}</td><td class="font-bold text-red">${d.khui || ''}</td><td>${d.song || 0}</td><td>${d.chet || 0}</td><td>${formatCurrency(d.tien_hot)}</td><td>${formatCurrency(d.tien_dong)}</td><td class="font-bold text-red">${formatCurrency(d.tham)}</td><td>${formatCurrency(d.thao)}</td><td>${d.dup || 0}</td>`;
                            sttCounter++;
                        }
                        detailsBody.appendChild(row);
                    });
                }
               
                q('[data-field="footer_hoi_vien"]').textContent = kh.hoi_vien || '';
                q('[data-field="bill_tong_dong"]').textContent = formatCurrency(kh.bill_tong_dong);
                q('[data-field="bill_tong_hot"]').textContent = formatCurrency(kh.bill_tong_hot);
                q('[data-field="tong_tham"]').textContent = `T·ªïng ThƒÉm: ${formatCurrency(kh.tong_tham)}`;
                q('[data-field="tong_thao"]').textContent = `T·ªïng Th·∫£o: ${formatCurrency(kh.tong_thao)}`;
               
                const banner = q('[data-field="footer_banner"]');
                const tongDong = kh.bill_tong_dong || 0;
                const tongHot = kh.bill_tong_hot || 0;
                const qrContainer = q('[data-field="qr_container"]');
                qrContainer.innerHTML = "";
                if (tongDong > tongHot) {
                    banner.textContent = 'Ch·ªß H·ª•i ph·∫£i thu ti·ªÅn H·ª•i Vi√™n';
                    q('[data-field="final_text_label"]').textContent = 'Ph·∫£i ƒê√≥ng:';
                    const amount = tongDong - tongHot;
                    q('[data-field="final_amount"]').textContent = formatCurrency(amount);
                    q('[data-field="final_formula_text"]').textContent = '=(1)-(2)';
                   
                    const qrRawData = kh.qr_bill_url;
                    if (qrRawData) {
                        const qrPayload = VietQR.parseRawData(qrRawData);
                        if (qrPayload) {
                            new QRCode(qrContainer, { text: qrPayload, width: 170, height: 170, correctLevel: QRCode.CorrectLevel.L });
                        } else {
                            qrContainer.innerHTML = "<div style='color:red;font-size:12px;text-align:center;padding-top:60px;font-weight:bold'>L·ªói: Thi·∫øu BIN<br>ho·∫∑c STK</div>";
                        }
                    }
                    grandTotalReceivable += amount;
                    summaryTextReceivable += `${index+1}. ${kh.hoi_vien}: ${formatCurrency(amount)}\n`;
                } else {
                    banner.textContent = 'H·ª•i Vi√™n ƒë∆∞·ª£c nh·∫≠n ti·ªÅn';
                    q('[data-field="final_text_label"]').textContent = 'ƒê∆∞·ª£c Nh·∫≠n:';
                    const amountPayable = tongHot - tongDong;
                    q('[data-field="final_amount"]').textContent = formatCurrency(amountPayable);
                    q('[data-field="final_formula_text"]').textContent = '=(2)-(1)';
                    qrContainer.style.display = 'none';
                    grandTotalPayable += amountPayable;
                    summaryTextPayable += `${index+1}. ${kh.hoi_vien}: ${formatCurrency(amountPayable)}\n`;
                }
               
                const billElement = billNode.querySelector('.bill-page');
                billElement.dataset.sdt = kh.sdt_kh || '';
                billElement.dataset.hoivien = kh.hoi_vien || 'bill';
               
                billNode.querySelector('.download-btn').addEventListener('click', () => downloadBillAsImage(billElement));
                billNode.querySelector('.copy-btn').addEventListener('click', () => copyBillAsImage(billElement));
                billNode.querySelector('.share-btn').addEventListener('click', () => shareBillAsImage(billElement));
                billsContainer.appendChild(billNode);
            });

            if (grandTotalReceivable > 0 || grandTotalPayable > 0) {
                document.getElementById('dashboard-panel').style.display = 'block';
               
                document.getElementById('total-receivable').textContent = formatCurrency(grandTotalReceivable);
                summaryTextReceivable += `--------------------\nT·ªîNG C·ªòNG THU: ${formatCurrency(grandTotalReceivable)}`;
                globalSummaryTextReceivable = summaryTextReceivable;
               
                document.getElementById('copy-summary-btn').onclick = function() {
                    navigator.clipboard.writeText(globalSummaryTextReceivable).then(() => alert('ƒê√£ copy danh s√°ch ph·∫£i THU!'));
                };

                document.getElementById('total-payable').textContent = formatCurrency(grandTotalPayable);
                summaryTextPayable += `--------------------\nT·ªîNG C·ªòNG GIAO: ${formatCurrency(grandTotalPayable)}`;
                globalSummaryTextPayable = summaryTextPayable;
                document.getElementById('copy-payable-btn').onclick = function() {
                    navigator.clipboard.writeText(globalSummaryTextPayable).then(() => alert('ƒê√£ copy danh s√°ch ph·∫£i GIAO!'));
                };
            }
        }
       
        function copyBillAsImage(element) {
            const c = element.querySelector('.bill-controls');
            c.style.display = 'none';
            html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => {
                canvas.toBlob(blob => {
                    try {
                        navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                            .then(() => alert('ƒê√£ copy ·∫£nh bill v√†o b·ªô nh·ªõ t·∫°m!'));
                    } catch (e) { alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£"); }
                });
                c.style.display = 'flex';
            }).catch(err => {
                console.error('L·ªói html2canvas:', err);
                c.style.display = 'flex';
            });
        }

        function downloadBillAsImage(element) {
            const sdt = element.dataset.sdt;
            const hoivien = element.dataset.hoivien;
            const filename = (sdt ? sdt : `Bill_${hoivien.replace(/\s+/g, '_')}`) + '.png';
            const c = element.querySelector('.bill-controls');
            c.style.display = 'none';
            html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL("image/png");
                link.click();
                c.style.display = 'flex';
            }).catch(err => {
                console.error(err);
                alert('L·ªói t·∫°o ·∫£nh.');
                c.style.display = 'flex';
            });
        }

        async function shareBillAsImage(element) {
            const sdt = element.dataset.sdt;
            const hoivien = element.dataset.hoivien;
            const filename = (sdt ? sdt : `Bill_${hoivien}`) + '.png';
            const shareBtn = element.querySelector('.share-btn');
            const originalText = shareBtn.textContent;
            shareBtn.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";
            shareBtn.disabled = true;
            const c = element.querySelector('.bill-controls');
            c.style.display = 'none';
            try {
                const tryShare = async (scale) => {
                    const canvas = await html2canvas(element, { scale: scale, useCORS: true, logging: false });
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    const file = new File([blob], filename, { type: 'image/png' });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({ files: [file] });
                    } else {
                        throw new Error('No Share API');
                    }
                };
                try { await tryShare(1.5); } catch (e) {
                    console.log("Th·ª≠ l·∫°i ch·∫•t l∆∞·ª£ng th·∫•p");
                    await tryShare(1.0);
                }
            } catch (error) {
                if(!error.message.includes('No Share API')) alert('L·ªói g·ª≠i bill. H√£y th·ª≠ T·∫£i Bill.');
                else alert('Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ chia s·∫ª file.');
            } finally {
                c.style.display = 'flex';
                shareBtn.textContent = originalText;
                shareBtn.disabled = false;
            }
        }

        async function downloadAllAsZip() {
            const bills = document.querySelectorAll('.bill-page');
            const total = bills.length;
            if (total === 0) { alert('Kh√¥ng c√≥ bill n√†o ƒë·ªÉ t·∫£i.'); return; }
            const button = document.getElementById('download-zip-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            const zip = new JSZip();
            let successCount = 0;
            for (let i = 0; i < total; i++) {
                const bill = bills[i];
                button.innerHTML = `‚è≥ ƒêang x·ª≠ l√Ω ${i + 1}/${total}...`;
                const controls = bill.querySelector('.bill-controls');
                if (controls) controls.style.display = 'none';
                try {
                    const capturePromise = html2canvas(bill, { scale: 1.5, useCORS: true, logging: false });
                    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 8000));
                    const canvas = await Promise.race([capturePromise, timeoutPromise]);
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    const sdt = bill.dataset.sdt;
                    const hoivien = bill.dataset.hoivien;
                    const fileName = (sdt ? sdt : `${hoivien.replace(/\s+/g, '_')}`) + '.png';
                    zip.file(fileName, blob);
                    successCount++;
                } catch (error) {
                    console.error(`L·ªói bill ${i}:`, error);
                } finally {
                    if (controls) controls.style.display = 'flex';
                }
                await new Promise(r => setTimeout(r, 100));
            }
            if (successCount > 0) {
                button.innerHTML = 'üì¶ ƒêang n√©n...';
                const content = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                const today = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
                link.download = `Tat_ca_bill_Tet_${today}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            button.innerHTML = originalText;
            button.disabled = false;
        }
    </script>
</body>
</html>
