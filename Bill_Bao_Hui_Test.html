<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill B√°o H·ª•i - T·∫øt Edition (No Image Error)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        @page { size: A3 landscape; margin: 1.5cm; }
        body { font-family: 'Roboto', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        
        .info-panel { max-width: 900px; margin: 0 auto 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        
        /* --- CSS BILL T·∫æT --- */
        .bill-page { 
            background-color: #fffdf0; /* N·ªÅn kem v√†ng */
            max-width: 1200px; min-width: 1200px; 
            margin: 20px auto; padding: 25px; 
            /* Vi·ªÅn ƒë·ªè v√† v√†ng kim */
            border: 3px solid #b71c1c; 
            outline: 2px solid #ffd700;
            outline-offset: -8px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(183, 28, 28, 0.2); 
            position: relative; 
            font-family: Arial, sans-serif; font-size: 16pt; 
            overflow: hidden;
        }

        /* H·ªåA TI·∫æT 4 G√ìC (D√πng SVG Class ƒë·ªÉ ƒë·ªãnh v·ªã) */
        .tet-corner-svg {
            position: absolute;
            width: 160px;
            height: 160px;
            z-index: 0;
            pointer-events: none;
            opacity: 0.95;
        }
        .tl { top: 0; left: 0; }
        .tr { top: 0; right: 0; transform: scaleX(-1); }
        .bl { bottom: 0; left: 0; transform: scaleY(-1); }
        .br { bottom: 0; right: 0; transform: rotate(180deg); }

        .bill-controls { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 10px; z-index: 100; }
        .bill-controls button { padding: 5px 10px; font-size: 12px; cursor: pointer; color: white; border: none; border-radius: 4px; font-weight: bold; }
        
        /* HEADER */
        .bill-header { position: relative; min-height: 210px; border-bottom: 2px solid #b71c1c; margin-bottom: 15px; z-index: 1; }
        .header-left { position: absolute; left: 0; top: 15px; font-weight: bold; font-size: 14pt; line-height: 1.5; max-width: 30%; color: #b71c1c; }
        
        /* Ti√™u ƒë·ªÅ Bill c√°ch ƒëi·ªáu T·∫øt */
        .header-title-date { position: absolute; left: 50%; top: 50px; transform: translateX(-50%); text-align: center; width: 60%; }
        .header-title-date h2 { 
            margin: 5px 0 0 0; font-size: 32pt; 
            color: #d32f2f; 
            text-transform: uppercase; 
            text-shadow: 2px 2px 0px #ffecb3; /* B√≥ng ch·ªØ v√†ng */
            letter-spacing: 2px;
        }
        
        .qr-code { width: 170px; height: 170px; position: absolute; right: 0; top: 0; background-color: white; padding: 5px; border: 2px solid #b71c1c; }
        
        /* B·∫¢NG D·ªÆ LI·ªÜU */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #000; position: relative; z-index: 1; }
        th, td { border: 1px solid #d32f2f; padding: 4px 6px; vertical-align: middle; }
        
        /* HEADER B·∫¢NG: Hi·ªáu ·ª©ng Gradient ƒê·ªè - V√†ng */
        th { 
            background: linear-gradient(180deg, #e53935 0%, #b71c1c 100%);
            color: #fff; /* Ch·ªØ tr·∫Øng */
            font-weight: bold; 
            text-transform: uppercase; 
            border-color: #ef9a9a;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
        }
        
        /* Header b·∫£ng t·ªïng h·ª£p d√πng m√†u V√†ng Kim */
        .summary-table th { 
            background: linear-gradient(180deg, #fdd835 0%, #f9a825 100%);
            color: #b71c1c; /* Ch·ªØ ƒë·ªè */
            text-shadow: none;
            border-color: #fbc02d;
        }
        
        .highlight { background-color: #fffde7; } 

        /* FOOTER */
        .footer-banner { padding: 5px; text-align: left; font-size: 14pt; color: white; margin-bottom: 5px; border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .footer-container { display: flex; align-items: flex-start; gap: 10px; position: relative; z-index: 1;}
        .footer-left { width: 40%; font-size: 18pt; font-weight: bold; text-align: center; color: #b71c1c; }
        .footer-right { width: 60%; }
        .totals-table td { padding: 5px 7px; font-size: 16pt; }
        
        /* Utility */
        .text-center { text-align: center; } .text-right { text-align: right; } .no-border, .no-border td { border: none; }
        .font-bold { font-weight: bold; } .font-large { font-size: 14pt; } .font-xlarge { font-size: 16pt; }
        .text-red { color: #d90000; } .text-green { color: #00b050; } .text-blue { color: #0068ff; }

        .zalo-btn { background-color: #0068ff; }
        .download-btn { background-color: #d32f2f; }
        .copy-btn { background-color: #fbc02d; color: black; }

        @media print {
            .info-panel, .bill-controls { display: none !important; }
            .bill-page { border: none; margin: 0; width: 100%; box-shadow: none; }
        }
    </style>
</head>
<body>

    <div id="info-panel" class="info-panel">
        <h1 style="color:#b71c1c;">üßß BILL T·∫æT (KH·∫ÆC PH·ª§C L·ªñI ·∫¢NH) üßß</h1>
        <button id="download-zip-btn" style="display: none; background-color: #d32f2f;">üíæ T·∫£i ZIP</button>
    </div>
    
    <div id="bills-container"></div>

    <template id="bill-template">
         <div class="bill-page">
            <svg class="tet-corner-svg tl" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0 L150 0 C100 20 20 100 0 150 Z" fill="#b71c1c" opacity="0.1"/>
                <path d="M-10 -10 Q50 50 120 40 Q160 30 180 60" stroke="#5d4037" stroke-width="3" fill="none"/>
                <path d="M50 50 Q60 90 90 110" stroke="#5d4037" stroke-width="2" fill="none"/>
                <circle cx="120" cy="40" r="15" fill="#fdd835" stroke="#fbc02d" stroke-width="2"/>
                <circle cx="120" cy="40" r="5" fill="#fff59d"/>
                <circle cx="180" cy="60" r="12" fill="#fdd835" stroke="#fbc02d" stroke-width="2"/>
                <circle cx="90" cy="110" r="10" fill="#fdd835" stroke="#fbc02d" stroke-width="2"/>
                <circle cx="60" cy="20" r="4" fill="#d32f2f"/>
                <circle cx="140" cy="80" r="4" fill="#d32f2f"/>
            </svg>

            <svg class="tet-corner-svg tr" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><use href=".tl use"></use>
                 <path d="M-10 -10 Q50 50 120 40 Q160 30 180 60" stroke="#5d4037" stroke-width="3" fill="none"/>
                 <circle cx="120" cy="40" r="15" fill="#fdd835" stroke="#fbc02d" stroke-width="2"/>
                 <circle cx="180" cy="60" r="12" fill="#fdd835" stroke="#fbc02d" stroke-width="2"/>
            </svg>
            <svg class="tet-corner-svg bl" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><use href=".tl use"></use>
                 <path d="M-10 -10 Q50 50 120 40 Q160 30 180 60" stroke="#5d4037" stroke-width="3" fill="none"/>
                 <circle cx="120" cy="40" r="15" fill="#fdd835" stroke="#fbc02d" stroke-width="2"/>
            </svg>
            <svg class="tet-corner-svg br" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><use href=".tl use"></use>
                 <path d="M-10 -10 Q50 50 120 40 Q160 30 180 60" stroke="#5d4037" stroke-width="3" fill="none"/>
                 <circle cx="120" cy="40" r="15" fill="#fdd835" stroke="#fbc02d" stroke-width="2"/>
                 <circle cx="90" cy="110" r="10" fill="#fdd835" stroke="#fbc02d" stroke-width="2"/>
            </svg>

            <div class="bill-controls">
                <button class="zalo-btn">G·ª≠i Zalo</button>
                <button class="download-btn">T·∫£i Bill</button>
                <button class="copy-btn">Copy Bill</button>
            </div>
            
            <div class="bill-header">
                <div class="header-left">
                    <p>Ch·ªß h·ª•i: <span data-field="chu_hui"></span></p>
                    <p>SƒêT: <span data-field="sdt"></span></p>
                    <p>ƒê·ªãa ch·ªâ: <span data-field="dia_chi"></span></p>
                    <p data-field="bank_info"></p>
                </div>
                <div class="header-title-date">
                    <h2>BILL B√ÅO H·ª§I</h2>
                    <p style="margin: 5px 0 0 0; color: #b71c1c; font-weight: bold;">Ng√†y: <span data-field="ngay_tao_bill"></span></p>
                </div>
                <div class="qr-code" data-field="qr_container"></div>
            </div>

            <table class="summary-table text-center">
                <thead><tr><th data-field="summary_title_hui_vien"></th><th data-field="summary_title_hui_chet"></th><th data-field="summary_title_hui_song"></th><th>√Çm/D∆∞∆°ng *</th><th>L·ª£i Nhu·∫≠n</th></tr></thead>
                <tbody><tr><td class="font-bold highlight" data-field="hoi_vien"></td><td class="highlight" data-field="tong_hui_chet"></td><td class="highlight" data-field="tong_hui_song"></td><td class="font-bold highlight" data-field="am_duong"></td><td class="font-bold highlight" data-field="loi_nhuan"></td></tr></tbody>
            </table>
            
            <table class="details-table text-center">
                <thead><tr><th style="width: 4%;">STT</th><th>Ng√†y</th><th>D√¢y H·ª•i</th><th>K·ª≥</th><th>Khui</th><th>S</th><th>C</th><th>Ti·ªÅn H·ªët</th><th>Ti·ªÅn ƒê√≥ng</th><th>ThƒÉm</th><th>Th·∫£o</th><th>ƒê√∫p</th></tr></thead>
                <tbody data-field="details_tbody"></tbody>
            </table>

            <div class="footer-container">
                <div class="footer-left">
                    <div class="footer-banner" data-field="footer_banner"></div>
                    <span data-field="footer_hoi_vien" style="color: #b71c1c;"></span>
                    <div style="font-size: 14pt; margin-top: 10px; color: #d32f2f; font-weight: bold;">
                        <p>üå∏ Ch√∫c M·ª´ng NƒÉm M·ªõi - V·∫°n S·ª± Nh∆∞ √ù üå∏</p>
                        <p data-field="ghi_chu_1"></p>
                        <p data-field="ghi_chu_2"></p>
                    </div>
                </div>
                <div class="footer-right">
                    <table class="totals-table no-border">
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn ƒê√≥ng:</td><td class="text-right font-large font-bold" data-field="bill_tong_dong"></td><td style="width: 25px;" class="text-center">(1)</td><td class="text-blue font-bold" data-field="tong_tham"></td></tr>
                        <tr><td class="font-bold">T·ªïng Ti·ªÅn H·ªët:</td><td class="text-right font-large font-bold" data-field="bill_tong_hot"></td><td class="text-center">(2)</td><td class="text-blue font-bold" data-field="tong_thao"></td></tr>
                        <tr><td class="font-bold" data-field="final_text_label"></td><td class="text-right font-xlarge font-bold text-red" data-field="final_amount"></td><td class="text-center font-bold"></td><td class="text-center font-bold" data-field="final_formula_text"></td></tr>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <script>
        // D·ªÆ LI·ªÜU M·∫™U ƒê·ªÇ TEST
        const SAMPLE_DATA = [{
            "chu_hui": "Ch·ªã T∆∞ H·ª•i", "sdt": "0909.123.456", "dia_chi": "Ch·ª£ L·ªõn", "bank_info": "VCB: 9999", "ngay_tao_bill": "15/01/2026",
            "hoi_vien": "Nguy·ªÖn Th·ªã M∆∞·ªùi", "tong_so_day": 3, "tong_so_chan": 5, "tong_so_chan_chet": 2, "tong_so_chan_song": 3,
            "tong_hui_chet": 10000000, "tong_hui_song": 5000000, "am_duong": -5000000, "loi_nhuan": 200000,
            "bill_tong_dong": 15200000, "bill_tong_hot": 0, "tong_tham": 200000, "tong_thao": 0, "ghi_chu_1": "ƒê√≥ng tr∆∞·ªõc 20 T·∫øt",
            "chan_hui_details": [
                { "ngay_mo": "01/01", "day_hui": "D√¢y 2tr", "ky": "1/10", "khui": "N·ªü", "song": 1, "chet": 0, "tien_hot": 0, "tien_dong": 2000000, "tham": 0, "thao": 0 },
                { "ngay_mo": "05/01", "day_hui": "D√¢y 5tr", "ky": "5/12", "khui": "Lan", "song": 0, "chet": 1, "tien_hot": 0, "tien_dong": 5200000, "tham": 200000, "thao": 0 }
            ]
        }];

        const VietQR = {
            cleanText: function(str) { if (!str) return ""; return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D').replace(/[^a-zA-Z0-9 ]/g, '').trim(); },
            crc16: function(data) { let crc = 0xFFFF; for (let i = 0; i < data.length; i++) { crc ^= data.charCodeAt(i) << 8; for (let j = 0; j < 8; j++) { if ((crc & 0x8000) != 0) crc = (crc << 1) ^ 0x1021; else crc = crc << 1; } crc = crc & 0xFFFF; } let hex = crc.toString(16).toUpperCase(); return "0000".substring(0, 4 - hex.length) + hex; },
            generatePayload: function(bankBin, bankNumber, amount, content) { const field = (id, value) => { const valStr = String(value); const len = valStr.length; return id + (len < 10 ? "0" + len : len) + valStr; }; const cleanBin = String(bankBin).replace(/\D/g, ''); const cleanAccount = String(bankNumber).replace(/[^a-zA-Z0-9]/g, ''); if (cleanBin.length < 4 || cleanAccount.length < 1) return null; const merchantInfo = field("00", "A000000727") + field("01", field("00", cleanBin) + field("01", cleanAccount)) + field("02", "QRIBFTTA"); let qrStr = field("00", "01") + field("01", "12") + field("38", merchantInfo) + field("53", "704"); if (amount) { const cleanAmount = String(amount).replace(/\D/g, ''); if (parseInt(cleanAmount) > 0) qrStr += field("54", cleanAmount); } qrStr += field("58", "VN"); if (content) { const safeContent = this.cleanText(content); if (safeContent.length > 0) qrStr += field("62", field("08", safeContent)); } qrStr += "6304"; qrStr += this.crc16(qrStr); return qrStr; },
            parseRawData: function(rawString) { if (!rawString) return null; while (rawString.startsWith('|')) { rawString = rawString.substring(1); } const parts = rawString.split('|'); if (parts.length >= 2) { return this.generatePayload(parts[0].trim(), parts[1].trim(), parts[2] || "0", parts[3] || ""); } return null; }
        };

        window.onload = function() {
            const infoPanel = document.getElementById('info-panel');
            const downloadZipBtn = document.getElementById('download-zip-btn');
            infoPanel.style.display = 'block';
            
            try {
                const encodedData = window.location.hash.substring(1);
                if (encodedData) {
                    const jsonData = decodeURIComponent(encodedData);
                    generateBills(jsonData);
                    downloadZipBtn.style.display = 'inline-block';
                    downloadZipBtn.addEventListener('click', downloadAllAsZip);
                } else {
                    // generateBills(JSON.stringify(SAMPLE_DATA)); // Uncomment ƒë·ªÉ test local
                }
            } catch (error) { console.error(error); }
        };

        function formatCurrency(num) { if (typeof num !== 'number' || num === null) return '0'; return num.toLocaleString('vi-VN'); }

        function generateBills(jsonInput) {
            const billsContainer = document.getElementById('bills-container');
            billsContainer.innerHTML = '';
            const data = JSON.parse(jsonInput);
            const billTemplate = document.getElementById('bill-template');
            
            let grandTotalReceivable = 0; let grandTotalPayable = 0; 
            
            data.forEach((kh, index) => {
                const billNode = document.importNode(billTemplate.content, true);
                const q = (selector) => billNode.querySelector(selector);
                
                q('[data-field="chu_hui"]').textContent = kh.chu_hui || ''; 
                q('[data-field="sdt"]').textContent = kh.sdt || ''; 
                q('[data-field="bank_info"]').innerText = kh.bank_info || ''; 
                q('[data-field="ngay_tao_bill"]').textContent = kh.ngay_tao_bill || ''; 
                q('[data-field="dia_chi"]').textContent = kh.dia_chi || ''; 
                q('[data-field="ghi_chu_1"]').textContent = kh.ghi_chu_1 || ''; 
                q('[data-field="ghi_chu_2"]').textContent = kh.ghi_chu_2 || ''; 

                q('[data-field="summary_title_hui_vien"]').textContent = `H·ª•i Vi√™n | ${kh.tong_so_day || 0} D√¢y, ${kh.tong_so_chan || 0} C`; 
                q('[data-field="summary_title_hui_chet"]').textContent = `H·ª•i Ch·∫øt | ${kh.tong_so_chan_chet || 0} C`; 
                q('[data-field="summary_title_hui_song"]').textContent = `H·ª•i S·ªëng | ${kh.tong_so_chan_song || 0} C`;
                q('[data-field="hoi_vien"]').textContent = kh.hoi_vien || ''; 
                q('[data-field="tong_hui_chet"]').textContent = formatCurrency(kh.tong_hui_chet); 
                q('[data-field="tong_hui_song"]').textContent = formatCurrency(kh.tong_hui_song); 
                q('[data-field="am_duong"]').textContent = formatCurrency(kh.am_duong); 
                q('[data-field="loi_nhuan"]').textContent = formatCurrency(kh.loi_nhuan); 
                
                const detailsBody = q('[data-field="details_tbody"]');
                const allDetails = [].concat(kh.chan_hui_details || []).concat(kh.hui_1_1_details || []).concat(kh.ghi_no_details || []).concat(kh.tien_gop_details || []);
                
                if (allDetails.length > 0) {
                    let sttCounter = 1;
                    allDetails.forEach(d => {
                        const row = document.createElement('tr');
                        if ((d.khui || '').toLowerCase().includes('n·ª£')) row.style.backgroundColor = '#fff0f0';
                        row.innerHTML = `<td>${sttCounter}</td><td>${d.ngay_mo || ''}</td><td>${d.day_hui || ''}</td><td>${d.ky || ''}</td><td class="font-bold text-red">${d.khui || ''}</td><td>${d.song || 0}</td><td>${d.chet || 0}</td><td>${formatCurrency(d.tien_hot)}</td><td>${formatCurrency(d.tien_dong)}</td><td class="font-bold text-red">${formatCurrency(d.tham)}</td><td>${formatCurrency(d.thao)}</td><td>${d.dup || 0}</td>`;
                        sttCounter++;
                        detailsBody.appendChild(row);
                    });
                }
                
                q('[data-field="footer_hoi_vien"]').textContent = kh.hoi_vien || ''; 
                q('[data-field="bill_tong_dong"]').textContent = formatCurrency(kh.bill_tong_dong); 
                q('[data-field="bill_tong_hot"]').textContent = formatCurrency(kh.bill_tong_hot); 
                q('[data-field="tong_tham"]').textContent = `T·ªïng ThƒÉm: ${formatCurrency(kh.tong_tham)}`; 
                q('[data-field="tong_thao"]').textContent = `T·ªïng Th·∫£o: ${formatCurrency(kh.tong_thao)}`;
                
                const banner = q('[data-field="footer_banner"]'); 
                const tongDong = kh.bill_tong_dong || 0; 
                const tongHot = kh.bill_tong_hot || 0;
                const qrContainer = q('[data-field="qr_container"]');
                qrContainer.innerHTML = "";

                if (tongDong > tongHot) { 
                    banner.textContent = 'Ch·ªß H·ª•i ph·∫£i thu ti·ªÅn H·ª•i Vi√™n'; 
                    banner.style.backgroundColor = '#d32f2f'; 
                    q('[data-field="final_text_label"]').textContent = 'Ph·∫£i ƒê√≥ng:'; 
                    const amount = tongDong - tongHot;
                    q('[data-field="final_amount"]').textContent = formatCurrency(amount); 
                    q('[data-field="final_formula_text"]').textContent = '=(1)-(2)'; 
                    
                    const qrRawData = kh.qr_bill_url; 
                    if (qrRawData) {
                        const qrPayload = VietQR.parseRawData(qrRawData);
                        if (qrPayload) new QRCode(qrContainer, { text: qrPayload, width: 170, height: 170, correctLevel: QRCode.CorrectLevel.L });
                        else qrContainer.innerHTML = "<div style='color:red;font-size:12px;text-align:center;padding-top:60px;font-weight:bold'>L·ªói QR</div>"; 
                    }
                    grandTotalReceivable += amount;
                } else { 
                    banner.textContent = 'H·ª•i Vi√™n ƒë∆∞·ª£c nh·∫≠n ti·ªÅn'; 
                    banner.style.backgroundColor = '#00b050'; 
                    q('[data-field="final_text_label"]').textContent = 'ƒê∆∞·ª£c Nh·∫≠n:'; 
                    const amountPayable = tongHot - tongDong;
                    q('[data-field="final_amount"]').textContent = formatCurrency(amountPayable); 
                    q('[data-field="final_formula_text"]').textContent = '=(2)-(1)'; 
                    qrContainer.style.display = 'none';
                    grandTotalPayable += amountPayable;
                }
                
                const billElement = billNode.querySelector('.bill-page');
                billElement.dataset.sdt = kh.sdt_kh || ''; 
                billElement.dataset.hoivien = kh.hoi_vien || 'bill';
                
                billNode.querySelector('.download-btn').addEventListener('click', () => downloadBillAsImage(billElement));
                billNode.querySelector('.copy-btn').addEventListener('click', () => copyBillAsImage(billElement));
                billNode.querySelector('.zalo-btn').addEventListener('click', () => sendToZalo(billElement));
                
                billsContainer.appendChild(billNode);
            });
        }
        
        function sendToZalo(element) {
            let sdt = element.dataset.sdt;
            if (!sdt || sdt.length < 9) { alert("L·ªói: Kh√¥ng t√¨m th·∫•y s·ªë ƒëi·ªán tho·∫°i Zalo!"); return; }
            sdt = sdt.replace(/\D/g, ''); 
            const controls = element.querySelector('.bill-controls');
            controls.style.display = 'none'; 
            html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => {
                canvas.toBlob(blob => {
                    try {
                        const item = new ClipboardItem({ 'image/png': blob });
                        navigator.clipboard.write([item]).then(() => {
                            alert("ƒê√£ COPY ·∫¢NH! ƒêang m·ªü Zalo...\nB·∫°n ch·ªâ c·∫ßn b·∫•m Ctrl+V ƒë·ªÉ d√°n.");
                            window.open('https://zalo.me/' + sdt, '_blank');
                        }).catch(err => { alert("L·ªói copy ·∫£nh."); });
                    } catch (e) { alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£."); }
                });
                controls.style.display = 'flex'; 
            });
        }

        function copyBillAsImage(element) { const c = element.querySelector('.bill-controls'); c.style.display = 'none'; html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => { canvas.toBlob(blob => { try { window.focus(); navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).then(() => alert('ƒê√£ copy ·∫£nh bill!')).catch(err => { alert('L·ªói copy: ' + err); }); } catch (e) { alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£"); } }); c.style.display = 'flex'; }).catch(err => { console.error('L·ªói html2canvas:', err); c.style.display = 'flex'; }); }
        
        function downloadBillAsImage(element) { 
            const sdt = element.dataset.sdt; const hoivien = element.dataset.hoivien; 
            let nameForFile = (sdt && sdt.length > 5) ? sdt.trim().replace(/[^a-zA-Z0-9_]/g, '') : hoivien.trim().replace(/[^a-zA-Z0-9_]/g, '_');
            const filename = 'zalo_' + nameForFile + '.png'; 
            const c = element.querySelector('.bill-controls'); c.style.display = 'none'; html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => { const link = document.createElement('a'); link.download = filename; link.href = canvas.toDataURL("image/png"); link.click(); c.style.display = 'flex'; }).catch(err => { alert('L·ªói t·∫°o ·∫£nh.'); c.style.display = 'flex'; }); 
        }
        
        async function downloadAllAsZip() { 
            const bills = document.querySelectorAll('.bill-page'); const total = bills.length; if (total === 0) { alert('Kh√¥ng c√≥ bill n√†o.'); return; } 
            const button = document.getElementById('download-zip-btn'); button.innerHTML = `‚è≥ ƒêang x·ª≠ l√Ω...`; button.disabled = true; 
            const zip = new JSZip(); 
            for (let i = 0; i < total; i++) { 
                const bill = bills[i]; const controls = bill.querySelector('.bill-controls'); 
                if (controls) controls.style.display = 'none'; 
                try { 
                    const canvas = await html2canvas(bill, { scale: 1.5, useCORS: true }); 
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png')); 
                    const sdt = bill.dataset.sdt; const hoivien = bill.dataset.hoivien; 
                    let nameForFile = (sdt && sdt.length > 5) ? sdt.trim().replace(/[^a-zA-Z0-9_]/g, '') : hoivien.trim().replace(/[^a-zA-Z0-9_]/g, '_');
                    zip.file('zalo_' + nameForFile + '.png', blob); 
                } catch (error) { console.error(error); } 
                if (controls) controls.style.display = 'flex'; 
            } 
            const content = await zip.generateAsync({ type: "blob" }); 
            const link = document.createElement('a'); link.href = URL.createObjectURL(content); link.download = `Bill_Tet_2026.zip`; link.click(); 
            button.innerHTML = 'üíæ T·∫£i ZIP'; button.disabled = false; 
        }
    </script>
</body>
</html>
