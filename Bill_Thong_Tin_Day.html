function generateBill(data) {
    // Điền thông tin chung
    for (const key in data) {
        if (key !== 'danh_sach_chan') {
            const element = document.querySelector(`[data-field="${key}"]`);
            if (element) {
                element.textContent = data[key];
            }
        }
    }

    // Xử lý bảng chi tiết
    const tbody = document.getElementById('details-tbody');
    tbody.innerHTML = '';
    let lastPayoutDate = data.ngay_mo;
    let tongTham = 0;
    let tongTienHot = 0;

    // Tìm ngày hốt cuối cùng đã diễn ra
    if (data.danh_sach_chan) {
        data.danh_sach_chan.forEach(chan => {
            if (chan.status === 'C' && chan.ngay) {
                lastPayoutDate = chan.ngay;
            }
        });
    
        // Lặp qua danh sách để điền và tính toán
        data.danh_sach_chan.forEach((chan, index) => { // <-- Thêm 'index' ở đây
            const stt = index + 1; // <-- Tự động tạo STT
            const row = document.createElement('tr');
            let ngayHienThi = chan.ngay;

            if (chan.status === 'S') {
                ngayHienThi = addDays(lastPayoutDate, data.ky_han_so_ngay);
                lastPayoutDate = ngayHienThi;
            }
            
            const statusClass = chan.status === 'C' ? 'dead' : 'alive';
            const statusText = chan.status === 'C' ? 'X' : 'V';
            const ngayClass = chan.status === 'C' ? 'text-red' : '';
            
            row.innerHTML = `
                <td>${stt}</td>  // <-- Sử dụng STT vừa tạo
                <td style="text-align: left;">${chan.ten_hui_vien}</td>
                <td class="status-cell ${statusClass}">${statusText}</td>
                <td class="${ngayClass} font-bold">${ngayHienThi || ''}</td>
                <td>${chan.ky || ''}</td>
                <td>${formatCurrency(chan.tham)}</td>
                <td>${formatCurrency(chan.tien_dong)}</td>
                <td class="text-red font-bold">${formatCurrency(chan.tien_hot)}</td>
            `;
            tbody.appendChild(row);

            tongTham += chan.tham || 0;
            tongTienHot += chan.tien_hot || 0;
        });
    }
    
    // Thêm dòng tổng cộng
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `
        <td colspan="5" style="text-align: right; font-size: 14pt;">TỔNG:</td>
        <td class="text-blue">${formatCurrency(tongTham)}</td>
        <td></td>
        <td class="text-red">${formatCurrency(tongTienHot)}</td>
    `;
    tbody.appendChild(totalRow);
}
