<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Tin Dây Hụi</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            font-size: 14pt;
            color: #000;
        }
        .container {
            width: 28cm;
            padding: 1cm;
            margin: auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            position: relative;
            padding-bottom: 80px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .title-section {
            text-align: center;
            margin-bottom: 20px;
        }
        .title-section h1 {
            font-family: 'Times New Roman', Times, serif;
            font-size: 26pt;
            color: #0070c0;
            margin: 0;
        }
        .title-section p {
            margin: 5px 0 0;
            font-size: 12pt;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr;
            gap: 10px 5px;
            margin-bottom: 20px;
        }
        .info-item { font-size: 12pt; }
        .info-item .label { font-weight: bold; display: inline-block; width: 90px; }
        .info-item .value { font-weight: bold; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #888; padding: 6px 8px; text-align: center; vertical-align: middle; }
        th { background-color: #d9e2f3; font-weight: bold; }
        .status-cell.dead { background-color: #ff0000; color: white; font-weight: bold; }
        .status-cell.alive { background-color: #00b050; color: white; font-weight: bold; }
        .total-row td { font-weight: bold; background-color: #f2f2f2; }
        .text-blue { color: #0070c0; }
        .text-red { color: #ff0000; }
        .font-bold { font-weight: bold; }
        .bill-controls { position: absolute; bottom: 1cm; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 10; }
        .bill-controls button { padding: 10px 20px; font-size: 14px; font-weight: bold; font-family: Arial, sans-serif; cursor: pointer; color: white; border: none; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .download-btn { background-color: #0275d8; }
        .copy-btn { background-color: #5bc0de; }
        .share-btn { background-color: #5cb85c; }
        @media print { .bill-controls { display: none !important; } }
    </style>
</head>
<body>
    <div class="container" id="bill-to-capture">
        <div class="header">
            <div class="left">
                Chủ Hụi: <span data-field="chu_hui_ten" class="font-bold"></span><br>
                SĐT: <span data-field="chu_hui_sdt" class="font-bold"></span>
            </div>
        </div>
        <div class="title-section">
            <h1>THÔNG TIN DÂY HỤI</h1>
            <p>Ngày: <span data-field="ngay_in_bill"></span></p>
        </div>
        <div class="info-grid">
            <div class="info-item"><span class="label">Dây:</span><span data-field="day_ten" class="value"></span></div>
            <div class="info-item"><span class="label">Kỳ Hạn:</span><span data-field="ky_han_text" class="value text-blue"></span></div>
            <div class="info-item"><span class="label">Thu Thảo</span></div>
            <div class="info-item"><span class="label">Số Kỳ:</span><span data-field="so_ky" class="value"></span></div>
            <div class="info-item"><span class="label">Mãn Kỳ:</span><span data-field="man_ky_du_kien" class="value text-blue"></span></div>
            <div class="info-item"><span data-field="thu_khi_hot" class="value text-red"></span></div>
            <div class="info-item"><span class="label">Ngày Mở:</span><span data-field="ngay_mo" class="value text-blue"></span></div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>TÊN HỤI VIÊN</th>
                    <th>S / C</th>
                    <th>NGÀY</th>
                    <th>KỲ</th>
                    <th>THĂM</th>
                    <th>TIỀN ĐÓNG</th>
                    <th>TIỀN HỐT</th>
                </tr>
            </thead>
            <tbody id="details-tbody">
            </tbody>
        </table>
        
        <div class="bill-controls">
            <button class="download-btn">Tải Bill</button>
            <button class="copy-btn">Copy Bill</button>
            <button class="share-btn">Gửi Bill</button>
        </div>
    </div>

<script>
    let billData = {};

    window.onload = function() {
        try {
            const encodedData = window.location.hash.substring(1);
            if (!encodedData) { throw new Error('Không tìm thấy dữ liệu.'); }
            const jsonData = decodeURIComponent(encodedData);
            billData = JSON.parse(jsonData);
            generateBill(billData);
        } catch (error) {
            document.body.innerHTML = `<h2 style="color: red; text-align: center;">Lỗi!</h2><p style="text-align: center;">${error.message}</p>`;
            console.error("Lỗi:", error);
        }
    };

    function formatCurrency(num) {
        if (typeof num !== 'number' || num === null) return '';
        return num.toLocaleString('vi-VN');
    }

    /**
     * Hàm addPeriod (Đã sửa lỗi)
     * Dùng Math.floor(value) để lấy đúng số ngày cần cộng
     */
    function addPeriod(dateString, value, unit) {
        if (!dateString || typeof dateString !== 'string' || dateString.split('/').length !== 3) return "";
        
        // Luôn làm tròn xuống số nguyên ngày cần cộng
        const daysToAdd = Math.floor(parseFloat(value) || 0); 
        
        // Nếu số ngày cộng là 0, trả về ngày gốc
        if (daysToAdd === 0 && !unit.toLowerCase().includes('tháng')) {
             return dateString;
        }

        const [day, month, year] = dateString.split('/');
        const date = new Date(+year, +month - 1, +day);
        if (isNaN(date.getTime())) return "";

        if ((unit || '').toLowerCase().includes('tháng')) {
            const originalDay = date.getDate();
            date.setDate(1);
            date.setMonth(date.getMonth() + daysToAdd);
            const lastDayOfNewMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            date.setDate(Math.min(originalDay, lastDayOfNewMonth));
        } else {
            date.setDate(date.getDate() + daysToAdd);
        }
        
        const newDay = String(date.getDate()).padStart(2, '0');
        const newMonth = String(date.getMonth() + 1).padStart(2, '0');
        const newYear = date.getFullYear();
        return `${newDay}/${newMonth}/${newYear}`;
    }

    /**
     * HÀM GENERATEBILL ĐÃ ĐƯỢC VIẾT LẠI HOÀN TOÀN
     * Sử dụng logic tính toán độc lập cho mỗi dòng dựa trên STT
     */
    function generateBill(data) {
        for (const key in data) {
            if (key !== 'danh_sach_chan') {
                const element = document.querySelector(`[data-field="${key}"]`);
                if (element) element.textContent = data[key];
            }
        }
        
        const tbody = document.getElementById('details-tbody');
        tbody.innerHTML = '';
        let tongTham = 0, tongTienHot = 0, tongTienDong = 0;

        if (data.danh_sach_chan && Array.isArray(data.danh_sach_chan)) {
            // Sắp xếp theo STT (ky)
            // (Thực ra không cần sort nếu JSON đã đúng thứ tự, nhưng để an toàn)
            data.danh_sach_chan.sort((a, b) => (a.ky || 0) - (b.ky || 0));

            const ngayMo = data.ngay_mo;
            const kyHanValueFloat = parseFloat(data.ky_han_value) || 1; 

            // Tính ngày mãn kỳ chính xác
            const manKyDuKienEl = document.querySelector('[data-field="man_ky_du_kien"]');
            if (manKyDuKienEl) {
                const soKyInt = parseInt(data.so_ky) || 0;
                // Công thức: Ngày Mở + FLOOR((Số Kỳ Cuối - 1) * 0.5)
                const periodsToAdd = (soKyInt - 1) * kyHanValueFloat;
                manKyDuKienEl.textContent = addPeriod(ngayMo, periodsToAdd, data.ky_han_unit);
            }

            // Lặp qua từng hụi viên
            data.danh_sach_chan.forEach((chan, index) => {
                const stt = index + 1; // STT chính là KỲ
                const kyHienThi = chan.ky || stt; // Lấy kỳ từ JSON, nếu không có thì dùng STT
                
                const row = document.createElement('tr');
                let ngayHienThi = chan.ngay; // Ngày của hụi viên "Chết"

                const statusText = chan.status; 
                let statusClass = 'dead';

                if (statusText === 'V' || statusText === 'S') {
                    statusClass = 'alive';
                    
                    // --- LOGIC TÍNH TOÁN ĐỘC LẬP (ĐÃ SỬA) ---
                    // Công thức: Ngày = Ngày Mở + FLOOR((Kỳ - 1) * 0.5)
                    const periodsToAdd = (kyHienThi - 1) * kyHanValueFloat;
                    ngayHienThi = addPeriod(ngayMo, periodsToAdd, data.ky_han_unit);
                }
                
                const ngayClass = (statusText !== 'V' && statusText !== 'S') ? 'text-red' : '';
                
                row.innerHTML = `
                    <td>${stt}</td>
                    <td style="text-align: left;">${chan.ten_hui_vien}</td>
                    <td class="status-cell ${statusClass}">${statusText}</td>
                    <td class="${ngayClass} font-bold">${ngayHienThi || ''}</td>
                    <td>${kyHienThi}</td> 
                    <td>${formatCurrency(chan.tham)}</td>
                    <td>${formatCurrency(chan.tien_dong)}</td>
                    <td class="text-red font-bold">${formatCurrency(chan.tien_hot)}</td>
                `;
                tbody.appendChild(row);
                tongTham += chan.tham || 0;
                tongTienHot += chan.tien_hot || 0;
                tongTienDong += chan.tien_dong || 0;
            });
        }
        
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
            <td colspan="5" style="text-align: center; font-size: 14pt;">TỔNG:</td>
            <td class="text-blue">${formatCurrency(tongTham)}</td>
            <td>${formatCurrency(tongTienDong)}</td> 
            <td class="text-red">${formatCurrency(tongTienHot)}</td>
        `;
        tbody.appendChild(totalRow);
        
        const billElement = document.getElementById('bill-to-capture');
        document.querySelector('.download-btn').addEventListener('click', () => downloadBillAsImage(billElement));
        document.querySelector('.copy-btn').addEventListener('click', () => copyBillAsImage(billElement));
        document.querySelector('.share-btn').addEventListener('click', () => shareBillAsImage(billElement));
    }

    async function captureBill(element, callback) {
        const controls = element.querySelector('.bill-controls');
        if (controls) controls.style.display = 'none';
        try {
            const canvas = await html2canvas(element, { scale: 2, useCORS: true });
            await callback(canvas);
        } catch (error) {
            console.error('Lỗi khi tạo ảnh:', error);
            alert('Đã có lỗi xảy ra khi tạo ảnh.');
        } finally {
            if (controls) controls.style.display = 'flex';
        }
    }

    function downloadBillAsImage(element) {
        const filename = `ThongTinDay_${billData.day_ten || 'bill'}.png`;
        captureBill(element, canvas => {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }

    function copyBillAsImage(element) {
        captureBill(element, canvas => {
            canvas.toBlob(blob => {
                navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                .then(() => alert('Đã sao chép ảnh vào bộ nhớ tạm!'))
                .catch(err => alert('Lỗi khi copy.'));
            });
        });
    }

    async function shareBillAsImage(element) {
        const filename = `ThongTinDay_${billData.day_ten || 'bill'}.png`;
        const textshare = `Thông tin dây hụi ${billData.day_ten}.`;
        if (!navigator.share) {
            alert('Trình duyệt không hỗ trợ chức năng này. Vui lòng dùng nút "Copy Bill".');
            return;
        }
        captureBill(element, async canvas => {
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            const file = new File([blob], filename, { type: 'image/png' });
            try {
                await navigator.share({ title: `Thông Tin Dây Hụi`, text: textshare, files: [file] });
            } catch (error) { console.log('Người dùng đã hủy chia sẻ.'); }
        });
    }
</script>
</body>
</html>


