<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán QR Chuẩn</title>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --blue: #0056b3; --dark: #000; }
        body { font-family: 'Arial', sans-serif; background: #edeff2; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        #bill-wrapper { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .head { color: var(--blue); font-size: 22px; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .info { background: #f1f3f5; border-radius: 12px; padding: 15px; text-align: left; border-left: 6px solid var(--blue); margin-bottom: 20px; }
        .info p { margin: 6px 0; font-size: 15px; color: #444; }
        .info b { color: var(--dark); font-size: 16px; }
        #qr-canvas { margin: 15px auto; display: block; }
        .note-area { background: #fffde7; border: 1.5px dashed #fbc02d; border-radius: 12px; padding: 15px; margin-top: 20px; }
        .note-txt { font-size: 14px; color: #333; line-height: 1.5; }
        .msg-bold { display: block; font-size: 18px; font-weight: 900; color: var(--dark); margin-top: 10px; text-transform: uppercase; word-break: break-all; }
        .footer-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 25px; width: 100%; max-width: 380px; }
        .btn { border: none; padding: 15px 0; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .btn-1 { background: #2e7d32; } .btn-2 { background: #1565c0; } .btn-3 { background: #ef6c00; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
    </style>
</head>
<body>

<div id="bill-wrapper">
    <div class="head">THÔNG TIN THANH TOÁN</div>
    <div class="info">
        <p>Ngân hàng: <b id="v-bank">...</b></p>
        <p>Số tài khoản: <b id="v-stk">...</b></p>
        <p>Chủ tài khoản: <b id="v-name">...</b></p>
    </div>

    <canvas id="qr-canvas"></canvas>

    <div class="note-area">
        <div class="note-txt">
            Quét mã để thanh toán hoặc nhập nội dung:
            <span class="msg-bold" id="v-content">...</span>
            để hệ thống tự động kiểm tra.
        </div>
    </div>
</div>

<div class="footer-btns">
    <button class="btn btn-1" onclick="handleBtn('dl')">TẢI VỀ</button>
    <button class="btn btn-2" onclick="handleBtn('cp')">COPY ẢNH</button>
    <button class="btn btn-3" onclick="handleBtn('sh')">GỬI ẢNH</button>
</div>

<script>
    // Hàm xử lý văn bản không dấu cực mạnh
    function toNoSign(str) {
        if(!str) return "";
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                  .replace(/đ/g, "d").replace(/Đ/g, "D")
                  .replace(/[^a-zA-Z0-9 ]/g, "").toUpperCase();
    }

    const params = new URLSearchParams(window.location.search);
    const bin = params.get('bin') || '970423';
    const stk = params.get('stk') || '';
    const name = toNoSign(params.get('name') || '');
    const content = toNoSign(params.get('content') || '');

    document.getElementById('v-bank').innerText = bin;
    document.getElementById('v-stk').innerText = stk;
    document.getElementById('v-name').innerText = name;
    document.getElementById('v-content').innerText = content;

    // --- THUẬT TOÁN VIETQR CHUẨN XÁC ---
    function getVietQRString(bin, stk, desc) {
        const f = (tag, val) => tag + val.length.toString().padStart(2, '0') + val;
        
        // Thẻ 38: Thông tin định danh ngân hàng
        const bankData = f('00', 'A000000727') + f('01', f('00', bin) + f('01', stk));
        
        let raw = f('00', '01') + // Payload Format Indicator
                  f('01', '11') + // QR tĩnh (Dùng 11 để tương thích cao nhất)
                  f('38', bankData) + 
                  f('53', '704') + // Currency: VND
                  f('58', 'VN') +  // Country: VN
                  f('62', f('08', desc)) + // Content
                  "6304"; // Tag CRC

        // Tính CRC16-CCITT chuẩn Napas
        function calcCRC16(str) {
            let crc = 0xFFFF;
            for (let i = 0; i < str.length; i++) {
                crc ^= str.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) {
                    if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
                    else crc <<= 1;
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }
        
        return raw + calcCRC16(raw);
    }

    // Khởi tạo mã QR trực tiếp lên Canvas (giúp copy/tải ổn định hơn)
    const qr = new QRious({
        element: document.getElementById('qr-canvas'),
        value: getVietQRString(bin, stk, content),
        size: 250,
        level: 'M'
    });

    // --- XỬ LÝ NÚT BẤM ---
    async function handleBtn(type) {
        const target = document.getElementById("bill-wrapper");
        
        // Chụp canvas với chất lượng cao
        const canvas = await html2canvas(target, { 
            scale: 2, 
            backgroundColor: "#ffffff",
            useCORS: true 
        });
        const imgData = canvas.toDataURL("image/png");

        if (type === 'dl') {
            const a = document.createElement('a');
            a.href = imgData; a.download = `Bill_${stk}.png`; a.click();
        } 
        else if (type === 'cp') {
            try {
                canvas.toBlob(blob => {
                    const data = [new ClipboardItem({ "image/png": blob })];
                    navigator.clipboard.write(data).then(() => alert("Đã copy ảnh thành công!"));
                });
            } catch (err) {
                alert("Trình duyệt chưa hỗ trợ copy ảnh trực tiếp.");
            }
        } 
        else if (type === 'sh') {
            canvas.toBlob(async (blob) => {
                const file = new File([blob], 'thanh-toan.png', { type: 'image/png' });
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'Gửi mã QR' });
                } else {
                    alert("Không hỗ trợ chia sẻ file. Vui lòng tải về!");
                }
            });
        }
    }
</script>
</body>
</html>
