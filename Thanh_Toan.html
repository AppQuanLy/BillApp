<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán QR Chuẩn 100%</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --tp-purple: #5b2d82; }
        body { font-family: -apple-system, sans-serif; background-color: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #payment-card { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .title { color: var(--tp-purple); font-size: 22px; font-weight: bold; margin-bottom: 20px; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .info-panel { background: #f8f9fa; border-radius: 12px; padding: 15px; text-align: left; border-left: 6px solid var(--tp-purple); margin-bottom: 20px; }
        .info-panel p { margin: 8px 0; font-size: 15px; color: #444; }
        .info-panel b { color: #000; font-size: 16px; }
        #qrcode-box { margin: 15px auto; padding: 10px; background: white; display: inline-block; border: 1px solid #eee; }
        .note-area { background: #fffde7; border: 1.5px dashed #fbc02d; border-radius: 12px; padding: 15px; margin-top: 15px; }
        .msg-bold { display: block; font-size: 18px; font-weight: 900; color: #000; margin-top: 10px; text-transform: uppercase; word-break: break-all; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 25px; width: 100%; max-width: 380px; }
        .btn { border: none; padding: 15px 0; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; font-size: 13px; }
    </style>
</head>
<body>

<div id="payment-card">
    <div class="title">Thông Tin Thanh Toán</div>
    <div class="info-panel">
        <p>Ngân hàng: <b>TPBANK</b></p>
        <p>Số tài khoản: <b id="ui-stk">...</b></p>
        <p>Chủ tài khoản: <b id="ui-name">...</b></p>
    </div>
    <div id="qrcode-box"></div>
    <div class="note-area">
        <span style="font-size: 13px; color: #666;">Nội dung chuyển khoản:</span>
        <span class="msg-bold" id="ui-msg">...</span>
    </div>
</div>

<div class="btn-grid">
    <button class="btn" style="background:#2e7d32" onclick="handleBtn('dl')">TẢI VỀ</button>
    <button class="btn" style="background:#1565c0" onclick="handleBtn('cp')">COPY</button>
    <button class="btn" style="background:#e67e22" onclick="handleBtn('sh')">GỬI</button>
</div>

<script>
    // --- BỘ XỬ LÝ VIETQR TỪ MẪU ỔN ĐỊNH ---
    const VietQRProcess = {
        cleanText: function(str) {
            if (!str) return "";
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D').replace(/[^a-zA-Z0-9 ]/g, '').trim().toUpperCase();
        },
        crc16: function(data) {
            let crc = 0xFFFF;
            for (let i = 0; i < data.length; i++) {
                crc ^= data.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) {
                    if ((crc & 0x8000) != 0) crc = (crc << 1) ^ 0x1021;
                    else crc = crc << 1;
                }
                crc = crc & 0xFFFF;
            }
            let hex = crc.toString(16).toUpperCase();
            return "0000".substring(0, 4 - hex.length) + hex;
        },
        generatePayload: function(bin, stk, msg) {
            const field = (id, value) => {
                const valStr = String(value);
                const len = valStr.length;
                return id + (len < 10 ? "0" + len : len) + valStr;
            };

            const merchantInfo = field("00", "A000000727") + 
                                 field("01", field("00", bin) + field("01", stk)) + 
                                 field("02", "QRIBFTTA"); // Hằng số quan trọng giúp ổn định

            let qrStr = field("00", "01") + 
                        field("01", "12") + // Dùng 12 (QR Động) theo mẫu ổn định của bạn
                        field("38", merchantInfo) + 
                        field("53", "704") + 
                        field("58", "VN");

            if (msg) {
                const safeContent = this.cleanText(msg);
                qrStr += field("62", field("08", safeContent));
            }
            
            qrStr += "6304";
            qrStr += this.crc16(qrStr);
            return qrStr;
        }
    };

    const params = new URLSearchParams(window.location.search);
    const vBin = "970423";
    const vStk = (params.get('stk') || '').replace(/\D/g, '');
    const vName = VietQRProcess.cleanText(params.get('name') || '');
    const vMsg = VietQRProcess.cleanText(params.get('content') || '');

    document.getElementById('ui-stk').innerText = vStk;
    document.getElementById('ui-name').innerText = vName;
    document.getElementById('ui-msg').innerText = vMsg;

    // Tạo QR bằng thư viện QRCode.js
    new QRCode(document.getElementById("qrcode-box"), {
        text: VietQRProcess.generatePayload(vBin, vStk, vMsg),
        width: 220,
        height: 220,
        correctLevel: QRCode.CorrectLevel.M
    });

    async function handleBtn(type) {
        await new Promise(r => setTimeout(r, 600));
        const area = document.getElementById("payment-card");
        const canvas = await html2canvas(area, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL("image/png");

        if (type === 'dl') {
            const a = document.createElement('a'); a.href = imgData; a.download = 'ThanhToan.png'; a.click();
        } else if (type === 'cp') {
            canvas.toBlob(blob => {
                const item = new ClipboardItem({ "image/png": blob });
                navigator.clipboard.write([item]).then(() => alert("Đã copy ảnh!"));
            });
        } else if (type === 'sh') {
            canvas.toBlob(async blob => {
                const file = new File([blob], 'QR.png', { type: 'image/png' });
                if (navigator.share) navigator.share({ files: [file] });
            });
        }
    }
</script>
</body>
</html>
