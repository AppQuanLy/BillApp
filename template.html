<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hóa đơn Bill Hụi</title>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .info-panel { max-width: 900px; margin: 0 auto 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .bill-page {
            background-color: white; max-width: 800px; min-width: 800px; margin: 20px auto; padding: 20px; border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; font-family: 'Times New Roman', Times, serif; font-size: 10pt;
        }
        /* ... Dán toàn bộ CSS từ file trước đó của bạn vào đây ... */
        .bill-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 10; }
        .bill-controls button { padding: 5px 10px; font-size: 12px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; opacity: 0.6; transition: opacity 0.2s; }
        .bill-controls button:hover { opacity: 1; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #000; }
        th, td { border: 1px solid #666; padding: 4px 6px; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .text-center { text-align: center; } .text-right { text-align: right; } .no-border, .no-border td { border: none; }
        .font-bold { font-weight: bold; } .font-large { font-size: 14pt; } .font-xlarge { font-size: 16pt; }
        .text-red { color: #d90000; } .text-blue { color: #0070c0; } .header-table td { padding: 0px 5px; }
        .qr-code { width: 80px; height: 80px; } .summary-table th { background-color: #d9e1f2; }
        .summary-table .highlight { background-color: #fff2cc; } .details-table th { background-color: #d9e1f2; }
        .details-table { margin-bottom: 10px; font-size: 9pt;} .footer-banner { padding: 5px; text-align: left; font-size: 12pt; color: white; margin-bottom: 5px;}
        .footer-container { display: flex; align-items: flex-start; gap: 10px;}
        .footer-left { width: 45%; font-size: 14pt; font-weight: bold; text-align: center; }
        .footer-right { width: 55%; } .totals-table td { padding: 5px 7px; font-size: 14pt; }
    </style>
</head>
<body>

    <div class="info-panel">
        <h1 id="status-message">Đang tải và tạo bill...</h1>
    </div>
    
    <div id="bills-container">
        </div>

    <template id="bill-template">
        <div class="bill-page"><div class="bill-controls"><button class="copy-btn">Tải Bill</button><button class="share-btn">Share</button></div><table class="header-table no-border"><tr><td class="font-bold" style="width: 33%;">Chủ hụi: <span data-field="chu_hui"></span></td><td class="font-bold" style="width: 33%;">SDT: <span data-field="sdt"></span></td><td class="font-bold" style="width: 34%;" data-field="bank_info"></td></tr><tr><td colspan="2" class="text-center"><h2 style="margin: 5px 0 0 0; font-size: 20pt;">BILL BÁO HỤI</h2><p style="margin: 0;">Ngày: <span data-field="ngay_tao_bill"></span></p></td><td class="text-right"><img data-field="qr_bill_url" class="qr-code" alt="QR"></td></tr></table><table class="summary-table text-center"><thead><tr><th data-field="summary_title_hui_vien"></th><th data-field="summary_title_hui_chet"></th><th data-field="summary_title_hui_song"></th><th class="highlight">Âm/Dương *</th><th class="highlight">Lợi Nhuận</th></tr></thead><tbody><tr><td class="font-bold" data-field="hoi_vien"></td><td data-field="tong_hui_chet"></td><td data-field="tong_hui_song"></td><td class="highlight font-bold text-blue" data-field="am_duong"></td><td class="highlight font-bold text-red" data-field="loi_nhuan"></td></tr></tbody></table><table class="details-table text-center"><thead><tr><th>Ngày mở</th><th>Dây Hụi</th><th>Kỳ</th><th>Khui</th><th>SỐNG</th><th>CHẾT</th><th>Tiền Hốt</th><th>Tiền Đóng</th><th>Thăm</th><th>Đúp</th></tr></thead><tbody data-field="details_tbody"></tbody></table><div class="footer-container"><div class="footer-left"><div class="footer-banner" data-field="footer_banner"></div><span data-field="footer_hoi_vien"></span></div><div class="footer-right"><table class="totals-table no-border"><tr><td class="font-bold">Tổng Tiền Đóng:</td><td class="text-right font-large font-bold" data-field="bill_tong_dong"></td><td style="width: 25px;" class="text-center">(1)</td><td class="text-blue font-bold" data-field="tong_tham"></td></tr><tr><td class="font-bold">Tổng Tiền Hốt:</td><td class="text-right font-large font-bold" data-field="bill_tong_hot"></td><td class="text-center">(2)</td><td class="text-blue font-bold" data-field="tong_thao"></td></tr><tr><td class="font-bold" data-field="final_text_label"></td><td class="text-right font-xlarge font-bold text-red" data-field="final_amount"></td><td class="text-center font-bold"></td><td class="text-center font-bold">=(1)-(2)</td></tr></table></div></div></div>
    </template>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // TỰ ĐỘNG CHẠY KHI TRANG ĐƯỢC TẢI
        window.onload = function() {
            const infoPanel = document.getElementById('info-panel');
            const statusMessage = document.getElementById('status-message');
            
            try {
                // Lấy chuỗi dữ liệu từ phần sau dấu # trên URL
                const encodedData = window.location.hash.substring(1);
                if (!encodedData) {
                    statusMessage.textContent = 'Không tìm thấy dữ liệu bill trong đường link.';
                    return;
                }
                
                // Giải mã dữ liệu: Base64 -> Chuỗi JSON
                const jsonData = decodeURIComponent(encodedData);
                alert(jsonData);
                // Gọi hàm tạo bill với dữ liệu đã được giải mã
                generateBills(jsonData);
                infoPanel.style.display = 'none';

            } catch (error) {
                statusMessage.textContent = 'Lỗi! Dữ liệu bill trong link không hợp lệ hoặc đã bị hỏng.';
                console.error("Lỗi giải mã dữ liệu:", error);
            }
        };

        // Hàm generateBills giờ nhận dữ liệu JSON làm tham số
        function generateBills(jsonInput) {
            const billsContainer = document.getElementById('bills-container');
            billsContainer.innerHTML = '';
            try {
                const data = JSON.parse(jsonInput);
                const billTemplate = document.getElementById('bill-template');
                data.forEach(kh => {
                    const billNode = document.importNode(billTemplate.content, true);
                    // ... TOÀN BỘ LOGIC ĐỂ ĐIỀN DỮ LIỆU VÀ GÁN SỰ KIỆN GIỮ NGUYÊN NHƯ CŨ ...
                    const q = (selector) => billNode.querySelector(selector);
                    q('[data-field="chu_hui"]').textContent = kh.chu_hui || ''; q('[data-field="sdt"]').textContent = kh.sdt || ''; q('[data-field="bank_info"]').textContent = kh.bank_info || ''; q('[data-field="ngay_tao_bill"]').textContent = kh.ngay_tao_bill || ''; q('[data-field="qr_bill_url"]').src = kh.qr_bill_url || ''; q('[data-field="summary_title_hui_vien"]').textContent = `Hụi Viên ${kh.tong_so_day || 0} Dây, ${kh.tong_so_chan || 0} C`; q('[data-field="summary_title_hui_chet"]').textContent = `Hụi Chết ${kh.tong_so_chan_chet || 0} C`; q('[data-field="summary_title_hui_song"]').textContent = `Hụi Sống ${kh.tong_so_chan_song || 0} C`; q('[data-field="hoi_vien"]').textContent = kh.hoi_vien || ''; q('[data-field="tong_hui_chet"]').textContent = (kh.tong_hui_chet || 0).toLocaleString('vi-VN'); q('[data-field="tong_hui_song"]').textContent = (kh.tong_hui_song || 0).toLocaleString('vi-VN'); q('[data-field="am_duong"]').textContent = (kh.am_duong || 0).toLocaleString('vi-VN'); q('[data-field="loi_nhuan"]').textContent = (kh.loi_nhuan || 0).toLocaleString('vi-VN');
                    const detailsBody = q('[data-field="details_tbody"]');
                    if (kh.chan_hui_details && Array.isArray(kh.chan_hui_details)) {
                        kh.chan_hui_details.forEach(d => {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${d.ngay_mo || ''}</td><td>${(d.day_hui || 0).toLocaleString('vi-VN')}</td><td>${d.ky || ''}</td><td class="font-bold text-red">${d.khui || ''}</td><td>${d.song || 0}</td><td>${d.chet || 0}</td><td>${(d.tien_hot || 0).toLocaleString('vi-VN')}</td><td>${(d.tien_dong || 0).toLocaleString('vi-VN')}</td><td class="font-bold text-red">${(d.tham || 0).toLocaleString('vi-VN')}</td><td>${d.dup || 0}</td>`;
                            detailsBody.appendChild(row);
                        });
                    }
                    q('[data-field="footer_hoi_vien"]').textContent = kh.hoi_vien || ''; q('[data-field="bill_tong_dong"]').textContent = (kh.bill_tong_dong || 0).toLocaleString('vi-VN'); q('[data-field="bill_tong_hot"]').textContent = (kh.bill_tong_hot || 0).toLocaleString('vi-VN'); q('[data-field="tong_tham"]').textContent = `Tổng Thăm: ${(kh.tong_tham || 0).toLocaleString('vi-VN')}`; q('[data-field="tong_thao"]').textContent = `Tổng Thảo: ${(kh.tong_thao || 0).toLocaleString('vi-VN')}`;
                    const banner = q('[data-field="footer_banner"]'); const tongDong = kh.bill_tong_dong || 0; const tongHot = kh.bill_tong_hot || 0;
                    if (tongDong > tongHot) { banner.textContent = 'Chủ Hụi phải thu tiền Hụi Viên'; banner.style.backgroundColor = '#d90000'; q('[data-field="final_text_label"]').textContent = 'Phải Đóng:'; q('[data-field="final_amount"]').textContent = (tongDong - tongHot).toLocaleString('vi-VN'); } else { banner.textContent = 'Hụi Viên được nhận tiền'; banner.style.backgroundColor = '#00b050'; q('[data-field="final_text_label"]').textContent = 'Được Nhận:'; q('[data-field="final_amount"]').textContent = (tongHot - tongDong).toLocaleString('vi-VN'); }
                    const billElement = billNode.querySelector('.bill-page');
                    billNode.querySelector('.copy-btn').addEventListener('click', () => downloadBillAsImage(billElement, kh.hoi_vien));
                    if (navigator.share && navigator.canShare) { billNode.querySelector('.share-btn').addEventListener('click', () => shareBillAsImage(billElement, kh.hoi_vien)); } else { billNode.querySelector('.share-btn').style.display = 'none'; }
                    billsContainer.appendChild(billNode);
                });
            } catch (error) { alert('Lỗi cú pháp JSON hoặc dữ liệu không hợp lệ.'); console.error(error); }
        }
        // Các hàm copyBillAsImage và shareBillAsImage giữ nguyên như cũ
        function downloadBillAsImage(element, tenHuiVien) {
    const controls = element.querySelector('.bill-controls');
    controls.style.display = 'none'; // Tạm ẩn các nút

    html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
        // Tạo một đường link tạm thời trong bộ nhớ
        const link = document.createElement('a');
        
        // Đặt tên file sẽ được tải về
        link.download = `bill_${tenHuiVien || 'bill'}.png`;
        
        // Gán nội dung của ảnh vào đường link
        link.href = canvas.toDataURL("image/png");
        
        // Tự động nhấn vào link để trình duyệt bắt đầu quá trình tải về
        link.click();
        
        controls.style.display = 'flex'; // Hiện lại các nút sau khi xong
    }).catch(err => {
        console.error('Lỗi khi tạo ảnh:', err);
        alert('Đã có lỗi xảy ra khi tạo ảnh.');
        controls.style.display = 'flex';
    });
}
        async function shareBillAsImage(element, tenHuiVien) { const c = element.querySelector('.bill-controls'); c.style.display = 'none'; try { const canvas = await html2canvas(element, { scale: 2, useCORS: true }); const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png')); const file = new File([blob], `bill_${tenHuiVien || 'bill'}.png`, { type: 'image/png' }); if (navigator.canShare({ files: [file] })) { await navigator.share({ title: `Bill Báo Hụi - ${tenHuiVien}`, text: `Đây là bill báo hụi của ${tenHuiVien}.`, files: [file], }); } else { alert('Trình duyệt này không hỗ trợ chia sẻ file.'); } } catch (error) { console.error(error); alert('Lỗi khi chia sẻ: ' + error); } finally { c.style.display = 'flex'; } }
    </script>
</body>
</html>
