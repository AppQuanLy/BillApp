<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vòng Quay Chọn Người Hốt Hụi</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f7f6; padding: 20px; }
        #wheel-container { margin: 20px auto; position: relative; }
        #wheel { border: 2px solid #000; }
        #arrow { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 40px; color: red; }
        #spin-button { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #spin-button:disabled { background-color: #ccc; cursor: not-allowed; }
        #result { margin-top: 20px; font-size: 20px; font-weight: bold; color: green; }
        #status-message { margin-top: 10px; color: red; }
        #edit-section { margin-top: 20px; display: none; }
        #edit-section.show { display: block; }
        #edit-button { padding: 10px 20px; font-size: 16px; background-color: #ffc107; color: black; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
        .weight-input { width: 50px; text-align: center; }
        #save-weights { padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Vòng Quay Chọn Người Hốt Hụi</h1>
    <div id="wheel-container">
        <canvas id="wheel" width="400" height="400"></canvas>
        <div id="arrow">▼</div>
    </div>
    <button id="spin-button">Quay</button>
    <div id="result"></div>
    <div id="status-message"></div>

    <button id="edit-button">Chỉnh sửa tỷ lệ</button>
    <div id="edit-section">
        <h3>Chỉnh trọng số (tỷ lệ trúng)</h3>
        <table id="weights-table" style="margin: 0 auto; border-collapse: collapse;">
            <!-- Rows sẽ được thêm động -->
        </table>
        <button id="save-weights">Lưu thay đổi</button>
    </div>

    <script>
        let participants = []; // Danh sách người tham gia: [{name: 'A', weight: 1}, ...]
        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spin-button');
        const resultDiv = document.getElementById('result');
        const statusMessage = document.getElementById('status-message');
        const editButton = document.getElementById('edit-button');
        const editSection = document.getElementById('edit-section');
        const weightsTable = document.getElementById('weights-table');
        const saveWeights = document.getElementById('save-weights');
        const wheelSize = 400;
        const center = wheelSize / 2;
        let currentAngle = 0;
        let spinning = false;

        // Màu sắc ngẫu nhiên cho các phần
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Vẽ vòng quay với các phần BẰNG NHAU (không phụ thuộc weight)
        function drawWheel() {
            if (participants.length === 0) return;
            ctx.clearRect(0, 0, wheelSize, wheelSize);
            const sliceAngle = 2 * Math.PI / participants.length; // Các phần bằng nhau
            let startAngle = currentAngle;
            participants.forEach((p, index) => {
                ctx.beginPath();
                ctx.arc(center, center, center, startAngle, startAngle + sliceAngle);
                ctx.lineTo(center, center);
                ctx.fillStyle = p.color || (p.color = getRandomColor());
                ctx.fill();
                ctx.stroke();

                // Vẽ chữ
                ctx.save();
                ctx.translate(center, center);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = 'right';
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(p.name, center - 10, 5);
                ctx.restore();

                startAngle += sliceAngle;
            });
        }

        // Chọn ngẫu nhiên với trọng số (weight chỉ ảnh hưởng xác suất, không ảnh hưởng hiển thị)
        function weightedRandom() {
            const totalWeight = participants.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            for (let i = 0; i < participants.length; i++) {
                random -= participants[i].weight;
                if (random < 0) return i;
            }
            return participants.length - 1;
        }

        // Animation quay
        function spinWheel() {
            if (spinning) return;
            if (participants.length < 2) {
                statusMessage.textContent = 'Cần ít nhất 2 người tham gia để quay.';
                return;
            }
            spinning = true;
            spinButton.disabled = true;
            resultDiv.textContent = '';
            const winnerIndex = weightedRandom();
            const sliceAngle = 360 / participants.length; // Các phần bằng nhau
            const cumulativeAngle = winnerIndex * sliceAngle;
            const randomInSlice = Math.random() * sliceAngle + cumulativeAngle;
            const targetAngle = 360 - randomInSlice + 360 * 5; // Quay 5 vòng + dừng ở giữa phần winner

            let startTime = null;
            const duration = 5000; // 5 giây

            function animate(time) {
                if (!startTime) startTime = time;
                const progress = (time - startTime) / duration;
                const easeOut = 1 - Math.pow(1 - progress, 3); // Ease out cubic
                currentAngle = (targetAngle * easeOut) % 360;
                drawWheel();
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    spinning = false;
                    spinButton.disabled = false;
                    resultDiv.textContent = `Người trúng: ${participants[winnerIndex].name}`;
                }
            }
            requestAnimationFrame(animate);
        }

        // Hiển thị form chỉnh sửa weight
        function showEditWeights() {
            weightsTable.innerHTML = '';
            const header = document.createElement('tr');
            header.innerHTML = '<th>Tên</th><th>Trọng số (weight)</th>';
            weightsTable.appendChild(header);
            participants.forEach((p, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${p.name}</td><td><input type="number" class="weight-input" data-index="${index}" value="${p.weight}" min="0.1" step="0.1"></td>`;
                weightsTable.appendChild(row);
            });
            editSection.classList.add('show');
        }

        // Lưu weight mới (không vẽ lại wheel vì hiển thị không thay đổi)
        function saveEditWeights() {
            const inputs = document.querySelectorAll('.weight-input');
            inputs.forEach(input => {
                const index = input.dataset.index;
                const newWeight = parseFloat(input.value);
                if (newWeight > 0) {
                    participants[index].weight = newWeight;
                }
            });
            editSection.classList.remove('show');
            statusMessage.textContent = 'Tỷ lệ đã được cập nhật (hiển thị vòng quay không thay đổi).';
        }

        // Load dữ liệu từ URL
        window.onload = function() {
            try {
                const encodedData = window.location.hash.substring(1);
                if (encodedData) {
                    const jsonData = decodeURIComponent(encodedData);
                    participants = JSON.parse(jsonData);
                    if (!Array.isArray(participants) || participants.length === 0) {
                        throw new Error('Dữ liệu không hợp lệ');
                    }
                    // Kiểm tra và chuẩn hóa dữ liệu
                    participants = participants.map(p => ({
                        name: p.name || 'Unknown',
                        weight: parseFloat(p.weight) > 0 ? parseFloat(p.weight) : 1
                    }));
                    drawWheel();
                    statusMessage.textContent = 'Dữ liệu đã tải thành công.';
                } else {
                    statusMessage.textContent = 'Không có dữ liệu. Sử dụng dữ liệu mẫu.';
                    // Dữ liệu mẫu nếu không có
                    participants = [
                        {name: 'Người 1', weight: 1},
                        {name: 'Người 2', weight: 2},
                        {name: 'Người 3', weight: 1.5}
                    ];
                    drawWheel();
                }
            } catch (error) {
                statusMessage.textContent = 'Lỗi tải dữ liệu: ' + error.message;
            }
            spinButton.addEventListener('click', spinWheel);
            editButton.addEventListener('click', showEditWeights);
            saveWeights.addEventListener('click', saveEditWeights);
        };
    </script>
</body>
</html>
