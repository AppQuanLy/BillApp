<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vòng Quay Hốt Hụi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .main-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; text-align: center; }
        .wheel-container { position: relative; width: 450px; height: 450px; }
        canvas { display: block; border-radius: 50%; border: 8px solid #ffffff; box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: transform 6s cubic-bezier(0.2, 0.9, 0.4, 1.0); }
        .pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid #ef4444; z-index: 10; }
        .spin-button { transition: transform 0.2s, box-shadow 0.2s; }
        .spin-button:hover { transform: scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .spin-button:active { transform: scale(0.95); }
        .spin-button:disabled { opacity: 0.6; cursor: not-allowed; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-100">

    <button id="settingsButton" class="fixed top-4 right-4 bg-white p-3 rounded-full shadow-lg z-20 hover:bg-gray-200 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
    </button>
    
    <div class="main-container">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Vòng Quay Hốt Hụi</h1>
        <p class="text-gray-500 mb-8">Vòng Quay từ Phần Mềm Tính Hụi!</p>
        
        <div class="wheel-container">
            <canvas id="wheelCanvas" width="450" height="450">Trình duyệt của bạn không hỗ trợ Canvas.</canvas>
            <div class="pointer"></div>
        </div>
        
        <div class="mt-8">
            <button id="spinButton" class="spin-button bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-4 px-12 rounded-full shadow-lg text-xl">QUAY!</button>
        </div>
        
        <div id="resultBox" class="hidden mt-8 w-full max-w-md p-4 text-center text-xl font-semibold rounded-lg shadow-md transition-all duration-300"></div>
    </div>
    
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg m-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Chỉnh Sửa Tỉ Lệ Quay</h2>
            <div id="prize-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
            <div class="mt-6 flex justify-between">
                <button id="addPrizeButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Thêm Người</button>
                <button id="saveSettingsButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Lưu & Đóng</button>
            </div>
        </div>
    </div>

    <script>
        // --- CÁC BIẾN TOÀN CỤC ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spinButton');
        const resultBox = document.getElementById('resultBox');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const addPrizeButton = document.getElementById('addPrizeButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const prizeListContainer = document.getElementById('prize-list');

        const colorPalette = ['#ee1c24', '#3cb878', '#f6989d', '#00aef0', '#f26522', '#e70697', '#fff200', '#8a2be2', '#ff4500', '#20b2aa'];
        let prizes = [];
        let isSpinning = false;
        let currentRotation = 0;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = centerX - 10;

        // --- CÁC HÀM XỬ LÝ CHÍNH ---

        function initializeWheelFromURL() {
            const params = new URLSearchParams(window.location.search);
            const namesParam = params.get('names');
            let initialNames = ['Người 1', 'Người 2', 'Người 3', 'Người 4', 'Người 5'];
            
            if (namesParam) {
                const decodedNames = decodeURIComponent(namesParam);
                initialNames = decodedNames.split(',').map(name => name.trim()).filter(name => name);
            }

            if (initialNames.length === 0) {
                 initialNames = ['Người 1', 'Người 2', 'Người 3', 'Người 4', 'Người 5'];
            }
            
            // Tạo mảng 'prizes' với tỉ lệ mặc định là 0
            prizes = initialNames.map((name, index) => ({
                text: name,
                probability: 0, // <<-- TỈ LỆ MẶC ĐỊNH LÀ 0
                color: colorPalette[index % colorPalette.length],
                textColor: (index % colorPalette.length === 6) ? '#000000' : '#ffffff'
            }));

            drawWheel();
        }

        function drawWheel() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (prizes.length === 0) {
                ctx.textAlign = 'center';
                ctx.fillStyle = '#6b7280';
                ctx.font = 'bold 20px Inter';
                ctx.fillText('Không có người chơi.', centerX, centerY);
                return;
            }
            const anglePerPrize = (2 * Math.PI) / prizes.length;
            let startAngle = 0;
            prizes.forEach(prize => {
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + anglePerPrize);
                ctx.closePath();
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + anglePerPrize / 2);
                ctx.textAlign = 'right';
                ctx.fillStyle = prize.textColor || '#fff';
                ctx.font = 'bold 16px Inter';
                const text = prize.text.length > 12 ? prize.text.substring(0, 10) + '...' : prize.text;
                ctx.fillText(text, radius - 15, 10);
                ctx.restore();
                startAngle += anglePerPrize;
            });
        }
        
        function getWinningPrizeIndex() {
            const totalProbability = prizes.reduce((sum, prize) => sum + prize.probability, 0);
            // Nếu tổng tỉ lệ là 0 (chưa ai nhập), quay ngẫu nhiên
            if (totalProbability <= 0) {
                return Math.floor(Math.random() * prizes.length);
            }
            // Nếu có tỉ lệ, quay theo tỉ lệ
            const randomNum = Math.random() * totalProbability;
            let cumulativeProbability = 0;
            for (let i = 0; i < prizes.length; i++) {
                cumulativeProbability += prizes[i].probability;
                if (randomNum <= cumulativeProbability) return i;
            }
            return prizes.length - 1; // Fallback
        }

        function calculateFinalStopAngle(winningIndex) {
            const numPrizes = prizes.length;
            const anglePerPrizeDeg = 360 / numPrizes;
            const pointerPositionDeg = 270;
            const winningSegmentStartAngle = winningIndex * anglePerPrizeDeg;
            const landingDeg = winningSegmentStartAngle + (anglePerPrizeDeg / 2);
            let rotationRequired = pointerPositionDeg - landingDeg;
            while (rotationRequired < 0) {
                rotationRequired += 360;
            }
            const extraSpins = 6;
            const currentLap = Math.floor(currentRotation / 360);
            return (currentLap + extraSpins) * 360 + rotationRequired;
        }

        function startSpin() {
            if (isSpinning || prizes.length === 0) return;
            isSpinning = true;
            spinButton.disabled = true;
            spinButton.innerText = 'ĐANG QUAY...';
            resultBox.classList.add('hidden');
            resultBox.classList.remove('bg-green-100', 'text-green-800');
            const winningPrizeIndex = getWinningPrizeIndex();
            if (winningPrizeIndex === -1) { // Đề phòng trường hợp không có người chơi
                 isSpinning = false;
                 spinButton.disabled = false;
                 return;
            }
            const finalAngle = calculateFinalStopAngle(winningPrizeIndex);
            canvas.style.transform = `rotate(${finalAngle}deg)`;
            currentRotation = finalAngle;
            setTimeout(() => {
                isSpinning = false;
                spinButton.disabled = false;
                spinButton.innerText = 'QUAY!';
                const winningPrize = prizes[winningPrizeIndex];
                resultBox.classList.remove('hidden');
                resultBox.classList.add('bg-green-100', 'text-green-800');
                resultBox.innerText = `Người hốt hụi là: ${winningPrize.text}!`;
            }, 6000);
        }

        // --- CÁC HÀM CHO BẢNG CÀI ĐẶT (MODAL) ---

        function renderSettings() {
            prizeListContainer.innerHTML = '';
            prizes.forEach((prize, index) => {
                // Truyền cả tên và tỉ lệ hiện tại vào
                const prizeRow = createPrizeInputRow(prize.text, prize.probability, index);
                prizeListContainer.appendChild(prizeRow);
            });
        }
        
        function createPrizeInputRow(text, probability, index) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.dataset.index = index;
            // Thêm lại cột nhập xác suất
            div.innerHTML = `<input type="text" value="${text}" placeholder="Tên người chơi" class="flex-1 p-2 border border-gray-300 rounded-lg"><input type="number" value="${probability}" min="0" placeholder="%" class="w-20 p-2 border border-gray-300 rounded-lg text-center"><span class="font-semibold text-gray-500">%</span><button class="remove-prize-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`;
            div.querySelector('.remove-prize-btn').addEventListener('click', () => div.remove());
            return div;
        }

        function addPrize() {
            const newPrizeRow = createPrizeInputRow('Tên mới', 0, prizes.length);
            prizeListContainer.appendChild(newPrizeRow);
        }

        function saveSettings() {
            const newPrizes = [];
            const prizeRows = prizeListContainer.querySelectorAll('.flex.items-center');
            prizeRows.forEach((row, index) => {
                const textInput = row.querySelector('input[type="text"]');
                const probInput = row.querySelector('input[type="number"]');
                const text = textInput.value.trim();
                const probability = parseInt(probInput.value, 10) || 0; // Đọc giá trị tỉ lệ
                if (text) {
                    newPrizes.push({ 
                        text: text, 
                        probability: probability, // Lưu tỉ lệ mới
                        color: colorPalette[index % colorPalette.length], 
                        textColor: (index % colorPalette.length === 6) ? '#000000' : '#ffffff' 
                    });
                }
            });
            prizes = newPrizes;
            settingsModal.classList.add('hidden');
            drawWheel();
        }
        
        // --- GÁN SỰ KIỆN ---
        spinButton.addEventListener('click', startSpin);
        settingsButton.addEventListener('click', () => { renderSettings(); settingsModal.classList.remove('hidden'); });
        addPrizeButton.addEventListener('click', addPrize);
        saveSettingsButton.addEventListener('click', saveSettings);
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { settingsModal.classList.add('hidden'); } });
        
        // --- KHỞI TẠO KHI TẢI TRANG ---
        document.addEventListener('DOMContentLoaded', initializeWheelFromURL);

    </script>
</body>
</html>
