<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vòng Quay Hốt Hụi</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        h1 {
            color: #333;
            text-shadow: 1px 1px 2px #fff;
        }
        #wheel-container {
            position: relative;
            width: 500px;
            height: 500px;
        }
        #spin-button {
            display: block;
            margin: 20px auto;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            background: linear-gradient(145deg, #fe6b8b 30%, #ff8e53 90%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 3px 5px 2px rgba(255, 105, 135, .3);
            transition: transform 0.2s, box-shadow 0.2s;
            outline: none;
        }
        #spin-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        #spin-button:not(:disabled):hover {
            transform: scale(1.05);
            box-shadow: 0 5px 8px 3px rgba(255, 105, 135, .4);
        }
        #pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 50px solid #c0392b;
            z-index: 10;
        }
    </style>
</head>
<body>
    <h1 id="title">Vòng Quay Hốt Hụi</h1>
    <div id="wheel-container">
        <div id="pointer"></div>
        <canvas id="canvas" width="500" height="500"></canvas>
    </div>
    <button id="spin-button" onclick="startSpin()">QUAY</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/winwheeljs@2.8.0/dist/Winwheel.min.js"></script>

    <script>
        let theWheel;
        let wheelSpinning = false;
        let participants = [];

        // Hàm khởi tạo khi trang tải xong
        window.onload = function() {
            try {
                const encodedData = window.location.hash.substring(1);
                if (!encodedData) {
                    document.getElementById('title').textContent = 'Lỗi: Không tìm thấy danh sách người chơi.';
                    document.getElementById('spin-button').disabled = true;
                    return;
                }
                const jsonData = decodeURIComponent(encodedData);
                participants = JSON.parse(jsonData);
                if (!Array.isArray(participants) || participants.length === 0) {
                     document.getElementById('title').textContent = 'Lỗi: Danh sách không hợp lệ.';
                     document.getElementById('spin-button').disabled = true;
                     return;
                }
                initWheel();
            } catch (error) {
                document.getElementById('title').textContent = 'Lỗi: Dữ liệu không đúng định dạng JSON.';
                document.getElementById('spin-button').disabled = true;
                console.error("Lỗi xử lý dữ liệu:", error);
            }
        };

        // Hàm vẽ vòng quay với các ô bằng nhau
        function initWheel() {
            const numSegments = participants.length;
            const segmentSize = 360 / numSegments;
            const segments = participants.map((p, index) => {
                return {
                    'fillStyle': (index % 2 === 0) ? '#e67e22' : '#f1c40f',
                    'text': p.ten,
                    'size': segmentSize
                };
            });

            theWheel = new Winwheel({
                'numSegments': numSegments,
                'outerRadius': 240,
                'innerRadius': 40,
                'textFontSize': 16,
                'textOrientation': 'horizontal',
                'textAlignment': 'outer',
                'textMargin': 5,
                'segments': segments,
                'animation': {
                    'type': 'spinToStop',
                    'duration': 8, // Thời gian quay
                    'spins': 10, // Số vòng quay
                    'callbackFinished': alertPrize,
                    'callbackAfter': drawTriangle
                }
            });
            drawTriangle();
        }

        // Hàm chọn người thắng dựa vào tỷ lệ
        function calculateWeightedWinner() {
            const totalWeight = participants.reduce((sum, p) => sum + (p.ty_le || 0), 0);
            let random = Math.random() * totalWeight;

            for (let i = 0; i < participants.length; i++) {
                random -= participants[i].ty_le || 0;
                if (random <= 0) {
                    return i; // trả về vị trí (index) của người thắng
                }
            }
            return 0; // Trả về người đầu tiên nếu có lỗi
        }

        // Bắt đầu quay
        function startSpin() {
            if (wheelSpinning === false) {
                document.getElementById('spin-button').disabled = true;
                
                // 1. Tính toán người thắng trước khi quay
                const winnerIndex = calculateWeightedWinner();
                const segmentSize = 360 / participants.length;
                const startAngle = winnerIndex * segmentSize;
                const endAngle = startAngle + segmentSize;

                // 2. Chọn một góc dừng ngẫu nhiên bên trong ô của người thắng
                const stopAt = Math.floor(Math.random() * (endAngle - startAngle - 2)) + startAngle + 1;
                
                // 3. Đặt góc dừng và bắt đầu hiệu ứng quay
                theWheel.animation.stopAngle = stopAt;
                theWheel.startAnimation();
                wheelSpinning = true;
            }
        }
        
        // Hiện thông báo khi quay xong
        function alertPrize(indicatedSegment) {
            alert("Chúc mừng '" + indicatedSegment.text + "' đã hốt hụi!");
            wheelSpinning = false;
            document.getElementById('spin-button').disabled = false;
            theWheel.rotationAngle = theWheel.animation.stopAngle % 360;
            theWheel.draw();
            drawTriangle();
        }

        // Vẽ lại kim chỉ (không cần thiết với div#pointer nhưng để cho chắc)
        function drawTriangle() {
            // Đã thay thế bằng div#pointer nên hàm này có thể để trống
        }
    </script>
</body>
</html>
