<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vòng Quay Chọn Người Hốt Hụi</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f7f6; padding: 20px; }
        #wheel-container { margin: 20px auto; position: relative; }
        #wheel { border: 2px solid #000; }
        #arrow { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 40px; color: red; }
        #spin-button { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #spin-button:disabled { background-color: #ccc; cursor: not-allowed; }
        #result { margin-top: 20px; font-size: 20px; font-weight: bold; color: green; }
        #settings { margin-top: 20px; padding: 15px; background-color: #fff; border-radius: 5px; max-width: 600px; margin-left: auto; margin-right: auto; display: none; }
        #settings.show { display: block; }
        #toggle-settings { padding: 10px 20px; font-size: 16px; background-color: #ffc107; color: black; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
        .setting-row { margin: 10px 0; }
        .weight-input { width: 60px; text-align: center; }
        #save-settings { padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Vòng Quay Chọn Người Hốt Hụi</h1>
    <div id="wheel-container">
        <canvas id="wheel" width="400" height="400"></canvas>
        <div id="arrow">▼</div>
    </div>
    <button id="spin-button">Quay</button>
    <div id="result"></div>

    <button id="toggle-settings">Cài đặt tỷ lệ</button>
    <div id="settings">
        <h3>Cài đặt tỷ lệ trúng</h3>
        <div id="settings-content"></div>
        <button id="save-settings">Lưu cài đặt</button>
    </div>

    <script>
        let participants = []; // Danh sách người tham gia: [{name: 'A', weight: 1}, ...]
        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spin-button');
        const resultDiv = document.getElementById('result');
        const toggleSettings = document.getElementById('toggle-settings');
        const settings = document.getElementById('settings');
        const settingsContent = document.getElementById('settings-content');
        const saveSettings = document.getElementById('save-settings');
        const wheelSize = 400;
        const center = wheelSize / 2;
        let currentAngle = 0;
        let spinning = false;

        // Màu sắc ngẫu nhiên cho các phần
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Vẽ vòng quay với các phần bằng nhau
        function drawWheel() {
            if (participants.length === 0) return;
            ctx.clearRect(0, 0, wheelSize, wheelSize);
            const sliceAngle = 2 * Math.PI / participants.length; // Các phần bằng nhau
            let startAngle = currentAngle;
            participants.forEach((p, index) => {
                ctx.beginPath();
                ctx.arc(center, center, center, startAngle, startAngle + sliceAngle);
                ctx.lineTo(center, center);
                ctx.fillStyle = p.color || (p.color = getRandomColor());
                ctx.fill();
                ctx.stroke();

                // Vẽ chữ
                ctx.save();
                ctx.translate(center, center);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = 'right';
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(p.name, center - 10, 10);
                ctx.restore();

                startAngle += sliceAngle;
            });
        }

        // Chọn ngẫu nhiên với trọng số
        function weightedRandom() {
            const totalWeight = participants.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            for (let i = 0; i < participants.length; i++) {
                random -= participants[i].weight;
                if (random < 0) return i;
            }
            return participants.length - 1;
        }

        // Animation quay
        function spinWheel() {
            if (spinning) return;
            if (participants.length < 2) {
                resultDiv.textContent = 'Cần ít nhất 2 người tham gia để quay.';
                return;
            }
            spinning = true;
            spinButton.disabled = true;
            resultDiv.textContent = '';
            const winnerIndex = weightedRandom();
            const sliceAngle = 360 / participants.length;
            const targetAngle = (360 - (winnerIndex * sliceAngle + sliceAngle / 2)) + 360 * 5;

            let startTime = null;
            const duration = 5000;

            function animate(time) {
                if (!startTime) startTime = time;
                const progress = (time - startTime) / duration;
                const easeOut = 1 - Math.pow(1 - progress, 3);
                currentAngle = (targetAngle * easeOut) % 360;
                drawWheel();
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    spinning = false;
                    spinButton.disabled = false;
                    resultDiv.textContent = `Người trúng: ${participants[winnerIndex].name}`;
                    const finalAngle = currentAngle % 360;
                    const normalizedAngle = (finalAngle < 0 ? finalAngle + 360 : finalAngle);
                    const sliceIndex = Math.floor((normalizedAngle / 360) * participants.length);
                    const adjustedIndex = (participants.length - sliceIndex) % participants.length;
                    if (adjustedIndex !== winnerIndex) {
                        console.warn(`Mũi tên chỉ vào ${participants[adjustedIndex].name}, nhưng người trúng là ${participants[winnerIndex].name}. Điều chỉnh góc...`);
                        currentAngle = (currentAngle + (winnerIndex - adjustedIndex) * sliceAngle) % 360;
                        drawWheel();
                    }
                }
            }
            requestAnimationFrame(animate);
        }

        // Hiển thị và chỉnh sửa tỷ lệ
        function showSettings() {
            settingsContent.innerHTML = '';
            participants.forEach((p, index) => {
                const row = document.createElement('div');
                row.className = 'setting-row';
                row.innerHTML = `<span>${p.name}: </span><input type="number" class="weight-input" data-index="${index}" value="${p.weight}" min="0.1" step="0.1">`;
                settingsContent.appendChild(row);
            });
            settings.classList.add('show');
        }

        // Lưu tỷ lệ mới
        function saveSettings() {
            const inputs = document.querySelectorAll('.weight-input');
            inputs.forEach(input => {
                const index = input.dataset.index;
                const newWeight = parseFloat(input.value);
                if (newWeight > 0) {
                    participants[index].weight = newWeight;
                }
            });
            settings.classList.remove('show');
            // Không vẽ lại để giữ giao diện không thay đổi
        }

        // Load dữ liệu từ URL
        window.onload = function() {
            try {
                const encodedData = window.location.hash.substring(1);
                if (encodedData) {
                    const jsonData = decodeURIComponent(encodedData);
                    participants = JSON.parse(jsonData);
                    if (!Array.isArray(participants) || participants.length === 0) {
                        throw new Error('Dữ liệu không hợp lệ');
                    }
                    participants = participants.map(p => ({
                        name: p.name || 'Unknown',
                        weight: parseFloat(p.weight) > 0 ? parseFloat(p.weight) : 1
                    }));
                    drawWheel();
                } else {
                    participants = [
                        {name: 'Nguyễn A', weight: 1},
                        {name: 'Trần B', weight: 2},
                        {name: 'Lê C', weight: 1.5}
                    ];
                    drawWheel();
                }
            } catch (error) {
                resultDiv.textContent = 'Lỗi tải dữ liệu: ' + error.message;
            }
            spinButton.addEventListener('click', spinWheel);
            toggleSettings.addEventListener('click', showSettings);
            saveSettings.addEventListener('click', saveSettings);
        };
    </script>
</body>
</html>
